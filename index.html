<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ILS Expense and Income Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --dark-color: #34495e;
            --light-color: #ecf0f1;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-color);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }
        
        h1, h2, h3, h4 {
            color: var(--dark-color);
            margin-bottom: 15px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .time-filter {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .time-filter select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: white;
            font-size: 0.9rem;
            width: auto;
        }
        
        .balance {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background-color: var(--light-color);
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .card.income {
            border-left: 5px solid var(--secondary-color);
        }
        
        .card.expense {
            border-left: 5px solid var(--danger-color);
        }
        
        .card.balance-total {
            border-left: 5px solid var(--primary-color);
        }
        
        .charts-container {
            margin-bottom: 30px;
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        @media (min-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .transactions-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        
        @media (min-width: 768px) {
            .transactions-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .transaction-list {
            list-style: none;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background-color: var(--light-color);
            border-radius: 5px;
            position: relative;
        }
        
        .transaction-item.income {
            border-right: 5px solid var(--secondary-color);
        }
        
        .transaction-item.expense {
            border-right: 5px solid var(--danger-color);
        }
        
        .transaction-item .labels {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 4px;
        }
        
        .recurring-label, .category-label, .sync-label {
            color: white;
            font-size: 0.7rem;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .recurring-label {
            background-color: var(--primary-color);
        }
        
        .transaction-date {
            font-size: 0.8rem;
            color: #666;
        }
        
        .delete-btn {
            cursor: pointer;
            background-color: var(--danger-color);
            color: white;
            border: 0;
            font-size: 1rem;
            padding: 2px 5px;
            border-radius: 3px;
            margin-left: 10px;
        }
        
        form {
            display: grid;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
        }
        
        input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: 0;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .text-right {
            text-align: right;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 30px;
        }
        
        @media (min-width: 768px) {
            .action-buttons {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .danger-btn {
            background-color: var(--danger-color);
        }
        
        .danger-btn:hover {
            background-color: #c0392b;
        }
        
        .error {
            color: var(--danger-color);
            margin-bottom: 10px;
        }
        
        .footer {
            margin-top: 30px;
            text-align: center;
            color: #888;
            font-size: 0.9rem;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--dark-color);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: transform 0.3s, opacity 0.3s;
            transform: translateY(100px);
            opacity: 0;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            background-color: var(--secondary-color);
        }
        
        .toast.error {
            background-color: var(--danger-color);
        }
        
        .sync-section {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 5px;
            background-color: #f8f9fa;
            border-left: 5px solid var(--primary-color);
        }
        
        .sync-code {
            font-family: monospace;
            font-size: 1.2rem;
            background-color: #eee;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            margin: 10px 0;
            word-break: break-all;
        }
        
        .id-form {
            display: flex;
            gap: 10px;
        }
        
        .id-form input {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ILS Expense and Income Tracker</h1>
        </div>
        
        <div id="sync-section" class="sync-section">
            <h3>Share Data Between Devices</h3>
            <div id="export-area">
                <p>Click to generate a code you can use on other devices:</p>
                <button id="generate-code-btn" class="btn-block">Generate Sync Code</button>
                <div id="sync-code-display" style="display: none;">
                    <p>Copy this code to transfer data to another device:</p>
                    <div id="sync-code" class="sync-code"></div>
                    <button id="copy-code-btn">Copy Code</button>
                </div>
            </div>
            <div id="import-area" style="margin-top: 20px;">
                <p>Paste a sync code from another device:</p>
                <div class="id-form">
                    <input type="text" id="sync-code-input" placeholder="Paste sync code here">
                    <button id="import-code-btn">Import</button>
                </div>
            </div>
        </div>
        
        <div class="time-filter">
            <label for="time-period">Time Period:</label>
            <select id="time-period">
                <option value="currentMonth">Current Month</option>
                <option value="last3Months">Last 3 Months</option>
                <option value="last6Months">Last 6 Months</option>
                <option value="currentYear">Current Year</option>
                <option value="allTime">All Time</option>
            </select>
        </div>
        
        <div class="balance">
            <div class="card balance-total">
                <h3>Total Balance</h3>
                <h2 id="balance">₪0.00</h2>
            </div>
            <div class="card income">
                <h3>Income</h3>
                <h2 id="income">₪0.00</h2>
            </div>
            <div class="card expense">
                <h3>Expenses</h3>
                <h2 id="expense">₪0.00</h2>
            </div>
        </div>
        
        <h3>Add New Transaction</h3>
        <div id="error-message" class="error"></div>
        <form id="transaction-form">
            <div>
                <label for="description">Description</label>
                <input type="text" id="description" placeholder="Enter description..." required>
            </div>
            <div>
                <label for="amount">Amount (ILS)</label>
                <input type="number" id="amount" placeholder="Enter amount..." required step="0.01">
            </div>
            <div>
                <label for="date">Date</label>
                <input type="date" id="date" required>
            </div>
            <div>
                <label for="type">Type</label>
                <select id="type" required>
                    <option value="income">Income</option>
                    <option value="expense">Expense</option>
                </select>
            </div>
            <div>
                <label for="category">Category</label>
                <select id="category" required>
                    <option value="">-- Select Category --</option>
                    <optgroup label="Income Categories">
                        <option value="salary">Salary</option>
                        <option value="business">Business</option>
                        <option value="investment">Investment</option>
                        <option value="gifts">Gifts</option>
                        <option value="other-income">Other Income</option>
                    </optgroup>
                    <optgroup label="Expense Categories">
                        <option value="housing">Housing/Rent</option>
                        <option value="utilities">Utilities</option>
                        <option value="food">Food/Groceries</option>
                        <option value="transportation">Transportation</option>
                        <option value="healthcare">Healthcare</option>
                        <option value="insurance">Insurance</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="education">Education</option>
                        <option value="shopping">Shopping</option>
                        <option value="personal">Personal Care</option>
                        <option value="debt">Debt Payment</option>
                        <option value="savings">Savings</option>
                        <option value="other-expense">Other Expense</option>
                    </optgroup>
                </select>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="recurring">
                <label for="recurring">Recurring Transaction</label>
            </div>
            <div id="recurring-details" style="display: none;">
                <div>
                    <label for="frequency">Frequency</label>
                    <select id="frequency">
                        <option value="monthly">Monthly</option>
                        <option value="weekly">Weekly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
                <div>
                    <label for="end-date">End Date (optional)</label>
                    <input type="date" id="end-date">
                </div>
            </div>
            <button type="submit" class="btn-block">Add Transaction</button>
        </form>
        
        <div class="charts-container">
            <h3>Financial Overview</h3>
            <div class="chart-grid">
                <div class="card">
                    <h4>Expenses by Category</h4>
                    <canvas id="expense-chart" width="400" height="300"></canvas>
                </div>
                <div class="card">
                    <h4>Income vs Expenses</h4>
                    <canvas id="balance-chart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
        
        <div class="transactions-container">
            <div>
                <h3>Recent Transactions</h3>
                <ul id="transaction-list" class="transaction-list"></ul>
            </div>
            <div>
                <h3>Upcoming Recurring Transactions</h3>
                <ul id="recurring-list" class="transaction-list"></ul>
            </div>
        </div>
        
        <div class="action-buttons">
            <button id="export-btn">Export Data</button>
            <button id="import-btn">Import Data</button>
            <button id="clear-data-btn" class="danger-btn">Clear All Data</button>
        </div>
        
        <input type="file" id="import-file" style="display: none;">
        
        <div class="footer">
            <p>Data is stored locally in your browser's storage</p>
            <p style="margin-top: 10px; font-size: 0.8rem;">Last updated: March 2025</p>
        </div>
    </div>
    
    <div id="toast" class="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date to today
            document.getElementById('date').valueAsDate = new Date();
            
            // Elements
            const balanceEl = document.getElementById('balance');
            const incomeEl = document.getElementById('income');
            const expenseEl = document.getElementById('expense');
            const transactionList = document.getElementById('transaction-list');
            const recurringList = document.getElementById('recurring-list');
            const form = document.getElementById('transaction-form');
            const descriptionInput = document.getElementById('description');
            const amountInput = document.getElementById('amount');
            const dateInput = document.getElementById('date');
            const typeInput = document.getElementById('type');
            const categoryInput = document.getElementById('category');
            const recurringCheckbox = document.getElementById('recurring');
            const recurringDetails = document.getElementById('recurring-details');
            const frequencyInput = document.getElementById('frequency');
            const endDateInput = document.getElementById('end-date');
            const errorMessage = document.getElementById('error-message');
            const exportBtn = document.getElementById('export-btn');
            const importBtn = document.getElementById('import-btn');
            const importFile = document.getElementById('import-file');
            const clearDataBtn = document.getElementById('clear-data-btn');
            const expenseChart = document.getElementById('expense-chart');
            const balanceChart = document.getElementById('balance-chart');
            const timePeriodSelect = document.getElementById('time-period');
            const generateCodeBtn = document.getElementById('generate-code-btn');
            const syncCodeDisplay = document.getElementById('sync-code-display');
            const syncCode = document.getElementById('sync-code');
            const copyCodeBtn = document.getElementById('copy-code-btn');
            const syncCodeInput = document.getElementById('sync-code-input');
            const importCodeBtn = document.getElementById('import-code-btn');
            const toast = document.getElementById('toast');
            
            // Global variables
            let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            let expenseChartInstance = null;
            let balanceChartInstance = null;
            
            // Show/hide recurring details
            recurringCheckbox.addEventListener('change', function() {
                recurringDetails.style.display = this.checked ? 'block' : 'none';
            });
            
            // Initialize
            function init() {
                transactionList.innerHTML = '';
                recurringList.innerHTML = '';
                
                // Process recurring transactions
                processRecurringTransactions();
                
                // Update balance
                updateBalance();
                
                // Show transactions
                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const regularTransactions = transactions.filter(transaction => !transaction.isRecurring);
                const recurringTransactions = transactions.filter(transaction => transaction.isRecurring);
                
                // Show regular transactions (most recent first, limit to 20)
                regularTransactions.slice(0, 20).forEach(addTransactionDOM);
                
                // Show upcoming recurring transactions
                const nextRecurringOccurrences = getUpcomingRecurringOccurrences(recurringTransactions);
                nextRecurringOccurrences.forEach(addRecurringTransactionDOM);
            }
            
            // Get upcoming recurring occurrences
            function getUpcomingRecurringOccurrences(recurringTransactions) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const upcomingOccurrences = [];
                
                recurringTransactions.forEach(transaction => {
                    const transactionDate = new Date(transaction.date);
                    const endDate = transaction.endDate ? new Date(transaction.endDate) : null;
                    
                    // Calculate next occurrence
                    let nextDate = new Date(transactionDate);
                    
                    // Find the next occurrence after today
                    while (nextDate < today) {
                        if (transaction.frequency === 'monthly') {
                            nextDate.setMonth(nextDate.getMonth() + 1);
                        } else if (transaction.frequency === 'weekly') {
                            nextDate.setDate(nextDate.getDate() + 7);
                        } else if (transaction.frequency === 'yearly') {
                            nextDate.setFullYear(nextDate.getFullYear() + 1);
                        }
                    }
                    
                    // Check if we're past the end date
                    if (endDate && nextDate > endDate) {
                        return;
                    }
                    
                    // Add to upcoming occurrences
                    upcomingOccurrences.push({
                        ...transaction,
                        nextDate: nextDate.toISOString().split('T')[0]
                    });
                });
                
                // Sort by upcoming date
                upcomingOccurrences.sort((a, b) => new Date(a.nextDate) - new Date(b.nextDate));
                
                return upcomingOccurrences.slice(0, 20); // Limit to 20
            }
            
            // Process recurring transactions (add instances that should have occurred)
            function processRecurringTransactions() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const recurringTransactions = transactions.filter(t => t.isRecurring);
                const regularTransactions = transactions.filter(t => !t.isRecurring);
                
                // Track instances we've already created
                const existingInstances = regularTransactions.filter(t => t.recurringParentId);
                
                // Process each recurring transaction
                recurringTransactions.forEach(recurring => {
                    const startDate = new Date(recurring.date);
                    const endDate = recurring.endDate ? new Date(recurring.endDate) : null;
                    
                    if (endDate && endDate < today) {
                        return; // Past end date, skip
                    }
                    
                    // Find dates that should have instances
                    let currentDate = new Date(startDate);
                    
                    while (currentDate <= today) {
                        const instanceDate = currentDate.toISOString().split('T')[0];
                        
                        // Check if this instance already exists
                        const instanceExists = existingInstances.some(
                            t => t.recurringParentId === recurring.id && t.date === instanceDate
                        );
                        
                        if (!instanceExists) {
                            // Create a new regular transaction for this instance
                            const newInstance = {
                                id: generateID(),
                                description: recurring.description,
                                amount: recurring.amount,
                                type: recurring.type,
                                category: recurring.category,
                                date: instanceDate,
                                isRecurring: false,
                                recurringParentId: recurring.id
                            };
                            
                            transactions.push(newInstance);
                        }
                        
                        // Move to next occurrence date
                        if (recurring.frequency === 'monthly') {
                            currentDate.setMonth(currentDate.getMonth() + 1);
                        } else if (recurring.frequency === 'weekly') {
                            currentDate.setDate(currentDate.getDate() + 7);
                        } else if (recurring.frequency === 'yearly') {
                            currentDate.setFullYear(currentDate.getFullYear() + 1);
                        }
                    }
                });
                
                // Save updated transactions
                localStorage.setItem('transactions', JSON.stringify(transactions));
            }
            
            // Get transactions for the selected time period
            function getFilteredTransactions() {
                const timePeriod = timePeriodSelect.value;
                const today = new Date();
                let startDate = new Date();
                
                switch(timePeriod) {
                    case 'currentMonth':
                        startDate.setDate(1); // First day of current month
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'last3Months':
                        startDate.setMonth(startDate.getMonth() - 3);
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'last6Months':
                        startDate.setMonth(startDate.getMonth() - 6);
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'currentYear':
                        startDate = new Date(today.getFullYear(), 0, 1); // January 1st of current year
                        break;
                    case 'allTime':
                        return transactions.filter(transaction => !transaction.isRecurring);
                    default:
                        startDate.setDate(1); // Default to current month
                        startDate.setHours(0, 0, 0, 0);
                }
                
                return transactions.filter(transaction => {
                    if (transaction.isRecurring) return false; // Skip recurring templates
                    
                    const transDate = new Date(transaction.date);
                    return transDate >= startDate && transDate <= today;
                });
            }
            
            // Update balance
            function updateBalance() {
                const filteredTransactions = getFilteredTransactions();
                
                const amounts = filteredTransactions.map(transaction => 
                    transaction.type === 'income' ? transaction.amount : -transaction.amount
                );
                
                const total = amounts.length > 0 ? amounts.reduce((acc, amount) => acc + amount, 0) : 0;
                
                const income = amounts
                    .filter(amount => amount > 0)
                    .reduce((acc, amount) => acc + amount, 0);
                
                const expense = amounts
                    .filter(amount => amount < 0)
                    .reduce((acc, amount) => acc + amount, 0) * -1;
                
                balanceEl.textContent = formatCurrency(total);
                incomeEl.textContent = formatCurrency(income);
                expenseEl.textContent = formatCurrency(expense);
                
                // Update charts when balance is updated
                updateCharts();
            }
            
            // Update charts
            function updateCharts() {
                // Get data for the charts based on selected time period
                const filteredTransactions = getFilteredTransactions();
                
                // Expense by category data
                const expenseCategories = {};
                filteredTransactions.forEach(t => {
                    if (t.type === 'expense' && t.category) {
                        if (!expenseCategories[t.category]) {
                            expenseCategories[t.category] = 0;
                        }
                        expenseCategories[t.category] += t.amount;
                    }
                });
                
                // Monthly balance data (last 6 months or based on filter)
                const monthlyData = [];
                const today = new Date();
                let numMonths = 6; // Default to 6 months
                
                // For specific time periods, adjust the number of months
                if (timePeriodSelect.value === 'currentMonth') {
                    numMonths = 1;
                } else if (timePeriodSelect.value === 'last3Months') {
                    numMonths = 3;
                } else if (timePeriodSelect.value === 'currentYear') {
                    numMonths = 12;
                }
                
                for (let i = numMonths - 1; i >= 0; i--) {
                    const monthDate = new Date();
                    monthDate.setMonth(monthDate.getMonth() - i);
                    
                    const year = monthDate.getFullYear();
                    const month = monthDate.getMonth();
                    
                    const monthlyTransactions = transactions.filter(t => {
                        if (t.isRecurring) return false;
                        const transDate = new Date(t.date);
                        return transDate.getMonth() === month && transDate.getFullYear() === year;
                    });
                    
                    const income = monthlyTransactions
                        .filter(t => t.type === 'income')
                        .reduce((sum, t) => sum + t.amount, 0);
                    
                    const expense = monthlyTransactions
                        .filter(t => t.type === 'expense')
                        .reduce((sum, t) => sum + t.amount, 0);
                    
                    const monthName = monthDate.toLocaleString('default', { month: 'short' });
                    
                    monthlyData.push({
                        month: `${monthName} ${year}`,
                        income,
                        expense
                    });
                }
                
                // Update/Create Expense Chart
                if (expenseChartInstance) {
                    expenseChartInstance.destroy();
                }
                
                expenseChartInstance = new Chart(expenseChart, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(expenseCategories),
                        datasets: [{
                            data: Object.values(expenseCategories),
                            backgroundColor: Object.keys(expenseCategories).map(cat => getCategoryColor(cat)),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right',
                            },
                            title: {
                                display: true,
                                text: `Expenses by Category (${getTimePeriodLabel()})`
                            }
                        }
                    }
                });
                
                // Update/Create Balance Chart
                if (balanceChartInstance) {
                    balanceChartInstance.destroy();
                }
                
                balanceChartInstance = new Chart(balanceChart, {
                    type: 'bar',
                    data: {
                        labels: monthlyData.map(d => d.month),
                        datasets: [
                            {
                                label: 'Income',
                                data: monthlyData.map(d => d.income),
                                backgroundColor: 'rgba(46, 204, 113, 0.7)',
                                borderColor: 'rgba(46, 204, 113, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Expenses',
                                data: monthlyData.map(d => d.expense),
                                backgroundColor: 'rgba(231, 76, 60, 0.7)',
                                borderColor: 'rgba(231, 76, 60, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '₪' + value;
                                    }
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `Income vs Expenses (${getTimePeriodLabel()})`
                            }
                        }
                    }
                });
            }
            
            // Add transaction to DOM
            function addTransactionDOM(transaction) {
                const item = document.createElement('li');
                item.classList.add('transaction-item');
                item.classList.add(transaction.type);
                
                const sign = transaction.type === 'income' ? '+' : '-';
                
                item.innerHTML = `
                    <div>
                        <span>${transaction.description}</span>
                        <div class="transaction-date">${formatDate(transaction.date)}</div>
                        <div class="labels">
                            ${transaction.recurringParentId ? '<span class="recurring-label">Recurring</span>' : ''}
                            ${transaction.category ? `<span class="category-label" style="background-color: ${getCategoryColor(transaction.category)};">${transaction.category}</span>` : ''}
                        </div>
                    </div>
                    <div>
                        <span>${sign}${formatCurrency(transaction.amount)}</span>
                        <button class="delete-btn" data-id="${transaction.id}">×</button>
                    </div>
                `;
                
                transactionList.appendChild(item);
            }
            
            // Add recurring transaction to DOM
            function addRecurringTransactionDOM(transaction) {
                const item = document.createElement('li');
                item.classList.add('transaction-item');
                item.classList.add(transaction.type);
                
                const sign = transaction.type === 'income' ? '+' : '-';
                
                item.innerHTML = `
                    <div>
                        <span>${transaction.description}</span>
                        <div class="transaction-date">${formatDate(transaction.nextDate)}</div>
                        <div class="labels">
                            <span class="recurring-label">${transaction.frequency}</span>
                            ${transaction.category ? `<span class="category-label" style="background-color: ${getCategoryColor(transaction.category)};">${transaction.category}</span>` : ''}
                        </div>
                    </div>
                    <div>
                        <span>${sign}${formatCurrency(transaction.amount)}</span>
                        <button class="delete-btn" data-id="${transaction.id}">×</button>
                    </div>
                `;
                
                recurringList.appendChild(item);
            }
            
            // Format date
            function formatDate(dateString) {
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return new Date(dateString).toLocaleDateString(undefined, options);
            }
            
            // Format currency
            function formatCurrency(amount) {
                return '₪' + amount.toFixed(2);
            }
            
            // Get time period label for chart titles
            function getTimePeriodLabel() {
                const timePeriod = timePeriodSelect.value;
                switch(timePeriod) {
                    case 'currentMonth':
                        return new Date().toLocaleString('default', { month: 'long', year: 'numeric' });
                    case 'last3Months':
                        return 'Last 3 Months';
                    case 'last6Months':
                        return 'Last 6 Months';
                    case 'currentYear':
                        return new Date().getFullYear().toString();
                    case 'allTime':
                        return 'All Time';
                    default:
                        return new Date().toLocaleString('default', { month: 'long' });
                }
            }
            
            // Get color for category
            function getCategoryColor(category) {
                const colorMap = {
                    // Income colors
                    'salary': '#2ecc71',
                    'business': '#27ae60',
                    'investment': '#16a085',
                    'gifts': '#1abc9c',
                    'other-income': '#3498db',
                    
                    // Expense colors
                    'housing': '#e74c3c',
                    'utilities': '#c0392b',
                    'food': '#e67e22',
                    'transportation': '#d35400',
                    'healthcare': '#f39c12',
                    'insurance': '#f1c40f',
                    'entertainment': '#9b59b6',
                    'education': '#8e44ad',
                    'shopping': '#2c3e50',
                    'personal': '#7f8c8d',
                    'debt': '#95a5a6',
                    'savings': '#34495e',
                    'other-expense': '#bdc3c7'
                };
                
                return colorMap[category] || '#7f8c8d';
            }
            
            // Generate ID
            function generateID() {
                return Math.floor(Math.random() * 1000000000);
            }
            
            // Add transaction
            function addTransaction(e) {
                e.preventDefault();
                
                // Validate form
                if (descriptionInput.value.trim() === '' || amountInput.value.trim() === '' || categoryInput.value.trim() === '') {
                    errorMessage.textContent = 'Please add a description, amount, and category';
                    return;
                }
                
                errorMessage.textContent = '';
                
                const transaction = {
                    id: generateID(),
                    description: descriptionInput.value,
                    amount: +amountInput.value,
                    type: typeInput.value,
                    category: categoryInput.value,
                    date: dateInput.value,
                    isRecurring: recurringCheckbox.checked
                };
                
                if (transaction.isRecurring) {
                    transaction.frequency = frequencyInput.value;
                    if (endDateInput.value) {
                        transaction.endDate = endDateInput.value;
                    }
                }
                
                transactions.push(transaction);
                
                // Save and update UI
                localStorage.setItem('transactions', JSON.stringify(transactions));
                init();
                
                // Reset form
                descriptionInput.value = '';
                amountInput.value = '';
                dateInput.valueAsDate = new Date();
                typeInput.value = 'income';
                categoryInput.value = '';
                recurringCheckbox.checked = false;
                recurringDetails.style.display = 'none';
                endDateInput.value = '';
                
                showToast('Transaction added successfully', 'success');
            }
            
            // Remove transaction
            function removeTransaction(id) {
                const transaction = transactions.find(t => t.id === id);
                
                if (transaction) {
                    if (transaction.isRecurring) {
                        // Also remove all instances of this recurring transaction
                        transactions = transactions.filter(t => 
                            t.id !== id && t.recurringParentId !== id
                        );
                    } else {
                        transactions = transactions.filter(t => t.id !== id);
                    }
                    
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    init();
                    
                    showToast('Transaction deleted successfully', 'success');
                }
            }
            
            // Generate sync code
            function generateSyncCode() {
                // Create a compressed version of the data
                const data = {
                    transactions: transactions,
                    timestamp: Date.now()
                };
                
                // Convert to string and encode
                const jsonString = JSON.stringify(data);
                const encodedData = btoa(jsonString);
                
                // Display the sync code
                syncCode.textContent = encodedData;
                syncCodeDisplay.style.display = 'block';
                
                showToast('Sync code generated successfully', 'success');
            }
            
            // Import from sync code
            function importFromSyncCode() {
                const code = syncCodeInput.value.trim();
                
                if (!code) {
                    showToast('Please enter a sync code', 'error');
                    return;
                }
                
                try {
                    // Decode the data
                    const jsonString = atob(code);
                    const data = JSON.parse(jsonString);
                    
                    if (!data.transactions || !Array.isArray(data.transactions)) {
                        showToast('Invalid sync code format', 'error');
                        return;
                    }
                    
                    // Confirm import
                    if (!confirm(`Import ${data.transactions.length} transactions? This will merge with your existing data.`)) {
                        return;
                    }
                    
                    // Merge transactions (avoid duplicates by ID)
                    const existingIds = transactions.map(t => t.id);
                    const newTransactions = data.transactions.filter(t => !existingIds.includes(t.id));
                    
                    transactions = [...transactions, ...newTransactions];
                    
                    // Save to localStorage
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    
                    // Update UI
                    init();
                    
                    // Clear input
                    syncCodeInput.value = '';
                    
                    showToast(`Imported ${newTransactions.length} new transactions successfully`, 'success');
                } catch (error) {
                    console.error('Import error:', error);
                    showToast('Invalid sync code. Please check and try again.', 'error');
                }
            }
            
            // Export data
            function exportData() {
                const dataStr = JSON.stringify(transactions);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = 'expense-tracker-data.json';
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showToast('Data exported successfully', 'success');
            }
            
            // Import data from file
            function importData(e) {
                const file = e.target.files[0];
                
                if (file) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            
                            // Check if it's a valid data array
                            if (!Array.isArray(importedData)) {
                                showToast('Invalid file format', 'error');
                                return;
                            }
                            
                            // Confirm import
                            if (!confirm(`Import ${importedData.length} transactions? This will replace your existing data.`)) {
                                return;
                            }
                            
                            // Replace data
                            transactions = importedData;
                            localStorage.setItem('transactions', JSON.stringify(transactions));
                            
                            // Update UI
                            init();
                            
                            showToast('Data imported successfully', 'success');
                        } catch (error) {
                            console.error('Error importing data:', error);
                            showToast('Invalid file format', 'error');
                        }
                    };
                    
                    reader.readAsText(file);
                }
            }
            
            // Clear all data
            function clearData() {
                if (confirm('Are you sure you want to delete all transactions? This cannot be undone.')) {
                    transactions = [];
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    
                    // Reset charts
                    if (expenseChartInstance) {
                        expenseChartInstance.destroy();
                        expenseChartInstance = null;
                    }
                    
                    if (balanceChartInstance) {
                        balanceChartInstance.destroy();
                        balanceChartInstance = null;
                    }
                    
                    init();
                    
                    showToast('All data cleared successfully', 'success');
                }
            }
            
            // Copy sync code to clipboard
            function copyToClipboard() {
                const textToCopy = syncCode.textContent;
                
                // Use the Clipboard API if available
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        showToast('Code copied to clipboard', 'success');
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        promptToCopy(textToCopy);
                    });
                } else {
                    // Fallback for older browsers
                    promptToCopy(textToCopy);
                }
            }
            
            // Fallback copy method
            function promptToCopy(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                
                // Make the textarea out of viewport
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                
                textArea.focus();
                textArea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showToast('Code copied to clipboard', 'success');
                    } else {
                        showToast('Failed to copy code. Please select and copy manually.', 'error');
                    }
                } catch (err) {
                    console.error('Failed to copy:', err);
                    showToast('Failed to copy code. Please select and copy manually.', 'error');
                }
                
                document.body.removeChild(textArea);
            }
            
            // Show toast message
            function showToast(message, type = 'success') {
                toast.textContent = message;
                toast.className = 'toast';
                
                if (type) {
                    toast.classList.add(type);
                }
                
                // Show the toast
                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);
                
                // Hide after 3 seconds
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
            
            // Event listeners
            form.addEventListener('submit', addTransaction);
            
            transactionList.addEventListener('click', e => {
                if (e.target.classList.contains('delete-btn')) {
                    removeTransaction(+e.target.dataset.id);
                }
            });
            
            recurringList.addEventListener('click', e => {
                if (e.target.classList.contains('delete-btn')) {
                    removeTransaction(+e.target.dataset.id);
                }
            });
            
            timePeriodSelect.addEventListener('change', updateBalance);
            
            exportBtn.addEventListener('click', exportData);
            
            importBtn.addEventListener('click', () => {
                importFile.click();
            });
            
            importFile.addEventListener('change', importData);
            
            clearDataBtn.addEventListener('click', clearData);
            
            generateCodeBtn.addEventListener('click', generateSyncCode);
            
            copyCodeBtn.addEventListener('click', copyToClipboard);
            
            importCodeBtn.addEventListener('click', importFromSyncCode);
            
            // Initialize app
            init();
        });
    </script>
</body>
</html>