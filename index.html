<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>כלי מעקב הוצאות והכנסות</title>
    <!-- Firebase Scripts -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, updateDoc, deleteDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBo4--sl5AnDxlfNIThFyR3grEwf7nnI8M",
          authDomain: "yoha-c02a5.firebaseapp.com",
          projectId: "yoha-c02a5",
          storageBucket: "yoha-c02a5.firebasestorage.app",
          messagingSenderId: "993152300027",
          appId: "1:993152300027:web:dd926303f7616a2abb515e",
          measurementId: "G-FHWVEDSHSS"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // חשיפת Firebase לחלון הגלובלי כדי שנוכל להשתמש בו מחוץ למודול
        window.firebaseApp = {
            app,
            analytics,
            auth,
            db,
            // פונקציות אימות
            createUser: async (email, password) => {
                try {
                    return await createUserWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    throw error;
                }
            },
            signIn: async (email, password) => {
                try {
                    return await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    throw error;
                }
            },
            signOut: async () => {
                try {
                    return await signOut(auth);
                } catch (error) {
                    throw error;
                }
            },
            getCurrentUser: () => auth.currentUser,
            // פונקציות Firestore
            saveUserData: async (userId, dataType, data) => {
                try {
                    // וידוא שהמידע הוא במבנה תקין לפני שמירה
                    const validatedData = Array.isArray(data) || 
                                         (typeof data === 'object' && data !== null) ? 
                                         data : { value: data };
                    
                    await setDoc(doc(db, `users/${userId}/${dataType}/data`), { data: validatedData });
                    console.log(`Successfully saved ${dataType} data for user ${userId}`);
                    return true;
                } catch (error) {
                    console.error(`Error saving ${dataType}:`, error);
                    throw error;
                }
            },
            getUserData: async (userId, dataType) => {
                try {
                    const docRef = doc(db, `users/${userId}/${dataType}/data`);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        console.log(`Successfully retrieved ${dataType} data for user ${userId}`);
                        return docSnap.data().data;
                    } else {
                        console.log(`No ${dataType} data found for user ${userId}`);
                        return null;
                    }
                } catch (error) {
                    console.error(`Error getting ${dataType}:`, error);
                    throw error;
                }
            }
        };
        
        // האזנה לשינויים במצב ההתחברות
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // משתמש מחובר
                console.log("User is signed in:", user.uid);
                document.dispatchEvent(new CustomEvent('userSignedIn', { detail: user }));
            } else {
                // משתמש לא מחובר
                console.log("User is signed out");
                document.dispatchEvent(new Event('userSignedOut'));
            }
        });
    </script>
    <!-- ספריית Chart.js לגרפים -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.1.0"></script><style>
        @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary-color: #4CAF50;
            --primary-light: #7BC67E;
            --primary-dark: #388E3C;
            --secondary-color: #2196F3;
            --secondary-light: #64B5F6;
            --secondary-dark: #1976D2;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --credit-color: #9C27B0;
            --cash-color: #4CAF50;
            --text-color: #333333;
            --text-light: #666666;
            --bg-color: #F5F7FA;
            --card-bg: #FFFFFF;
            --border-color: #E0E0E0;
            --shadow-light: 0 2px 5px rgba(0,0,0,0.07);
            --shadow-medium: 0 5px 15px rgba(0,0,0,0.1);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --spacing-xs: 5px;
            --spacing-sm: 10px;
            --spacing-md: 15px;
            --spacing-lg: 20px;
            --spacing-xl: 30px;
        }
        
        body {
            font-family: 'Rubik', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-xl);
        }
        
        h1, h2, h3, h4 {
            color: var(--primary-dark);
            margin-top: 0;
            font-weight: 500;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: var(--spacing-xl);
            text-align: center;
            color: var(--primary-dark);
            position: relative;
            padding-bottom: var(--spacing-md);
        }
        
        h1:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px;
        }
        
        h2 {
            font-size: 22px;
            margin-bottom: var(--spacing-lg);
            position: relative;
            display: inline-block;
            padding-bottom: var(--spacing-xs);
        }
        
        h2:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 40px;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px;
        }
        
        h3 {
            font-size: 18px;
            margin-bottom: var(--spacing-md);
        }
        
        /* טאבים */
        .tabs {
            display: flex;
            margin-bottom: var(--spacing-xl);
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 2px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
            margin-left: 2px;
            transition: all 0.3s ease;
            font-weight: 400;
            color: var(--text-light);
        }
        
        .tab:hover {
            background-color: var(--primary-light);
            color: white;
        }
        
        .tab.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
            background-color: var(--card-bg);
            padding: var(--spacing-xl);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-light);
            margin-bottom: var(--spacing-xl);
            transition: all 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* טפסים */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }
        
        label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
            color: var(--text-color);
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            box-sizing: border-box;
            transition: all 0.3s ease;
            font-family: 'Rubik', sans-serif;
        }
        
        input:focus, select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
            outline: none;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-family: 'Rubik', sans-serif;
        }
        
        button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        /* טבלאות */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--spacing-lg);
            box-shadow: var(--shadow-light);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }
        
        th, td {
            border: 1px solid var(--border-color);
            padding: 15px;
            text-align: right;
        }
        
        th {
            background-color: var(--primary-light);
            color: white;
            font-weight: 500;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: rgba(76, 175, 80, 0.05);
        }
        
        .income {
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .expense {
            color: var(--danger-color);
        }
        
        .payment-method-credit {
            color: var(--credit-color);
            font-weight: 500;
        }
        
        .payment-method-cash {
            color: var(--cash-color);
            font-weight: 500;
        }
        
        /* סיכומים */
        .summary {
            display: flex;
            justify-content: space-between;
            margin-top: var(--spacing-xl);
            padding: var(--spacing-xl);
            background-color: var(--card-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-light);
            flex-wrap: wrap;
        }
        
        .summary div {
            text-align: center;
            margin: 5px;
            flex: 1;
            min-width: 150px;
            padding: var(--spacing-lg);
            border-radius: var(--radius-sm);
            background-color: #f9f9f9;
            transition: all 0.3s ease;
        }
        
        .summary div:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-light);
        }
        
        .summary h3 {
            margin-top: 0;
            color: var(--text-light);
            font-size: 16px;
        }
        
        .summary p {
            margin: 0;
            font-size: 24px;
            font-weight: 500;
        }
        
        /* פריטים */
        .recurring-item, .budget-item, .category-item {
            border: 1px solid var(--border-color);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
            border-radius: var(--radius-md);
            background-color: var(--card-bg);
            box-shadow: var(--shadow-light);
            transition: all 0.3s ease;
        }
        
        .recurring-item:hover, .budget-item:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-3px);
        }
        
        .recurring-item h3, .budget-item h3, .category-item h3 {
            margin-top: 0;
            color: var(--primary-dark);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
        }
        
        .recurring-item p, .budget-item p, .category-item p {
            margin: 8px 0;
        }
        
        .recurring-details {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }
        
        .recurring-detail {
            flex: 1;
            min-width: 150px;
            background-color: #f9f9f9;
            padding: var(--spacing-md);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-light);
            transition: all 0.3s ease;
        }
        
        .recurring-detail:hover {
            background-color: #f5f5f5;
            transform: translateY(-2px);
        }
        
        .recurring-detail p {
            margin: 5px 0;
        }
        
        .recurring-detail p:first-child {
            color: var(--text-light);
            font-size: 14px;
        }
        
        .recurring-detail p:last-child {
            font-weight: 500;
            font-size: 16px;
        }
        
        /* כפתורים */
        .delete-btn {
            background-color: var(--danger-color);
            margin-right: var(--spacing-sm);
        }
        
        .delete-btn:hover {
            background-color: #D32F2F;
        }
        
        .edit-btn {
            background-color: var(--secondary-color);
            margin-right: var(--spacing-sm);
        }
        
        .edit-btn:hover {
            background-color: var(--secondary-dark);
        }
        
        /* פרוגרס בר */
        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 20px;
            margin-top: var(--spacing-sm);
            overflow: hidden;
            height: 16px;
        }
        
        .progress-bar {
            height: 16px;
            text-align: center;
            line-height: 16px;
            color: white;
            font-size: 12px;
            font-weight: 500;
            border-radius: 20px;
            transition: width 0.5s ease;
        }
        
        .progress-under {
            background-color: var(--primary-color);
            background-image: linear-gradient(135deg, rgba(255,255,255,0.2) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.2) 75%, transparent 75%, transparent);
            background-size: 20px 20px;
            animation: progressAnimation 2s linear infinite;
        }
        
        .progress-warning {
            background-color: var(--warning-color);
            background-image: linear-gradient(135deg, rgba(255,255,255,0.2) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.2) 75%, transparent 75%, transparent);
            background-size: 20px 20px;
            animation: progressAnimation 2s linear infinite;
        }
        
        .progress-over {
            background-color: var(--danger-color);
            background-image: linear-gradient(135deg, rgba(255,255,255,0.2) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.2) 75%, transparent 75%, transparent);
            background-size: 20px 20px;
            animation: progressAnimation 2s linear infinite;
        }
        
        @keyframes progressAnimation {
            0% { background-position: 0 0; }
            100% { background-position: 40px 0; }
        }
        
        /* פילטרים */
        .filter-section {
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg);
            background-color: var(--card-bg);
            border-radius: var(--radius-sm);
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            box-shadow: var(--shadow-light);
        }
        
        .filter-item {
            flex: 1;
            min-width: 200px;
        }
        
        /* מאזנים */
        .balance-positive {
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .balance-negative {
            color: var(--danger-color);
            font-weight: 500;
        }
        
        /* שני טורים */
        .two-columns {
            display: flex;
            gap: var(--spacing-xl);
            flex-wrap: wrap;
        }
        
        .column {
            flex: 1;
            min-width: 300px;
            background-color: var(--card-bg);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-light);
        }
        
        /* רספונסיביות */
        @media (max-width: 768px) {
            .container {
                padding: var(--spacing-md);
            }
            
            .tab {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .tab-content {
                padding: var(--spacing-lg);
            }
            
            .summary div {
                flex: 100%;
                margin-bottom: var(--spacing-sm);
            }
            
            .two-columns .column {
                flex: 100%;
                margin-bottom: var(--spacing-lg);
            }
        }
        
        /* הדפסה */
        @media print {
            .no-print {
                display: none;
            }
            
            .container {
                padding: 0;
                box-shadow: none;
            }
            
            body {
                background-color: white;
            }
            
            .tab-content {
                box-shadow: none;
                padding: 0;
            }
        }
        
        /* התאמות למסך התחברות */
        #login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            padding: var(--spacing-xl);
            box-sizing: border-box;
        }
        
        #login-screen h1 {
            margin-bottom: var(--spacing-xl);
        }
        
        .auth-form {
            width: 100%;
            background-color: var(--card-bg);
            padding: var(--spacing-xl);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-medium);
            margin-bottom: var(--spacing-xl);
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: var(--spacing-lg);
        }
        
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: var(--spacing-md);
            cursor: pointer;
            background-color: var(--bg-color);
            border-bottom: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .auth-tab.active {
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-dark);
            font-weight: 500;
        }
        
        .auth-content {
            display: none;
        }
        
        .auth-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        .user-status {
            display: flex;
            align-items: center;
            background-color: var(--card-bg);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-light);
            margin-bottom: var(--spacing-lg);
        }
        
        .user-email {
            flex: 1;
            font-weight: 500;
            margin-left: var(--spacing-md);
        }
        
        .sync-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            margin-right: var(--spacing-md);
        }
        
        .sync-status.connected {
            background-color: var(--primary-light);
            color: white;
        }
        
        .sync-status.disconnected {
            background-color: var(--danger-color);
            color: white;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid white;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-message {
            color: white;
            margin-top: var(--spacing-md);
            font-weight: 500;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* התראות */
        .alert {
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            border-radius: var(--radius-sm);
            display: none;
        }
        
        .alert-success {
            background-color: rgba(76, 175, 80, 0.1);
            border: 1px solid var(--primary-color);
            color: var(--primary-dark);
        }
        
        .alert-error {
            background-color: rgba(244, 67, 54, 0.1);
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
        }
        
        /* סגנונות חדשים למערכת ניהול החובות */
        .new-debt {
            background-color: rgba(76, 175, 80, 0.05);
        }
        
        .increase-debt {
            background-color: rgba(244, 67, 54, 0.05);
        }
        
        .decrease-debt {
            background-color: rgba(33, 150, 243, 0.05);
        }
        
        .clear-debt {
            background-color: rgba(255, 152, 0, 0.05);
        }
        
        /* סגנונות לסיכום מזומן/אשראי */
        .payment-summary {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background-color: #f5f5f5;
            border-radius: var(--radius-sm);
            border-right: 3px solid var(--primary-color);
        }
        
        .payment-summary h4 {
            margin-top: 0;
            margin-bottom: var(--spacing-sm);
        }
        
        .payment-summary .payment-details {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }
        
        .payment-summary .payment-detail {
            background-color: white;
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-light);
            min-width: 150px;
        }
        
        .payment-detail.credit {
            border-right: 3px solid var(--credit-color);
        }
        
        .payment-detail.cash {
            border-right: 3px solid var(--cash-color);
        }
        
        /* סגנונות למערכת ניהול חסכונות */
        .saving-item {
            background-color: var(--card-bg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-light);
            transition: all 0.3s ease;
            border-right: 4px solid var(--secondary-color);
        }

        .saving-item:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-3px);
        }

        .saving-item h3 {
            margin-top: 0;
            color: var(--secondary-dark);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
        }

        .saving-type-regular {
            border-right: 4px solid var(--secondary-color);
        }

        .saving-type-pension {
            border-right: 4px solid #6A4C93;
        }

        .saving-type-education {
            border-right: 4px solid #1982C4;
        }

        .saving-type-emergency {
            border-right: 4px solid var(--warning-color);
        }

        .saving-type-investment {
            border-right: 4px solid #8AC926;
        }

        .saving-type-other {
            border-right: 4px solid #999999;
        }

        .saving-transaction {
            margin: 5px 0;
            padding: 8px;
            border-radius: var(--radius-sm);
        }.saving-transaction-deposit {
            background-color: rgba(76, 175, 80, 0.05);
        }

        .saving-transaction-withdraw {
            background-color: rgba(244, 67, 54, 0.05);
        }

        .saving-progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 20px;
            margin-top: var(--spacing-sm);
            overflow: hidden;
            height: 16px;
        }

        .saving-progress-bar {
            height: 16px;
            text-align: center;
            line-height: 16px;
            color: white;
            font-size: 12px;
            font-weight: 500;
            border-radius: 20px;
            transition: width 0.5s ease;
            background-color: var(--secondary-color);
            background-image: linear-gradient(135deg, rgba(255,255,255,0.2) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.2) 75%, transparent 75%, transparent);
            background-size: 20px 20px;
            animation: progressAnimation 2s linear infinite;
        }

        /* סגנונות ללשונית סטטיסטיקות */
        .chart-container {
            height: 300px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            background-color: #fff;
            position: relative;
            overflow: hidden;
        }

        .chart-container.full-width {
            height: 350px;
        }

        .loading-chart, .loading-insights {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            font-size: 16px;
            color: var(--text-light);
        }

        .stats-section {
            margin-bottom: var(--spacing-xl);
        }

        .insights-container {
            background-color: var(--card-bg);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-light);
            margin-bottom: var(--spacing-xl);
            min-height: 150px;
        }

        .insight-item {
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
            border-right: 3px solid var(--primary-color);
            background-color: rgba(76, 175, 80, 0.05);
            border-radius: var(--radius-sm);
        }

        .insight-item.warning {
            border-right-color: var(--warning-color);
            background-color: rgba(255, 152, 0, 0.05);
        }

        .insight-item.alert {
            border-right-color: var(--danger-color);
            background-color: rgba(244, 67, 54, 0.05);
        }

        .insight-item.info {
            border-right-color: var(--secondary-color);
            background-color: rgba(33, 150, 243, 0.05);
        }

        .tooltip-container {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10;
            pointer-events: none;
            white-space: nowrap;
        }

        .category-legend {
            display: flex;
            flex-wrap: wrap;
            margin-top: var(--spacing-md);
            gap: var(--spacing-sm);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-left: var(--spacing-md);
            font-size: 12px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-left: 5px;
        }

        /* מידע מסכם בדף הסטטיסטיקות */
        .stats-summary-card {
            display: flex;
            flex-direction: column;
            background-color: var(--card-bg);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-light);
            margin-bottom: var(--spacing-lg);
            transition: all 0.3s ease;
        }

        .stats-summary-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }

        .stats-summary-card h4 {
            margin-top: 0;
            margin-bottom: var(--spacing-md);
            color: var(--text-color);
            font-size: 16px;
            border-bottom: 2px solid var(--primary-light);
            padding-bottom: var(--spacing-xs);
        }

        .stats-summary-card .value {
            font-size: 22px;
            font-weight: 500;
            color: var(--primary-dark);
        }

        .stats-summary-card .trend {
            margin-top: var(--spacing-sm);
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .trend.up {
            color: var(--primary-color);
        }

        .trend.down {
            color: var(--danger-color);
        }

        .trend-arrow {
            margin-left: 5px;
        }

        /* תגי מגמה */
        .trend-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 5px;
        }

        .trend-tag.up {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--primary-dark);
        }

        .trend-tag.down {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--danger-color);
        }

        .trend-tag.stable {
            background-color: rgba(158, 158, 158, 0.1);
            color: #555;
        }
    </style>
</head>
<body>
    <!-- מסך טעינה -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div>
            <div class="loading-spinner"></div>
            <div id="loading-message" class="loading-message">טוען...</div>
        </div>
    </div><!-- מסך התחברות -->
    <div id="login-screen">
        <h1>כלי מעקב הוצאות והכנסות</h1>
        
        <div class="auth-form">
            <div class="auth-tabs">
                <div class="auth-tab active" data-auth-tab="login">התחברות</div>
                <div class="auth-tab" data-auth-tab="register">הרשמה</div>
            </div>
            
            <!-- התראות -->
            <div id="auth-alert" class="alert"></div>
            
            <!-- טופס התחברות -->
            <div class="auth-content active" id="login-form">
                <div class="form-group">
                    <label for="login-email">דוא"ל:</label>
                    <input type="email" id="login-email" placeholder="הזן את כתובת הדוא"ל שלך">
                </div>
                <div class="form-group">
                    <label for="login-password">סיסמה:</label>
                    <input type="password" id="login-password" placeholder="הזן את הסיסמה שלך">
                </div>
                <button id="login-button">התחבר</button>
            </div>
            
            <!-- טופס הרשמה -->
            <div class="auth-content" id="register-form">
                <div class="form-group">
                    <label for="register-email">דוא"ל:</label>
                    <input type="email" id="register-email" placeholder="הזן כתובת דוא"ל">
                </div>
                <div class="form-group">
                    <label for="register-password">סיסמה:</label>
                    <input type="password" id="register-password" placeholder="הזן סיסמה (לפחות 6 תווים)">
                </div>
                <div class="form-group">
                    <label for="register-password-confirm">אימות סיסמה:</label>
                    <input type="password" id="register-password-confirm" placeholder="הזן שוב את הסיסמה">
                </div>
                <button id="register-button">הירשם</button>
            </div>
        </div>
    </div><!-- מסך יישום ראשי -->
    <div id="app-container" style="display: none;">
        <div class="container">
            <h1>כלי מעקב הוצאות והכנסות</h1>
            
            <!-- סטטוס משתמש -->
            <div class="user-status">
                <div class="sync-status connected">מסונכרן</div>
                <div class="user-email" id="user-email-display">user@example.com</div>
                <button id="logout-button" class="delete-btn">התנתק</button>
            </div>
            
            <div class="tabs no-print">
                <div class="tab active" data-tab="transactions">עסקאות</div>
                <div class="tab" data-tab="recurring">הוצאות קבועות</div>
                <div class="tab" data-tab="budget">תקציבים</div>
                <div class="tab" data-tab="categories">קטגוריות</div>
                <div class="tab" data-tab="debts">חובות</div>
                <div class="tab" data-tab="savings">חסכונות</div>
                <div class="tab" data-tab="statistics">סטטיסטיקות</div>
                <div class="tab" data-tab="reports">דוחות וסיכומים</div>
            </div>
            
            <!-- עסקאות חד פעמיות -->
            <div class="tab-content active" id="transactions">
                <h2>הוסף עסקה חדשה</h2>
                <div class="form-group">
                    <label for="transaction-date">תאריך:</label>
                    <input type="date" id="transaction-date" value="">
                </div>
                <div class="form-group">
                    <label for="transaction-type">סוג:</label>
                    <select id="transaction-type">
                        <option value="income">הכנסה</option>
                        <option value="expense">הוצאה</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transaction-category">קטגוריה:</label>
                    <select id="transaction-category">
                        <!-- יתמלא דינמית מהקטגוריות המותאמות אישית -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="transaction-description">תיאור:</label>
                    <input type="text" id="transaction-description" placeholder="פירוט העסקה">
                </div>
                <div class="form-group">
                    <label for="transaction-amount">סכום (₪):</label>
                    <input type="number" id="transaction-amount" step="0.01" min="0">
                </div>
                
                <!-- אמצעי תשלום - חדש -->
                <div id="payment-method-section" style="display: none;">
                    <div class="form-group">
                        <label for="payment-method">אמצעי תשלום:</label>
                        <select id="payment-method">
                            <option value="cash">מזומן</option>
                            <option value="credit">אשראי</option>
                        </select>
                    </div>
                </div>
                
                <div id="installments-section" style="display: none;">
                    <div class="form-group">
                        <label for="is-installments">תשלומים:</label>
                        <select id="is-installments">
                            <option value="no">לא</option>
                            <option value="yes">כן</option>
                        </select>
                    </div>
                    <div id="installments-details" style="display: none;">
                        <div class="form-group">
                            <label for="total-installments">מספר תשלומים:</label>
                            <input type="number" id="total-installments" min="2" value="3">
                        </div>
                        <div class="form-group">
                            <label for="first-payment-date">תאריך תשלום ראשון:</label>
                            <input type="date" id="first-payment-date">
                        </div>
                    </div>
                </div>
                
                <button id="add-transaction">הוסף עסקה</button>
                
                <h2>עסקאות אחרונות</h2>
                <div class="filter-section no-print">
                    <div class="filter-item">
                        <label for="filter-month">סינון לפי חודש:</label>
                        <select id="filter-month">
                            <option value="all">הכל</option>
                            <option value="1">ינואר</option>
                            <option value="2">פברואר</option>
                            <option value="3">מרץ</option>
                            <option value="4">אפריל</option>
                            <option value="5">מאי</option>
                            <option value="6">יוני</option>
                            <option value="7">יולי</option>
                            <option value="8">אוגוסט</option>
                            <option value="9">ספטמבר</option>
                            <option value="10">אוקטובר</option>
                            <option value="11">נובמבר</option>
                            <option value="12">דצמבר</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filter-year">סינון לפי שנה:</label>
                        <select id="filter-year">
                            <option value="all">הכל</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filter-type">סינון לפי סוג:</label>
                        <select id="filter-type">
                            <option value="all">הכל</option>
                            <option value="income">הכנסות</option>
                            <option value="expense">הוצאות</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filter-category">סינון לפי קטגוריה:</label>
                        <select id="filter-category">
                            <option value="all">הכל</option>
                            <!-- יתמלא דינמית מהקטגוריות המותאמות אישית -->
                        </select>
                    </div>
                    <!-- פילטר אמצעי תשלום - חדש -->
                    <div class="filter-item">
                        <label for="filter-payment-method">סינון לפי אמצעי תשלום:</label>
                        <select id="filter-payment-method">
                            <option value="all">הכל</option>
                            <option value="cash">מזומן</option>
                            <option value="credit">אשראי</option>
                        </select>
                    </div>
                </div>
                
                <table id="transactions-table">
                    <thead>
                        <tr>
                            <th>תאריך</th>
                            <th>סוג</th>
                            <th>קטגוריה</th>
                            <th>תיאור</th>
                            <th>סכום (₪)</th>
                            <th>אמצעי תשלום</th>
                            <th>תשלומים</th>
                            <th class="no-print">פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-body">
                        <!-- כאן יתווספו העסקאות -->
                    </tbody>
                </table>
                
                <div class="summary">
                    <div>
                        <h3>סה"כ הכנסות</h3>
                        <p id="total-income">₪0.00</p>
                    </div>
                    <div>
                        <h3>סה"כ הוצאות</h3>
                        <p id="total-expenses">₪0.00</p>
                    </div>
                    <div>
                        <h3>מאזן</h3>
                        <p id="balance">₪0.00</p>
                    </div>
                </div>
                
                <!-- סיכום אמצעי תשלום - חדש -->
                <div class="payment-summary">
                    <h4>סיכום לפי אמצעי תשלום</h4>
                    <div class="payment-details">
                        <div class="payment-detail cash">
                            <p><strong>מזומן</strong></p>
                            <p id="cash-total">₪0.00</p>
                        </div>
                        <div class="payment-detail credit">
                            <p><strong>אשראי</strong></p>
                            <p id="credit-total">₪0.00</p>
                        </div>
                    </div>
                </div>
            </div><!-- הוצאות קבועות -->
            <div class="tab-content" id="recurring">
                <h2>הוסף הוצאה קבועה</h2>
                <div class="form-group">
                    <label for="recurring-description">תיאור:</label>
                    <input type="text" id="recurring-description" placeholder="תיאור ההוצאה הקבועה">
                </div>
                <div class="form-group">
                    <label for="recurring-category">קטגוריה:</label>
                    <select id="recurring-category">
                        <!-- יתמלא דינמית מהקטגוריות המותאמות אישית -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="recurring-amount">סכום (₪):</label>
                    <input type="number" id="recurring-amount" step="0.01" min="0">
                </div>
                <!-- אמצעי תשלום להוצאה קבועה - חדש -->
                <div class="form-group">
                    <label for="recurring-payment-method">אמצעי תשלום:</label>
                    <select id="recurring-payment-method">
                        <option value="cash">מזומן</option>
                        <option value="credit">אשראי</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="recurring-day">יום בחודש לחיוב:</label>
                    <input type="number" id="recurring-day" min="1" max="31" value="1">
                </div>
                <div class="form-group">
                    <label for="recurring-start-date">תאריך התחלה:</label>
                    <input type="date" id="recurring-start-date">
                </div>
                <div class="form-group">
                    <label for="recurring-end-type">משך זמן:</label>
                    <select id="recurring-end-type">
                        <option value="ongoing">ללא הגבלה</option>
                        <option value="date">עד תאריך</option>
                        <option value="occurrences">מספר פעמים</option>
                    </select>
                </div>
                <div id="recurring-end-date-group" style="display: none;">
                    <div class="form-group">
                        <label for="recurring-end-date">תאריך סיום:</label>
                        <input type="date" id="recurring-end-date">
                    </div>
                </div>
                <div id="recurring-occurrences-group" style="display: none;">
                    <div class="form-group">
                        <label for="recurring-occurrences">מספר תשלומים:</label>
                        <input type="number" id="recurring-occurrences" min="1" value="12">
                    </div>
                </div>
                
                <button id="add-recurring">הוסף הוצאה קבועה</button>
                
                <h2>הוצאות קבועות</h2>
                <div id="recurring-items">
                    <!-- כאן יתווספו ההוצאות הקבועות -->
                </div>
            </div>
            
            <!-- ניהול תקציבים -->
            <div class="tab-content" id="budget">
                <h2>ניהול תקציבים</h2>
                
                <div class="two-columns">
                    <div class="column">
                        <h3>תקציב חודשי כולל</h3>
                        <div class="form-group">
                            <label for="total-budget-amount">סכום תקציב חודשי כולל (₪):</label>
                            <input type="number" id="total-budget-amount" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="total-budget-description">הערות (אופציונלי):</label>
                            <input type="text" id="total-budget-description" placeholder="הערות לגבי התקציב הכולל">
                        </div>
                        <button id="add-total-budget">הגדר תקציב כולל</button>
                        
                        <h3 style="margin-top: 30px;">תקציב לפי קטגוריה</h3>
                        <div class="form-group">
                            <label for="budget-category">קטגוריה:</label>
                            <select id="budget-category">
                                <!-- יתמלא דינמית מהקטגוריות המותאמות אישית -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="budget-amount">סכום תקציב חודשי (₪):</label>
                            <input type="number" id="budget-amount" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="budget-description">הערות (אופציונלי):</label>
                            <input type="text" id="budget-description" placeholder="הערות לגבי התקציב">
                        </div>
                        <button id="add-budget">הוסף תקציב</button>
                    </div>
                    
                    <div class="column">
                        <h3>תקציבים פעילים</h3>
                        <div class="filter-section no-print">
                            <div class="filter-item">
                                <label for="budget-view-month">חודש:</label>
                                <select id="budget-view-month">
                                    <option value="1">ינואר</option>
                                    <option value="2">פברואר</option>
                                    <option value="3">מרץ</option>
                                    <option value="4">אפריל</option>
                                    <option value="5">מאי</option>
                                    <option value="6">יוני</option>
                                    <option value="7">יולי</option>
                                    <option value="8">אוגוסט</option>
                                    <option value="9">ספטמבר</option>
                                    <option value="10">אוקטובר</option>
                                    <option value="11">נובמבר</option>
                                    <option value="12">דצמבר</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label for="budget-view-year">שנה:</label>
                                <select id="budget-view-year">
                                    <!-- יתמלא דינמית -->
                                </select>
                            </div>
                        </div>
                        
                        <div id="total-budget-container">
                            <!-- כאן יוצג התקציב הכולל -->
                        </div>
                        
                        <h3>תקציבים לפי קטגוריות</h3>
                        <div id="budgets-container">
                            <!-- כאן יוצגו התקציבים -->
                        </div>
                    </div>
                </div>
            </div><!-- ניהול קטגוריות -->
            <div class="tab-content" id="categories">
                <h2>ניהול קטגוריות</h2>
                
                <div class="two-columns">
                    <div class="column">
                        <h3>הוסף קטגוריה חדשה</h3>
                        <div class="form-group">
                            <label for="new-category-name">שם הקטגוריה:</label>
                            <input type="text" id="new-category-name" placeholder="שם הקטגוריה">
                        </div>
                        <div class="form-group">
                            <label for="new-category-type">סוג הקטגוריה:</label>
                            <select id="new-category-type">
                                <option value="both">הכנסות והוצאות</option>
                                <option value="income">הכנסות בלבד</option>
                                <option value="expense">הוצאות בלבד</option>
                            </select>
                        </div>
                        <button id="add-category">הוסף קטגוריה</button>
                    </div>
                    
                    <div class="column">
                        <h3>קטגוריות קיימות</h3>
                        <div class="filter-section no-print">
                            <div class="filter-item">
                                <label for="category-filter">סינון:</label>
                                <select id="category-filter">
                                    <option value="all">כל הקטגוריות</option>
                                    <option value="income">קטגוריות הכנסה</option>
                                    <option value="expense">קטגוריות הוצאה</option>
                                    <option value="both">קטגוריות משותפות</option>
                                </select>
                            </div>
                        </div>
                        <div id="categories-container">
                            <!-- כאן יוצגו הקטגוריות -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ניהול חובות -->
            <div class="tab-content" id="debts">
                <h2>ניהול חובות</h2>
                
                <div class="two-columns">
                    <div class="column">
                        <h3>חוב חדש</h3>
                        <div class="form-group">
                            <label for="debt-person">שם האדם/הגורם:</label>
                            <input type="text" id="debt-person" placeholder="למי או ממי החוב">
                        </div>
                        <div class="form-group">
                            <label for="debt-type">סוג החוב:</label>
                            <select id="debt-type">
                                <option value="they-owe-me">חייבים לי</option>
                                <option value="i-owe-them">אני חייב</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="debt-amount">סכום (₪):</label>
                            <input type="number" id="debt-amount" step="0.01" min="0" placeholder="סכום החוב">
                        </div>
                        <div class="form-group">
                            <label for="debt-date">תאריך:</label>
                            <input type="date" id="debt-date">
                        </div>
                        <div class="form-group">
                            <label for="debt-description">תיאור:</label>
                            <input type="text" id="debt-description" placeholder="פרטים נוספים על החוב">
                        </div>
                        <button id="add-debt">הוסף חוב</button>
                        
                        <h3 style="margin-top: 30px;">עדכון חוב קיים</h3>
                        <div class="form-group">
                            <label for="update-debt-person">בחר אדם:</label>
                            <select id="update-debt-person">
                                <option value="">-- בחר אדם --</option>
                                <!-- יתמלא דינמית -->
                            </select>
                        </div>
                        
                        <div id="update-debt-info" style="display: none;">
                            <div class="recurring-details">
                                <div class="recurring-detail">
                                    <p><strong>סטטוס נוכחי</strong></p>
                                    <p id="debt-current-status">חייבים לי</p>
                                </div>
                                <div class="recurring-detail">
                                    <p><strong>סכום נוכחי</strong></p>
                                    <p id="debt-current-amount">₪0.00</p>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="update-debt-type">סוג העדכון:</label>
                                <select id="update-debt-type">
                                    <option value="increase">הגדלת חוב</option>
                                    <option value="decrease">הקטנת חוב</option>
                                    <option value="clear">סגירת חוב</option>
                                </select>
                            </div>
                            
                            <div id="update-amount-group" class="form-group">
                                <label for="update-debt-amount">סכום העדכון (₪):</label>
                                <input type="number" id="update-debt-amount" step="0.01" min="0">
                            </div>
                            
                            <div class="form-group">
                                <label for="update-debt-date">תאריך:</label>
                                <input type="date" id="update-debt-date">
                            </div>
                            <div class="form-group">
                                <label for="update-debt-description">תיאור העדכון:</label>
                                <input type="text" id="update-debt-description" placeholder="פרטים על העדכון">
                            </div>
                            
                            <button id="update-debt-btn">עדכן חוב</button>
                        </div>
                    </div>
                    
                    <div class="column">
                        <h3>חובות פעילים</h3>
                        <div class="summary">
                            <div>
                                <h3>סה"כ חייבים לי</h3>
                                <p id="total-debt-owed-to-me" class="balance-positive">₪0.00</p>
                            </div>
                            <div>
                                <h3>סה"כ אני חייב</h3>
                                <p id="total-debt-i-owe" class="balance-negative">₪0.00</p>
                            </div>
                            <div>
                                <h3>מאזן</h3>
                                <p id="debt-balance">₪0.00</p>
                            </div>
                        </div>
                        
                        <div class="filter-section no-print">
                            <div class="filter-item">
                                <label for="debt-filter">סינון לפי סוג חוב:</label>
                                <select id="debt-filter">
                                    <option value="all">הכל</option>
                                    <option value="they-owe-me">חייבים לי</option>
                                    <option value="i-owe-them">אני חייב</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="active-debts">
                            <!-- כאן יוצגו החובות הפעילים -->
                        </div>
                        
                        <h3 style="margin-top: 30px;">היסטוריית חובות</h3>
                        <div class="form-group">
                            <label for="debt-history-person">בחר אדם להצגת היסטוריה:</label>
                            <select id="debt-history-person">
                                <option value="">-- בחר אדם --</option>
                                <!-- יתמלא דינמית -->
                            </select>
                        </div>
                        
                        <div id="debt-history-container" style="display: none;">
                            <!-- כאן תוצג היסטוריית החוב -->
                        </div>
                    </div>
                </div>
            </div><!-- לשונית חסכונות (חדש) -->
            <div class="tab-content" id="savings">
                <h2>ניהול חסכונות</h2>
                
                <div class="two-columns">
                    <div class="column">
                        <h3>הוסף חסכון חדש</h3>
                        <div class="form-group">
                            <label for="saving-name">שם החסכון:</label>
                            <input type="text" id="saving-name" placeholder="שם החסכון">
                        </div>
                        <div class="form-group">
                            <label for="saving-type">סוג החסכון:</label>
                            <select id="saving-type">
                                <option value="regular">חסכון רגיל</option>
                                <option value="pension">פנסיה</option>
                                <option value="education">חסכון לחינוך</option>
                                <option value="emergency">קרן חירום</option>
                                <option value="investment">השקעה</option>
                                <option value="other">אחר</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="saving-start-amount">סכום התחלתי (₪):</label>
                            <input type="number" id="saving-start-amount" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="saving-target-amount">סכום יעד (₪, אופציונלי):</label>
                            <input type="number" id="saving-target-amount" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="saving-interest">ריבית שנתית (%, אופציונלי):</label>
                            <input type="number" id="saving-interest" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="saving-start-date">תאריך התחלה:</label>
                            <input type="date" id="saving-start-date">
                        </div>
                        <div class="form-group">
                            <label for="saving-end-date">תאריך יעד (אופציונלי):</label>
                            <input type="date" id="saving-end-date">
                        </div>
                        <div class="form-group">
                            <label for="saving-description">הערות (אופציונלי):</label>
                            <input type="text" id="saving-description" placeholder="הערות נוספות">
                        </div>
                        <button id="add-saving">הוסף חסכון</button>

                        <h3 style="margin-top: 30px;">הפקדה/משיכה מחסכון קיים</h3>
                        <div class="form-group">
                            <label for="update-saving-id">בחר חסכון:</label>
                            <select id="update-saving-id">
                                <option value="">-- בחר חסכון --</option>
                                <!-- יתמלא דינמית -->
                            </select>
                        </div>
                        
                        <div id="update-saving-form" style="display: none;">
                            <div class="recurring-details">
                                <div class="recurring-detail">
                                    <p><strong>יתרה נוכחית</strong></p>
                                    <p id="saving-current-balance">₪0.00</p>
                                </div>
                                <div class="recurring-detail">
                                    <p><strong>סכום יעד</strong></p>
                                    <p id="saving-goal-amount">₪0.00</p>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="saving-transaction-type">סוג פעולה:</label>
                                <select id="saving-transaction-type">
                                    <option value="deposit">הפקדה</option>
                                    <option value="withdraw">משיכה</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="saving-transaction-amount">סכום (₪):</label>
                                <input type="number" id="saving-transaction-amount" step="0.01" min="0">
                            </div>
                            <div class="form-group">
                                <label for="saving-transaction-date">תאריך:</label>
                                <input type="date" id="saving-transaction-date">
                            </div>
                            <div class="form-group">
                                <label for="saving-transaction-description">תיאור:</label>
                                <input type="text" id="saving-transaction-description" placeholder="תיאור הפעולה">
                            </div>
                            <button id="add-saving-transaction">בצע פעולה</button>
                        </div>
                    </div>
                    
                    <div class="column">
                        <h3>חסכונות פעילים</h3>
                        <div class="summary">
                            <div>
                                <h3>סה"כ חסכונות</h3>
                                <p id="total-savings" class="balance-positive">₪0.00</p>
                            </div>
                            <div>
                                <h3>יעד כולל</h3>
                                <p id="total-savings-goals">₪0.00</p>
                            </div>
                            <div>
                                <h3>מימוש יעדים</h3>
                                <p id="total-savings-progress">0%</p>
                            </div>
                        </div>
                        
                        <div id="savings-container">
                            <!-- כאן יוצגו החסכונות -->
                        </div>
                        
                        <h3 style="margin-top: 30px;">היסטוריית פעולות</h3>
                        <div class="form-group">
                            <label for="saving-history-id">בחר חסכון להצגת היסטוריה:</label>
                            <select id="saving-history-id">
                                <option value="">-- בחר חסכון --</option>
                                <!-- יתמלא דינמית -->
                            </select>
                        </div>
                        
                        <div id="saving-history-container" style="display: none;">
                            <!-- כאן תוצג היסטוריית החסכון -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- לשונית סטטיסטיקות (חדש) -->
            <div class="tab-content" id="statistics">
                <h2>סטטיסטיקות וניתוח נתונים</h2>
                
                <div class="filter-section no-print">
                    <div class="filter-item">
                        <label for="stats-period">תקופה:</label>
                        <select id="stats-period">
                            <option value="month">חודש נוכחי</option>
                            <option value="last-month">חודש קודם</option>
                            <option value="3-months">3 חודשים אחרונים</option>
                            <option value="6-months">6 חודשים אחרונים</option>
                            <option value="year" selected>שנה אחרונה</option>
                            <option value="all">כל הזמן</option>
                            <option value="custom">טווח מותאם אישית</option>
                        </select>
                    </div>
                    <div class="filter-item custom-date-range" style="display: none;">
                        <label for="stats-start-date">מתאריך:</label>
                        <input type="date" id="stats-start-date">
                    </div>
                    <div class="filter-item custom-date-range" style="display: none;">
                        <label for="stats-end-date">עד תאריך:</label>
                        <input type="date" id="stats-end-date">
                    </div>
                    <div class="filter-item">
                        <button id="generate-statistics">הפק סטטיסטיקות</button>
                    </div>
                </div>
                
                <div id="stats-summary" class="summary">
                    <div>
                        <h3>סה"כ הכנסות</h3>
                        <p id="stats-income">₪0.00</p>
                    </div>
                    <div>
                        <h3>סה"כ הוצאות</h3>
                        <p id="stats-expenses">₪0.00</p>
                    </div>
                    <div>
                        <h3>ממוצע חודשי</h3>
                        <p id="stats-monthly-average">₪0.00</p>
                    </div>
                    <div>
                        <h3>חיסכון מצטבר</h3>
                        <p id="stats-savings">₪0.00</p>
                    </div>
                </div>
                
                <div class="two-columns">
                    <div class="column">
                        <h3>התפלגות הוצאות לפי קטגוריות</h3>
                        <div id="expenses-by-category-chart" class="chart-container">
                            <div class="loading-chart">טוען נתונים...</div>
                        </div>
                    </div>
                    <div class="column">
                        <h3>התפלגות הוצאות לפי אמצעי תשלום</h3>
                        <div id="expenses-by-payment-chart" class="chart-container">
                            <div class="loading-chart">טוען נתונים...</div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-section">
                    <h3>מגמות הוצאות והכנסות</h3>
                    <div id="income-expenses-trend-chart" class="chart-container full-width">
                        <div class="loading-chart">טוען נתונים...</div>
                    </div>
                </div>
                
                <div class="stats-section">
                    <h3>התפלגות הוצאות חודשית</h3>
                    <div id="monthly-expenses-chart" class="chart-container full-width">
                        <div class="loading-chart">טוען נתונים...</div>
                    </div>
                </div>
                
                <div class="two-columns">
                    <div class="column">
                        <h3>ימים בשבוע עם הוצאות מרובות</h3>
                        <div id="expenses-by-day-chart" class="chart-container">
                            <div class="loading-chart">טוען נתונים...</div>
                        </div>
                    </div>
                    <div class="column">
                        <h3>השוואת הוצאות בין חודשים</h3>
                        <div id="month-comparison-chart" class="chart-container">
                            <div class="loading-chart">טוען נתונים...</div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-section">
                    <h3>ניתוח תובנות</h3>
                    <div id="stats-insights" class="insights-container">
                        <div class="loading-insights">מנתח נתונים...</div>
                    </div>
                </div>
            </div><!-- דוחות וסיכומים -->
            <div class="tab-content" id="reports">
                <h2>דוחות וסיכומים</h2>
                
                <div class="filter-section no-print">
                    <div class="filter-item">
                        <label for="report-month">חודש:</label>
                        <select id="report-month">
                            <option value="all">הכל</option>
                            <option value="1">ינואר</option>
                            <option value="2">פברואר</option>
                            <option value="3">מרץ</option>
                            <option value="4">אפריל</option>
                            <option value="5">מאי</option>
                            <option value="6">יוני</option>
                            <option value="7">יולי</option>
                            <option value="8">אוגוסט</option>
                            <option value="9">ספטמבר</option>
                            <option value="10">אוקטובר</option>
                            <option value="11">נובמבר</option>
                            <option value="12">דצמבר</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="report-year">שנה:</label>
                        <select id="report-year">
                            <!-- יתמלא דינמית -->
                        </select>
                    </div>
                    <div class="filter-item">
                        <button id="generate-report">הפק דוח</button>
                        <button id="print-report" style="margin-right: 10px;">הדפס דוח</button>
                    </div>
                </div>
                
                <div id="report-summary" class="summary">
                    <div>
                        <h3>סה"כ הכנסות</h3>
                        <p id="report-income">₪0.00</p>
                    </div>
                    <div>
                        <h3>סה"כ הוצאות</h3>
                        <p id="report-expenses">₪0.00</p>
                    </div>
                    <div>
                        <h3>מאזן</h3>
                        <p id="report-balance">₪0.00</p>
                    </div>
                </div>
                
                <!-- סיכום תשלומים לפי אמצעי תשלום - חדש -->
                <div class="payment-summary">
                    <h4>סיכום לפי אמצעי תשלום</h4>
                    <div class="payment-details">
                        <div class="payment-detail cash">
                            <p><strong>מזומן</strong></p>
                            <p id="report-cash-total">₪0.00</p>
                        </div>
                        <div class="payment-detail credit">
                            <p><strong>אשראי</strong></p>
                            <p id="report-credit-total">₪0.00</p>
                        </div>
                    </div>
                </div>
                
                <h3>תשלומים עתידיים</h3>
                <table id="future-payments">
                    <thead>
                        <tr>
                            <th>תאריך</th>
                            <th>תיאור</th>
                            <th>קטגוריה</th>
                            <th>סכום (₪)</th>
                            <th>אמצעי תשלום</th>
                            <th>סוג</th>
                        </tr>
                    </thead>
                    <tbody id="future-payments-body">
                        <!-- יתמלא דינמית -->
                    </tbody>
                </table>
                
                <div class="filter-section no-print" style="margin-top: 30px;">
                    <h3>ניהול נתונים</h3>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button id="export-data" class="edit-btn">ייצוא נתונים</button>
                        <button id="import-data" class="edit-btn">ייבוא נתונים</button>
                        <button id="clear-data" class="delete-btn">מחיקת כל הנתונים</button>
                    </div>
                </div>
            </div>
        </div>
    </div><script>
        // מערך לאחסון עסקאות
        let transactions = [];
        
        // מערך לאחסון הוצאות קבועות
        let recurringExpenses = [];
        
        // מערך לאחסון קטגוריות מותאמות אישית
        let categories = [
            { id: 1, name: "שכר", type: "income" },
            { id: 2, name: "מזון", type: "expense" },
            { id: 3, name: "תחבורה", type: "expense" },
            { id: 4, name: "דיור", type: "expense" },
            { id: 5, name: "בילויים", type: "expense" },
            { id: 6, name: "חשבונות", type: "expense" },
            { id: 7, name: "ביגוד", type: "expense" },
            { id: 8, name: "בריאות", type: "expense" },
            { id: 9, name: "חינוך", type: "expense" },
            { id: 10, name: "אחר", type: "both" }
        ];
        
        // מערך לאחסון תקציבים
        let budgets = [];
        
        // אובייקט לאחסון תקציב כולל
        let totalBudget = {
            amount: 0,
            description: ''
        };
        
        // מערך לאחסון נתוני חובות
        let debts = [];
        
        // מערך לאחסון חסכונות (חדש)
        let savings = [];
        
        // מצב סנכרון
        let syncState = {
            isLoggedIn: false,
            userId: null,
            isSyncing: false,
            lastSyncTime: null,
            pendingSave: false // נוסף - מעקב אחר שינויים ממתינים
        };
        
        // משתנה לציון אם הנתונים הוטענו מהשרת
        let dataLoaded = false;
        
        // פונקציה להצגת הודעת שגיאה
        function showError(message, elementId = 'auth-alert') {
            const alertElement = document.getElementById(elementId);
            alertElement.className = 'alert alert-error';
            alertElement.style.display = 'block';
            alertElement.textContent = message;
            
            // הסתרת ההודעה אחרי 5 שניות
            setTimeout(() => {
                alertElement.style.display = 'none';
            }, 5000);
        }
        
        // פונקציה להצגת הודעת הצלחה
        function showSuccess(message, elementId = 'auth-alert') {
            const alertElement = document.getElementById(elementId);
            alertElement.className = 'alert alert-success';
            alertElement.style.display = 'block';
            alertElement.textContent = message;
            
            // הסתרת ההודעה אחרי 5 שניות
            setTimeout(() => {
                alertElement.style.display = 'none';
            }, 5000);
        }
        
        // פונקציה להצגת מסך טעינה
        function showLoading(message = 'טוען...') {
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingMessage = document.getElementById('loading-message');
            
            loadingMessage.textContent = message;
            loadingOverlay.style.display = 'flex';
        }
        
        // פונקציה להסתרת מסך טעינה
        function hideLoading() {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'none';
        }
        
        // רישום משתמש חדש
        async function registerUser() {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const passwordConfirm = document.getElementById('register-password-confirm').value;
            
            // בדיקות אימות
            if (!email || !password || !passwordConfirm) {
                showError('נא למלא את כל השדות');
                return;
            }
            
            if (password !== passwordConfirm) {
                showError('הסיסמאות אינן תואמות');
                return;
            }
            
            if (password.length < 6) {
                showError('הסיסמה חייבת להכיל לפחות 6 תווים');
                return;
            }
            
            // יצירת המשתמש ב-Firebase
            try {
                showLoading('יוצר משתמש חדש...');
                
                const userCredential = await window.firebaseApp.createUser(email, password);
                const user = userCredential.user;
                
                // הגדרת מצב ההתחברות
                syncState.isLoggedIn = true;
                syncState.userId = user.uid;
                
                // אתחול נתונים ראשוניים למשתמש החדש
                await saveAllDataToFirebase(true); // מעביר true כדי לציין שזו שמירה ראשונית
                
                showSuccess('ההרשמה הושלמה בהצלחה!');
                hideLoading();
                
                // מעבר למסך היישום
                showApp();
                
            } catch (error) {
                hideLoading();
                
                // טיפול בשגיאות ספציפיות
                if (error.code === 'auth/email-already-in-use') {
                    showError('כתובת האימייל כבר רשומה במערכת');
                } else if (error.code === 'auth/invalid-email') {
                    showError('כתובת האימייל אינה תקינה');
                } else if (error.code === 'auth/weak-password') {
                    showError('הסיסמה חלשה מדי');
                } else {
                    showError('שגיאה בהרשמה: ' + error.message);
                }
                
                console.error('Registration error:', error);
            }
        }
        
        // התחברות משתמש קיים
        async function loginUser() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            // בדיקות אימות
            if (!email || !password) {
                showError('נא למלא את כל השדות');
                return;
            }
            
            // התחברות ב-Firebase
            try {
                showLoading('מתחבר...');
                
                const userCredential = await window.firebaseApp.signIn(email, password);
                const user = userCredential.user;
                
                // הגדרת מצב ההתחברות
                syncState.isLoggedIn = true;
                syncState.userId = user.uid;
                
                // הצגת הודעת טעינה
                showLoading('טוען נתונים מהשרת...');
                
                // טעינת נתונים מהענן - ניסיונות חוזרים
                let loadSuccess = false;
                let retryCount = 0;
                const maxRetries = 3;
                
                while (!loadSuccess && retryCount < maxRetries) {
                    try {
                        await loadAllDataFromFirebase();
                        loadSuccess = true;
                        console.log('Data loaded successfully on attempt', retryCount + 1);
                    } catch (loadError) {
                        retryCount++;
                        console.warn(`Load attempt ${retryCount} failed:`, loadError);
                        // המתנה קצרה לפני ניסיון נוסף
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                if (!loadSuccess) {
                    console.error('Failed to load data after multiple attempts');
                    showError('לא הצלחנו לטעון את הנתונים שלך. אנא נסה שוב מאוחר יותר.');
                }
                
                hideLoading();
                
                // מעבר למסך היישום
                showApp();
                
            } catch (error) {
                hideLoading();
                
                // טיפול בשגיאות ספציפיות
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    showError('שם משתמש או סיסמה שגויים');
                } else if (error.code === 'auth/invalid-email') {
                    showError('כתובת האימייל אינה תקינה');
                } else if (error.code === 'auth/too-many-requests') {
                    showError('יותר מדי נסיונות התחברות כושלים. נסה שוב מאוחר יותר');
                } else {
                    showError('שגיאה בהתחברות: ' + error.message);
                }
                
                console.error('Login error:', error);
            }
        }
        
        // התנתקות משתמש
        async function logoutUser() {
            if (confirm('האם אתה בטוח שברצונך להתנתק?')) {
                try {
                    showLoading('מתנתק...');
                    
                    // שמירת הנתונים לפני ההתנתקות
                    await saveAllDataToFirebase(true); // מעביר true כדי לציין שזו שמירה חשובה
                    
                    await window.firebaseApp.signOut();
                    
                    // איפוס מצב ההתחברות
                    syncState.isLoggedIn = false;
                    syncState.userId = null;
                    
                    hideLoading();
                    
                    // מעבר למסך ההתחברות
                    showLoginScreen();
                    
                } catch (error) {
                    hideLoading();
                    console.error('Logout error:', error);
                    alert('שגיאה בהתנתקות: ' + error.message);
                }
            }
        }
        
        // הצגת מסך היישום
        function showApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            
            // עדכון פרטי המשתמש המחובר
            const user = window.firebaseApp.getCurrentUser();
            if (user) {
                document.getElementById('user-email-display').textContent = user.email;
            }
            
            // אתחול התצוגה
            populateCategoryDropdowns();
            renderTransactions();
            renderRecurringExpenses();
            renderCategories();
            renderBudgets();
            renderDebts();
            renderSavings(); // חדש - הצגת חסכונות
            updateDebtPersonDropdowns();
            updateSavingSelects(); // חדש - עדכון רשימות החסכונות
            generateRecurringTransactions();
            
            // הגדרת מנגנון שמירה אוטומטי (כל 3 דקות)
            setupAutoSave();
        }
        
        // הצגת מסך ההתחברות
        function showLoginScreen() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
        }
        
        // הגדרת מנגנון שמירה אוטומטי
        function setupAutoSave() {
            // ביטול טיימר קיים, אם יש
            if (window.autoSaveTimer) {
                clearInterval(window.autoSaveTimer);
            }
            
            // הגדרת טיימר חדש - שמירה כל 3 דקות
            window.autoSaveTimer = setInterval(() => {
                if (syncState.isLoggedIn && !syncState.isSyncing && syncState.pendingSave) {
                    console.log('Auto-save triggered');
                    saveAllDataToFirebase();
                }
            }, 180000); // 3 דקות
            
            // ניקוי הטיימר בעת סגירת החלון או רענון
            window.addEventListener('beforeunload', function(e) {
                // שמירת נתונים לפני סגירה, אם יש צורך
                if (syncState.isLoggedIn && syncState.pendingSave) {
                    // ננסה לבצע שמירה סינכרונית
                    try {
                        const saveMsg = 'יש נתונים שלא נשמרו. האם לסגור את החלון?';
                        e.returnValue = saveMsg;
                        return saveMsg;
                    } catch (err) {
                        console.error('Error during sync save:', err);
                    }
                }
            });
        }// שמירת כל הנתונים ל-Firebase
        async function saveAllDataToFirebase(forceSync = false) {
            if (!syncState.isLoggedIn || !syncState.userId) return;
            
            try {
                // אם כבר מתבצע תהליך סנכרון, נסמן שיש צורך בסנכרון נוסף
                if (syncState.isSyncing && !forceSync) {
                    syncState.pendingSave = true;
                    console.log('Sync already in progress, marking for later save');
                    return;
                }
                
                syncState.isSyncing = true;
                syncState.pendingSave = false;
                
                // עדכון סטטוס סנכרון
                updateSyncStatus(true, 'שומר נתונים...');
                
                console.log('Saving all data to Firebase...');
                
                // שמירת כל סוגי הנתונים (כולל חובות וחסכונות)
                const savePromises = [
                    window.firebaseApp.saveUserData(syncState.userId, 'transactions', transactions),
                    window.firebaseApp.saveUserData(syncState.userId, 'recurringExpenses', recurringExpenses),
                    window.firebaseApp.saveUserData(syncState.userId, 'categories', categories),
                    window.firebaseApp.saveUserData(syncState.userId, 'budgets', budgets),
                    window.firebaseApp.saveUserData(syncState.userId, 'totalBudget', totalBudget),
                    window.firebaseApp.saveUserData(syncState.userId, 'debts', debts),
                    window.firebaseApp.saveUserData(syncState.userId, 'savings', savings) // חדש - שמירת חסכונות
                ];
                
                await Promise.all(savePromises);
                
                // עדכון זמן הסנכרון האחרון
                syncState.lastSyncTime = new Date();
                
                // עדכון סטטוס סנכרון
                updateSyncStatus(true);
                
                syncState.isSyncing = false;
                
                console.log('All data saved to Firebase successfully');
                
            } catch (error) {
                syncState.isSyncing = false;
                syncState.pendingSave = true; // סימון שיש צורך בניסיון נוסף
                
                // עדכון סטטוס סנכרון
                updateSyncStatus(false);
                
                console.error('Error saving all data to Firebase:', error);
                
                // אם זו שמירה מאולצת (למשל בהתחברות או יציאה), להציג שגיאה למשתמש
                if (forceSync) {
                    alert('שגיאה בשמירת נתונים: ' + error.message);
                }
            }
        }
        
        // טעינת כל הנתונים מ-Firebase
        async function loadAllDataFromFirebase() {
            if (!syncState.isLoggedIn || !syncState.userId) {
                console.error('Cannot load data - user not logged in');
                return;
            }
            
            try {
                syncState.isSyncing = true;
                
                // עדכון סטטוס סנכרון
                updateSyncStatus(true, 'טוען נתונים...');
                
                console.log('Loading data from Firebase for user:', syncState.userId);
                
                // טעינת כל סוגי הנתונים במקביל, כולל חסכונות
                const [
                    loadedTransactions,
                    loadedRecurringExpenses,
                    loadedCategories,
                    loadedBudgets,
                    loadedTotalBudget,
                    loadedDebts,
                    loadedSavings
                ] = await Promise.all([
                    window.firebaseApp.getUserData(syncState.userId, 'transactions'),
                    window.firebaseApp.getUserData(syncState.userId, 'recurringExpenses'),
                    window.firebaseApp.getUserData(syncState.userId, 'categories'),
                    window.firebaseApp.getUserData(syncState.userId, 'budgets'),
                    window.firebaseApp.getUserData(syncState.userId, 'totalBudget'),
                    window.firebaseApp.getUserData(syncState.userId, 'debts'),
                    window.firebaseApp.getUserData(syncState.userId, 'savings')
                ]);
                
                console.log('Data loaded from Firebase:', {
                    transactions: loadedTransactions ? 'loaded' : 'empty',
                    recurringExpenses: loadedRecurringExpenses ? 'loaded' : 'empty',
                    categories: loadedCategories ? 'loaded' : 'empty',
                    budgets: loadedBudgets ? 'loaded' : 'empty',
                    totalBudget: loadedTotalBudget ? 'loaded' : 'empty',
                    debts: loadedDebts ? 'loaded' : 'empty',
                    savings: loadedSavings ? 'loaded' : 'empty'
                });
                
                // עדכון הנתונים המקומיים אם קיימים נתונים
                if (loadedTransactions) transactions = loadedTransactions;
                if (loadedRecurringExpenses) recurringExpenses = loadedRecurringExpenses;
                if (loadedCategories) categories = loadedCategories;
                if (loadedBudgets) budgets = loadedBudgets;
                if (loadedTotalBudget) totalBudget = loadedTotalBudget;
                if (loadedDebts) debts = loadedDebts;
                if (loadedSavings) savings = loadedSavings;
                
                // תיקון עבור תקציב כולל אם לא נטען כראוי
                if (!totalBudget) {
                    totalBudget = { amount: 0, description: '' };
                }
                
                // אתחול מערך החובות אם לא נטען
                if (!debts) {
                    debts = [];
                }
                
                // אתחול מערך החסכונות אם לא נטען (חדש)
                if (!savings) {
                    savings = [];
                }
                
                // בדיקה ותיקון שדה אמצעי תשלום אם חסר
                transactions.forEach(transaction => {
                    if (!transaction.paymentMethod && transaction.type === 'expense') {
                        transaction.paymentMethod = 'cash'; // ברירת מחדל - מזומן
                    }
                });
                
                recurringExpenses.forEach(expense => {
                    if (!expense.paymentMethod) {
                        expense.paymentMethod = 'cash'; // ברירת מחדל - מזומן
                    }
                });
                
                // וידוא שלקטגוריות יש ערכי ID תקינים
                ensureCategoryIds();
                
                // עדכון זמן הסנכרון האחרון
                syncState.lastSyncTime = new Date();
                dataLoaded = true;
                syncState.pendingSave = false; // איפוס דגל השמירה
                
                // עדכון סטטוס סנכרון
                updateSyncStatus(true);
                
                syncState.isSyncing = false;
                
                // עדכון התצוגה
                populateCategoryDropdowns();
                renderTransactions();
                renderRecurringExpenses();
                renderCategories();
                renderBudgets();
                renderDebts();
                renderSavings(); // חדש - הצגת חסכונות
                updateDebtPersonDropdowns();
                updateSavingSelects(); // חדש - עדכון רשימות החסכונות
                generateRecurringTransactions();
                
                console.log('All data loaded from Firebase successfully');
                
            } catch (error) {
                syncState.isSyncing = false;
                
                // עדכון סטטוס סנכרון
                updateSyncStatus(false);
                
                console.error('Error loading data from Firebase:', error);
                throw error; // מעביר את השגיאה הלאה כדי שפונקציית ההתחברות תוכל לטפל בה
            }
        }
        
        // פונקציה לוודא שכל הקטגוריות יש להן ID תקין
        function ensureCategoryIds() {
            let maxId = 0;
            
            // מציאת ה-ID הגבוה ביותר
            categories.forEach(category => {
                if (typeof category.id === 'number' && category.id > maxId) {
                    maxId = category.id;
                }
            });
            
            // תיקון קטגוריות ללא ID או עם ID לא תקין
            categories.forEach(category => {
                if (typeof category.id !== 'number' || isNaN(category.id)) {
                    maxId++;
                    category.id = maxId;
                    console.log('Fixed invalid category ID:', category);
                }
            });
        }
        
        // עדכון סטטוס סנכרון בממשק
        function updateSyncStatus(isConnected, customText = null) {
            const syncStatus = document.querySelector('.sync-status');
            if (!syncStatus) return;
            
            if (isConnected) {
                syncStatus.className = 'sync-status connected';
                syncStatus.textContent = customText ? customText : 'מסונכרן';
            } else {
                syncStatus.className = 'sync-status disconnected';
                syncStatus.textContent = 'לא מסונכרן';
            }
        }// הגדרת כל הפונקציות במרחב השמות הגלובלי
function addTransaction() {
    const date = document.getElementById('transaction-date').value;
    const type = document.getElementById('transaction-type').value;
    const categoryId = document.getElementById('transaction-category').value;
    const description = document.getElementById('transaction-description').value;
    const amount = parseFloat(document.getElementById('transaction-amount').value);
    
    // אמצעי תשלום - חדש
    let paymentMethod = '';
    if (type === 'expense') {
        paymentMethod = document.getElementById('payment-method').value;
    }
    
    if (!date || !description || isNaN(amount) || amount <= 0 || !categoryId) {
        alert('נא למלא את כל השדות בצורה תקינה');
        return;
    }
    
    // בדיקה שנבחר אמצעי תשלום עבור הוצאה
    if (type === 'expense' && !paymentMethod) {
        alert('נא לבחור אמצעי תשלום');
        return;
    }
    
    const isInstallments = document.getElementById('is-installments').value === 'yes' && type === 'expense';
    let installmentsInfo = null;
    
    if (isInstallments) {
        const totalInstallments = parseInt(document.getElementById('total-installments').value);
        const firstPaymentDate = document.getElementById('first-payment-date').value;
        
        if (isNaN(totalInstallments) || totalInstallments < 2 || !firstPaymentDate) {
            alert('נא להזין פרטי תשלומים תקינים');
            return;
        }
        
        installmentsInfo = {
            total: totalInstallments,
            current: 1,
            firstDate: firstPaymentDate,
            amountPerInstallment: (amount / totalInstallments).toFixed(2)
        };
        
        // הוספת כל התשלומים עם אמצעי התשלום - חדש
        addInstallmentTransactions(installmentsInfo, date, type, categoryId, description, amount, paymentMethod);
    } else {
        // הוספת עסקה רגילה עם אמצעי תשלום - חדש
        const transaction = {
            id: Date.now(),
            date: date,
            type: type,
            categoryId: categoryId,
            description: description,
            amount: amount,
            paymentMethod: type === 'expense' ? paymentMethod : '', // שמירת אמצעי תשלום רק עבור הוצאות
            installments: null
        };
        
        transactions.push(transaction);
        saveData();
        renderTransactions();
        renderBudgets(); // עדכון תצוגת התקציבים
    }
    
    // איפוס השדות
    document.getElementById('transaction-description').value = '';
    document.getElementById('transaction-amount').value = '';
    
    // שליחת אירוע לאנליטיקס של Firebase
    try {
        if (typeof analytics !== 'undefined') {
            analytics.logEvent('transaction_added', {
                transaction_type: type,
                transaction_amount: amount,
                payment_method: paymentMethod,
                is_installments: isInstallments
            });
        }
    } catch (error) {
        console.error('Analytics error:', error);
    }
}

function addInstallmentTransactions(installmentsInfo, originalDate, type, categoryId, description, totalAmount, paymentMethod) {
    const amountPerInstallment = parseFloat(installmentsInfo.amountPerInstallment);
    const baseId = Date.now();
    
    for (let i = 0; i < installmentsInfo.total; i++) {
        // חישוב תאריך התשלום
        const paymentDate = new Date(installmentsInfo.firstDate);
        paymentDate.setMonth(paymentDate.getMonth() + i);
        
        const formattedDate = paymentDate.toISOString().split('T')[0];
        
        const transaction = {
            id: baseId + i,
            date: formattedDate,
            type: type,
            categoryId: categoryId,
            description: description,
            amount: amountPerInstallment,
            paymentMethod: paymentMethod, // הוספת אמצעי תשלום
            installments: {
                total: installmentsInfo.total,
                current: i + 1,
                totalAmount: totalAmount
            }
        };
        
        transactions.push(transaction);
    }
    
    saveData();
    renderTransactions();
    renderBudgets(); // עדכון תצוגת התקציבים
    
    // שליחת אירוע לאנליטיקס של Firebase
    try {
        if (typeof analytics !== 'undefined') {
            analytics.logEvent('installment_transaction_added', {
                total_installments: installmentsInfo.total,
                total_amount: totalAmount,
                payment_method: paymentMethod
            });
        }
    } catch (error) {
        console.error('Analytics error:', error);
    }
}

function addRecurringExpense() {
    const description = document.getElementById('recurring-description').value;
    const categoryId = document.getElementById('recurring-category').value;
    const amount = parseFloat(document.getElementById('recurring-amount').value);
    const dayOfMonth = parseInt(document.getElementById('recurring-day').value);
    const startDate = document.getElementById('recurring-start-date').value;
    const endType = document.getElementById('recurring-end-type').value;
    
    // אמצעי תשלום - חדש
    const paymentMethod = document.getElementById('recurring-payment-method').value;
    
    if (!description || isNaN(amount) || amount <= 0 || !startDate || isNaN(dayOfMonth) || dayOfMonth < 1 || dayOfMonth > 31 || !categoryId || !paymentMethod) {
        alert('נא למלא את כל השדות בצורה תקינה');
        return;
    }
    
    let endDate = null;
    let occurrences = null;
    
    if (endType === 'date') {
        endDate = document.getElementById('recurring-end-date').value;
        if (!endDate) {
            alert('נא להזין תאריך סיום');
            return;
        }
    } else if (endType === 'occurrences') {
        occurrences = parseInt(document.getElementById('recurring-occurrences').value);
        if (isNaN(occurrences) || occurrences < 1) {
            alert('נא להזין מספר תשלומים תקין');
            return;
        }
    }
    
    const recurringExpense = {
        id: Date.now(),
        description: description,
        categoryId: categoryId,
        amount: amount,
        paymentMethod: paymentMethod, // אמצעי תשלום - חדש
        dayOfMonth: dayOfMonth,
        startDate: startDate,
        endType: endType,
        endDate: endDate,
        occurrences: occurrences,
        completedOccurrences: 0
    };
    
    recurringExpenses.push(recurringExpense);
    saveData();
    generateRecurringTransactions();
    renderRecurringExpenses();
    
    // איפוס השדות
    document.getElementById('recurring-description').value = '';
    document.getElementById('recurring-amount').value = '';
    
    // שליחת אירוע לאנליטיקס של Firebase
    try {
        if (typeof analytics !== 'undefined') {
            analytics.logEvent('recurring_expense_added', {
                amount: amount,
                end_type: endType,
                payment_method: paymentMethod
            });
        }
    } catch (error) {
        console.error('Analytics error:', error);
    }
}function generateRecurringTransactions() {
    // מחיקת עסקאות קבועות עתידיות
    transactions = transactions.filter(transaction => !transaction.isRecurring || new Date(transaction.date) <= new Date());
    
    const today = new Date();
    
    // בדיקת הוצאות קבועות ויצירת עסקאות עבורן
    recurringExpenses.forEach(expense => {
        const startDate = new Date(expense.startDate);
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();
        
        // ספירת מספר העסקאות שכבר נוצרו להוצאה זו - זה התיקון
        const existingTransactionsCount = transactions.filter(t => 
            t.isRecurring && t.recurringId === expense.id && 
            new Date(t.date) <= today
        ).length;
        
        // עדכון מספר התשלומים שכבר בוצעו
        expense.completedOccurrences = existingTransactionsCount;
        
        // בדיקה אם הושלמו כל התשלומים
        if (expense.endType === 'occurrences' && existingTransactionsCount >= expense.occurrences) {
            return; // דילוג על יצירת עסקאות נוספות
        }
        
        // יצירת עסקאות עד 6 חודשים קדימה
        for (let i = 0; i < 6; i++) {
            const targetMonth = (currentMonth + i) % 12;
            const targetYear = currentYear + Math.floor((currentMonth + i) / 12);
            
            // יצירת תאריך היעד - חישוב התאריך הקרוב ביותר לפי היום בחודש
            const targetDate = new Date(targetYear, targetMonth, expense.dayOfMonth);
            
            // בדיקה האם התאריך עדיין רלוונטי
            if (expense.endType === 'date' && new Date(expense.endDate) < targetDate) {
                continue;
            }
            
            // בדיקה שלא חרגנו ממספר התשלומים
            if (expense.endType === 'occurrences') {
                const potentialTransactionsCount = existingTransactionsCount + i;
                if (potentialTransactionsCount >= expense.occurrences) {
                    continue;
                }
            }
            
            // בדיקה האם יש כבר עסקה עבור חודש זה
            const existingTransaction = transactions.find(t => 
                t.isRecurring && 
                t.recurringId === expense.id && 
                new Date(t.date).getMonth() === targetMonth && 
                new Date(t.date).getFullYear() === targetYear
            );
            
            if (!existingTransaction && targetDate > startDate) {
                // יצירת עסקה חדשה
                const transaction = {
                    id: Date.now() + i,
                    date: targetDate.toISOString().split('T')[0],
                    type: 'expense',
                    categoryId: expense.categoryId,
                    description: expense.description,
                    amount: expense.amount,
                    paymentMethod: expense.paymentMethod,
                    installments: null,
                    isRecurring: true,
                    recurringId: expense.id
                };
                
                transactions.push(transaction);
            }
        }
    });
    
    saveData();
    renderTransactions();
    renderBudgets();
}



function deleteTransaction(id) {
    if (confirm('האם אתה בטוח שברצונך למחוק עסקה זו?')) {
        transactions = transactions.filter(transaction => transaction.id !== id);
        saveData();
        renderTransactions();
        renderBudgets();
        
        // שליחת אירוע לאנליטיקס של Firebase
        try {
            if (typeof analytics !== 'undefined') {
                analytics.logEvent('transaction_deleted');
            }
        } catch (error) {
            console.error('Analytics error:', error);
        }
    }
}

function deleteRecurringExpense(id) {
    if (confirm('האם אתה בטוח שברצונך למחוק הוצאה קבועה זו? פעולה זו תמחק גם את כל העסקאות העתידיות הקשורות להוצאה זו.')) {
        recurringExpenses = recurringExpenses.filter(expense => expense.id !== id);
        
        // מחיקת עסקאות עתידיות הקשורות להוצאה זו
        transactions = transactions.filter(transaction => 
            !transaction.isRecurring || 
            transaction.recurringId !== id || 
            new Date(transaction.date) <= new Date()
        );
        
        saveData();
        renderRecurringExpenses();
        renderTransactions();
        renderBudgets();
        
        // שליחת אירוע לאנליטיקס של Firebase
        try {
            if (typeof analytics !== 'undefined') {
                analytics.logEvent('recurring_expense_deleted');
            }
        } catch (error) {
            console.error('Analytics error:', error);
        }
    }
}

function filterTransactions() {
    const filterMonth = document.getElementById('filter-month').value;
    const filterYear = document.getElementById('filter-year').value;
    const filterType = document.getElementById('filter-type').value;
    const filterCategory = document.getElementById('filter-category').value;
    const filterPaymentMethod = document.getElementById('filter-payment-method').value; // אמצעי תשלום - חדש
    
    renderTransactions(filterMonth, filterYear, filterType, filterCategory, filterPaymentMethod);
    
    // שליחת אירוע לאנליטיקס של Firebase
    try {
        if (typeof analytics !== 'undefined') {
            analytics.logEvent('transaction_filter_applied', {
                month: filterMonth,
                year: filterYear,
                type: filterType,
                category: filterCategory,
                payment_method: filterPaymentMethod
            });
        }
    } catch (error) {
        console.error('Analytics error:', error);
    }
}function renderTransactions(filterMonth = 'all', filterYear = 'all', filterType = 'all', filterCategory = 'all', filterPaymentMethod = 'all') {
    const tableBody = document.getElementById('transactions-body');
    if (!tableBody) return;
    
    tableBody.innerHTML = '';
    
    // סינון עסקאות
    let filteredTransactions = [...transactions];
    
    if (filterMonth !== 'all') {
        filteredTransactions = filteredTransactions.filter(transaction => {
            const transactionDate = new Date(transaction.date);
            return transactionDate.getMonth() + 1 === parseInt(filterMonth);
        });
    }
    
    if (filterYear !== 'all') {
        filteredTransactions = filteredTransactions.filter(transaction => {
            const transactionDate = new Date(transaction.date);
            return transactionDate.getFullYear() === parseInt(filterYear);
        });
    }
    
    if (filterType !== 'all') {
        filteredTransactions = filteredTransactions.filter(transaction => transaction.type === filterType);
    }
    
    if (filterCategory !== 'all') {
        filteredTransactions = filteredTransactions.filter(transaction => transaction.categoryId === filterCategory);
    }
    
    // סינון לפי אמצעי תשלום - חדש
    if (filterPaymentMethod !== 'all') {
        filteredTransactions = filteredTransactions.filter(transaction => 
            transaction.paymentMethod === filterPaymentMethod && transaction.type === 'expense'
        );
    }
    
    // מיון עסקאות לפי תאריך (מהחדש לישן)
    filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // חישוב סיכומים
    let totalIncome = 0;
    let totalExpenses = 0;
    let totalCash = 0;
    let totalCredit = 0;
    
    // הצגת העסקאות
    filteredTransactions.forEach(transaction => {
        const row = document.createElement('tr');
        
        // עיצוב לפי סוג העסקה
        if (transaction.type === 'income') {
            row.classList.add('income');
            totalIncome += transaction.amount;
        } else {
            row.classList.add('expense');
            totalExpenses += transaction.amount;
            
            // סיכום לפי אמצעי תשלום - חדש
            if (transaction.paymentMethod === 'cash') {
                totalCash += transaction.amount;
            } else if (transaction.paymentMethod === 'credit') {
                totalCredit += transaction.amount;
            }
        }
        
        // פורמט התאריך
        const date = new Date(transaction.date);
        const formattedDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
        
        // מציאת שם הקטגוריה
        const category = categories.find(c => c.id === parseInt(transaction.categoryId)) || { name: 'לא מוגדרת' };
        
        // יצירת התא עם פרטי התשלומים
        let installmentsText = '';
        if (transaction.installments) {
            installmentsText = `תשלום ${transaction.installments.current}/${transaction.installments.total} מתוך ${transaction.installments.totalAmount.toFixed(2)} ₪`;
        } else if (transaction.isRecurring) {
            installmentsText = 'הוצאה קבועה';
        } else {
            installmentsText = '-';
        }
        
        // טקסט אמצעי תשלום - חדש
        let paymentMethodText = '';
        if (transaction.type === 'expense') {
            if (transaction.paymentMethod === 'cash') {
                paymentMethodText = '<span class="payment-method-cash">מזומן</span>';
            } else if (transaction.paymentMethod === 'credit') {
                paymentMethodText = '<span class="payment-method-credit">אשראי</span>';
            } else {
                paymentMethodText = 'לא צוין';
            }
        } else {
            paymentMethodText = '-'; // לא רלוונטי להכנסות
        }
        
        row.innerHTML = `
            <td>${formattedDate}</td>
            <td>${transaction.type === 'income' ? 'הכנסה' : 'הוצאה'}</td>
            <td>${category.name}</td>
            <td>${transaction.description}</td>
            <td>${transaction.amount.toFixed(2)} ₪</td>
            <td>${paymentMethodText}</td>
            <td>${installmentsText}</td>
            <td class="no-print">
                <button class="delete-btn" onclick="deleteTransaction(${transaction.id})">מחק</button>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
    
    // עדכון סיכומים
    const totalIncomeElement = document.getElementById('total-income');
    const totalExpensesElement = document.getElementById('total-expenses');
    const balanceElement = document.getElementById('balance');
    
    // עדכון סיכומי אמצעי תשלום - חדש
    const cashTotalElement = document.getElementById('cash-total');
    const creditTotalElement = document.getElementById('credit-total');
    
    if (totalIncomeElement) totalIncomeElement.textContent = `${totalIncome.toFixed(2)} ₪`;
    if (totalExpensesElement) totalExpensesElement.textContent = `${totalExpenses.toFixed(2)} ₪`;
    
    if (balanceElement) {
        const balance = totalIncome - totalExpenses;
        balanceElement.textContent = `${balance.toFixed(2)} ₪`;
        
        if (balance >= 0) {
            balanceElement.className = 'balance-positive';
        } else {
            balanceElement.className = 'balance-negative';
        }
    }
    
    // עדכון סיכומי אמצעי תשלום - חדש
    if (cashTotalElement) cashTotalElement.textContent = `${totalCash.toFixed(2)} ₪`;
    if (creditTotalElement) creditTotalElement.textContent = `${totalCredit.toFixed(2)} ₪`;
}

function renderRecurringExpenses() {
    const container = document.getElementById('recurring-items');
    if (!container) return;
    
    container.innerHTML = '';
    
    recurringExpenses.forEach(expense => {
        const item = document.createElement('div');
        item.className = 'recurring-item';
        
        // מציאת שם הקטגוריה
        const category = categories.find(c => c.id === parseInt(expense.categoryId)) || { name: 'לא מוגדרת' };
        
        // פורמט תאריך התחלה
        const startDate = new Date(expense.startDate);
        const formattedStartDate = `${startDate.getDate().toString().padStart(2, '0')}/${(startDate.getMonth() + 1).toString().padStart(2, '0')}/${startDate.getFullYear()}`;
        
        // פורמט מידע על סיום
        let endInfo = 'ללא הגבלה';
        if (expense.endType === 'date') {
            const endDate = new Date(expense.endDate);
            endInfo = `עד ${endDate.getDate().toString().padStart(2, '0')}/${(endDate.getMonth() + 1).toString().padStart(2, '0')}/${endDate.getFullYear()}`;
        } else if (expense.endType === 'occurrences') {
            endInfo = `${expense.completedOccurrences}/${expense.occurrences} תשלומים`;
        }
        
        // הצגת אמצעי תשלום - חדש
        let paymentMethodText = '';
        if (expense.paymentMethod === 'cash') {
            paymentMethodText = '<span class="payment-method-cash">מזומן</span>';
        } else if (expense.paymentMethod === 'credit') {
            paymentMethodText = '<span class="payment-method-credit">אשראי</span>';
        } else {
            paymentMethodText = 'לא צוין';
        }
        
        item.innerHTML = `
            <h3>${expense.description}</h3>
            <div class="recurring-details">
                <div class="recurring-detail">
                    <p><strong>קטגוריה</strong></p>
                    <p>${category.name}</p>
                </div>
                <div class="recurring-detail">
                    <p><strong>סכום</strong></p>
                    <p>${expense.amount.toFixed(2)} ₪</p>
                </div>
                <div class="recurring-detail">
                    <p><strong>אמצעי תשלום</strong></p>
                    <p>${paymentMethodText}</p>
                </div>
                <div class="recurring-detail">
                    <p><strong>יום בחודש</strong></p>
                    <p>${expense.dayOfMonth}</p>
                </div>
            </div>
            <div class="recurring-details">
                <div class="recurring-detail">
                    <p><strong>תאריך התחלה</strong></p>
                    <p>${formattedStartDate}</p>
                </div>
                <div class="recurring-detail">
                    <p><strong>סיום</strong></p>
                    <p>${endInfo}</p>
                </div>
            </div>
            <button class="delete-btn" onclick="deleteRecurringExpense(${expense.id})">מחק</button>
        `;
        
        container.appendChild(item);
    });
    
    // הוספת הודעה אם אין הוצאות קבועות
    if (recurringExpenses.length === 0) {
        const emptyMessage = document.createElement('div');
        emptyMessage.innerHTML = '<p>אין הוצאות קבועות כרגע. הוסף הוצאה קבועה חדשה כדי להתחיל.</p>';
        container.appendChild(emptyMessage);
    }
}function addCategory() {
    const categoryName = document.getElementById('new-category-name').value.trim();
    const categoryType = document.getElementById('new-category-type').value;
    
    if (!categoryName) {
        alert('נא להזין שם קטגוריה');
        return;
    }
    
    // בדיקה האם קטגוריה עם שם זהה כבר קיימת
    const categoryExists = categories.some(cat => cat.name.toLowerCase() === categoryName.toLowerCase());
    
    if (categoryExists) {
        alert('קטגוריה בשם זה כבר קיימת');
        return;
    }
    
    // יצירת קטגוריה חדשה
    const newCategory = {
        id: Date.now(),
        name: categoryName,
        type: categoryType
    };
    
    categories.push(newCategory);
    saveData();
    renderCategories();
    populateCategoryDropdowns();
    
    // איפוס שדה הקלט
    document.getElementById('new-category-name').value = '';
    
    // עדכון התצוגה בכל הלשוניות
    renderTransactions();
    renderRecurringExpenses();
    renderBudgets();
    
    // שליחת אירוע לאנליטיקס של Firebase
    try {
        if (typeof analytics !== 'undefined') {
            analytics.logEvent('category_added', {
                category_type: categoryType,
                category_name: categoryName
            });
        }
    } catch (error) {
        console.error('Analytics error:', error);
    }
}

function deleteCategory(categoryId) {
    // המרת ה-ID למספר כדי להבטיח השוואה נכונה
    const catId = parseInt(categoryId);
    
    // בדיקה האם הקטגוריה בשימוש בעסקאות
    const isUsedInTransactions = transactions.some(t => parseInt(t.categoryId) === catId);
    // בדיקה האם הקטגוריה בשימוש בהוצאות קבועות
    const isUsedInRecurring = recurringExpenses.some(r => parseInt(r.categoryId) === catId);
    // בדיקה האם הקטגוריה בשימוש בתקציבים
    const isUsedInBudgets = budgets.some(b => parseInt(b.categoryId) === catId);
    
    if (isUsedInTransactions || isUsedInRecurring || isUsedInBudgets) {
        alert('לא ניתן למחוק קטגוריה שנמצאת בשימוש בעסקאות, הוצאות קבועות או תקציבים');
        return;
    }
    
    if (confirm('האם אתה בטוח שברצונך למחוק קטגוריה זו?')) {
        categories = categories.filter(c => c.id !== catId);
        saveData();
        renderCategories();
        populateCategoryDropdowns();
        
        // עדכון התצוגה בכל הלשוניות
        renderTransactions();
        renderRecurringExpenses();
        renderBudgets();
        
        // שליחת אירוע לאנליטיקס של Firebase
        try {
            if (typeof analytics !== 'undefined') {
                analytics.logEvent('category_deleted');
            }
        } catch (error) {
            console.error('Analytics error:', error);
        }
    }
}

function editCategory(categoryId) {
    const category = categories.find(c => c.id === parseInt(categoryId));
    
    if (!category) {
        alert('קטגוריה לא נמצאה');
        return;
    }
    
    const newName = prompt('הזן שם חדש לקטגוריה:', category.name);
    
    if (newName && newName.trim() !== '') {
        // בדיקה האם השם החדש כבר קיים
        const nameExists = categories.some(c => c.id !== parseInt(categoryId) && c.name.toLowerCase() === newName.toLowerCase());
        
        if (nameExists) {
            alert('קטגוריה בשם זה כבר קיימת');
            return;
        }
        
        category.name = newName.trim();
        saveData();
        renderCategories();
        populateCategoryDropdowns();
        
        // עדכון התצוגה בכל הלשוניות
        renderTransactions();
        renderRecurringExpenses();
        renderBudgets();
        
        // שליחת אירוע לאנליטיקס של Firebase
        try {
            if (typeof analytics !== 'undefined') {
                analytics.logEvent('category_edited');
            }
        } catch (error) {
            console.error('Analytics error:', error);
        }
    }
}

function renderCategories() {
    const container = document.getElementById('categories-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    // סינון לפי בחירת המשתמש
    const filterType = document.getElementById('category-filter').value;
    let filteredCategories = categories;
    
    if (filterType !== 'all') {
        filteredCategories = categories.filter(c => c.type === filterType);
    }
    
    // מיון לפי שם
    filteredCategories.sort((a, b) => a.name.localeCompare(b.name));
    
    filteredCategories.forEach(category => {
        const categoryElement = document.createElement('div');
        categoryElement.className = 'category-item';
        
        let typeText = '';
        if (category.type === 'income') {
            typeText = 'הכנסות בלבד';
        } else if (category.type === 'expense') {
            typeText = 'הוצאות בלבד';
        } else {
            typeText = 'הכנסות והוצאות';
        }
        
        categoryElement.innerHTML = `
            <h3>${category.name}</h3>
            <p><strong>סוג:</strong> ${typeText}</p>
            <div>
                <button class="edit-btn" onclick="editCategory(${category.id})">ערוך</button>
                <button class="delete-btn" onclick="deleteCategory(${category.id})">מחק</button>
            </div>
        `;
        
        container.appendChild(categoryElement);
    });
}

function filterCategories() {
    renderCategories();
    
    // שליחת אירוע לאנליטיקס של Firebase
    try {
        if (typeof analytics !== 'undefined') {
            const filterType = document.getElementById('category-filter').value;
            analytics.logEvent('category_filter_applied', {
                filter_type: filterType
            });
        }
    } catch (error) {
        console.error('Analytics error:', error);
    }
}

function populateCategoryDropdowns() {
    // רשימת הסלקטורים שצריך למלא
    const selectors = [
        { id: 'transaction-category', type: 'dynamic' },
        { id: 'recurring-category', type: 'expense' },
        { id: 'filter-category', type: 'all' },
        { id: 'budget-category', type: 'expense' }
    ];
    
    selectors.forEach(selector => {
        const element = document.getElementById(selector.id);
        if (!element) return; // דילוג אם האלמנט לא קיים בדף
        
        element.innerHTML = '';
        
        // אם זה סלקט של פילטר, נוסיף אופציה של "הכל"
        if (selector.type === 'all') {
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'הכל';
            element.appendChild(allOption);
        }
        
        // סינון הקטגוריות הרלוונטיות בהתאם לסוג הסלקטור
        let relevantCategories = categories;
        
        if (selector.type === 'income') {
            relevantCategories = categories.filter(c => c.type === 'income' || c.type === 'both');
        } else if (selector.type === 'expense') {
            relevantCategories = categories.filter(c => c.type === 'expense' || c.type === 'both');
        } else if (selector.type === 'dynamic') {
            // בסלקטור דינמי, ההתנהגות תלויה בסוג העסקה (הכנסה/הוצאה)
            const transactionType = document.getElementById('transaction-type').value;
            if (transactionType === 'income') {
                relevantCategories = categories.filter(c => c.type === 'income' || c.type === 'both');
            } else {
                relevantCategories = categories.filter(c => c.type === 'expense' || c.type === 'both');
            }
        }
        
        // מיון לפי שם
        relevantCategories.sort((a, b) => a.name.localeCompare(b.name));
        
        // הוספת האפשרויות לסלקטור
        relevantCategories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            element.appendChild(option);
        });
    });
}function addBudget() {
    const categoryId = document.getElementById('budget-category').value;
    const amount = parseFloat(document.getElementById('budget-amount').value);
    const description = document.getElementById('budget-description').value;
    
    if (!categoryId || isNaN(amount) || amount <= 0) {
        alert('נא למלא את כל השדות בצורה תקינה');
        return;
    }
    
    // בדיקה אם כבר קיים תקציב לקטגוריה זו
    const existingBudget = budgets.find(b => parseInt(b.categoryId) === parseInt(categoryId));
    
    if (existingBudget) {
        if (confirm('כבר קיים תקציב לקטגוריה זו. האם לעדכן את התקציב הקיים?')) {
            existingBudget.amount = amount;
            existingBudget.description = description;
        } else {
            return;
        }
    } else {
        // יצירת תקציב חדש
        const budget = {
            id: Date.now(),
            categoryId: categoryId,
            amount: amount,
            description: description
        };
        
        budgets.push(budget);
    }
    
    saveData();
    renderBudgets();
    
    // איפוס השדות
    document.getElementById('budget-amount').value = '';
    document.getElementById('budget-description').value = '';
    
    // שליחת אירוע לאנליטיקס של Firebase
    try {
        if (typeof analytics !== 'undefined') {
            analytics.logEvent('budget_added_or_updated', {
                category_id: categoryId,
                amount: amount
            });
        }
    } catch (error) {
        console.error('Analytics error:', error);
    }
}

function addTotalBudget() {
    const amount = parseFloat(document.getElementById('total-budget-amount').value);
    const description = document.getElementById('total-budget-description').value;
    
    if (isNaN(amount) || amount <= 0) {
        alert('נא להזין סכום תקציב תקין');
        return;
    }
    
    totalBudget.amount = amount;
    totalBudget.description = description;
    
    saveData();
    renderBudgets();
    
    // איפוס השדות
    document.getElementById('total-budget-description').value = '';
    
    // שליחת אירוע לאנליטיקס של Firebase
    try {
        if (typeof analytics !== 'undefined') {
            analytics.logEvent('total_budget_set', {
                amount: amount
            });
        }
    } catch (error) {
        console.error('Analytics error:', error);
    }
}

function deleteBudget(budgetId) {
    if (confirm('האם אתה בטוח שברצונך למחוק תקציב זה?')) {
        budgets = budgets.filter(budget => budget.id !== budgetId);
        saveData();
        renderBudgets();
        
        // שליחת אירוע לאנליטיקס של Firebase
        try {
            if (typeof analytics !== 'undefined') {
                analytics.logEvent('budget_deleted');
            }
        } catch (error) {
            console.error('Analytics error:', error);
        }
    }
}

function renderBudgets() {
    const container = document.getElementById('budgets-container');
    const totalBudgetContainer = document.getElementById('total-budget-container');
    
    if (!container || !totalBudgetContainer) return;
    
    container.innerHTML = '';
    totalBudgetContainer.innerHTML = '';
    
    // קבלת חודש ושנה נבחרים
    const selectedMonth = parseInt(document.getElementById('budget-view-month').value);
    const selectedYear = parseInt(document.getElementById('budget-view-year').value);
    
    // חישוב הוצאות בפועל לחודש הנבחר
    const filteredTransactions = transactions.filter(transaction => {
        if (transaction.type !== 'expense') return false;
        
        const transactionDate = new Date(transaction.date);
        return (
            transactionDate.getMonth() + 1 === selectedMonth &&
            transactionDate.getFullYear() === selectedYear
        );
    });
    
    // חישוב סה"כ הוצאות בחודש הנבחר
    const totalMonthlyExpenses = filteredTransactions.reduce((sum, t) => sum + t.amount, 0);
    
    // הצגת תקציב כולל
    if (totalBudget.amount > 0) {
        const totalBudgetElement = document.createElement('div');
        totalBudgetElement.className = 'budget-item';
        
        // חישוב אחוז ניצול
        const usagePercentage = (totalMonthlyExpenses / totalBudget.amount) * 100;
        
        // קביעת צבע פס התקדמות לפי אחוז ניצול
        let progressClass = 'progress-under';
        if (usagePercentage >= 90 && usagePercentage < 100) {
            progressClass = 'progress-warning';
        } else if (usagePercentage >= 100) {
            progressClass = 'progress-over';
        }
        
        totalBudgetElement.innerHTML = `
            <h3>תקציב חודשי כולל</h3>
            <p><strong>סכום:</strong> ${totalBudget.amount.toFixed(2)} ₪</p>
            ${totalBudget.description ? `<p><strong>הערות:</strong> ${totalBudget.description}</p>` : ''}
            <p><strong>שימוש בפועל:</strong> ${totalMonthlyExpenses.toFixed(2)} ₪ (${usagePercentage.toFixed(1)}%)</p>
            <div class="progress-container">
                <div class="progress-bar ${progressClass}" style="width: ${Math.min(usagePercentage, 100)}%"></div>
            </div>
        `;
        
        totalBudgetContainer.appendChild(totalBudgetElement);
    } else {
        totalBudgetContainer.innerHTML = '<p>לא הוגדר תקציב חודשי כולל.</p>';
    }
    
    // הצגת תקציבים לפי קטגוריות
    if (budgets.length === 0) {
        container.innerHTML = '<p>לא הוגדרו תקציבים לקטגוריות.</p>';
        return;
    }
    
    // מיון תקציבים לפי שם קטגוריה
    const sortedBudgets = [...budgets].sort((a, b) => {
        const categoryA = categories.find(c => c.id === parseInt(a.categoryId)) || { name: '' };
        const categoryB = categories.find(c => c.id === parseInt(b.categoryId)) || { name: '' };
        return categoryA.name.localeCompare(categoryB.name);
    });
    
    sortedBudgets.forEach(budget => {
        const budgetElement = document.createElement('div');
        budgetElement.className = 'budget-item';
        
        // מציאת שם הקטגוריה
        const category = categories.find(c => c.id === parseInt(budget.categoryId)) || { name: 'לא מוגדרת' };
        
        // חישוב הוצאות בפועל לקטגוריה זו בחודש הנבחר
        const categoryExpenses = filteredTransactions
            .filter(t => parseInt(t.categoryId) === parseInt(budget.categoryId))
            .reduce((sum, t) => sum + t.amount, 0);
        
        // חישוב אחוז ניצול
        const usagePercentage = (categoryExpenses / budget.amount) * 100;
        
        // קביעת צבע פס התקדמות לפי אחוז ניצול
        let progressClass = 'progress-under';
        if (usagePercentage >= 90 && usagePercentage < 100) {
            progressClass = 'progress-warning';
        } else if (usagePercentage >= 100) {
            progressClass = 'progress-over';
        }
        
        budgetElement.innerHTML = `
            <h3>${category.name}</h3>
            <p><strong>סכום תקציב:</strong> ${budget.amount.toFixed(2)} ₪</p>
            ${budget.description ? `<p><strong>הערות:</strong> ${budget.description}</p>` : ''}
            <p><strong>שימוש בפועל:</strong> ${categoryExpenses.toFixed(2)} ₪ (${usagePercentage.toFixed(1)}%)</p>
            <div class="progress-container">
                <div class="progress-bar ${progressClass}" style="width: ${Math.min(usagePercentage, 100)}%"></div>
            </div>
            <button class="delete-btn" onclick="deleteBudget(${budget.id})">מחק</button>
        `;
        
        container.appendChild(budgetElement);
    });
}// פונקציה להוספת מאזינים (event listeners) לאלמנטים בממשק הדיאלוג של חובות
function setupDebtEventListeners() {
    // מאזין לכפתור הוספת חוב
    const addDebtButton = document.getElementById('add-debt');
    if (addDebtButton) {
        addDebtButton.addEventListener('click', addDebt);
    }
    
    // מאזין לכפתור עדכון חוב
    const updateDebtButton = document.getElementById('update-debt-btn');
    if (updateDebtButton) {
        updateDebtButton.addEventListener('click', updateDebt);
    }
    
    // מאזין לשינוי באדם שנבחר לעדכון
    const updateDebtPersonSelect = document.getElementById('update-debt-person');
    if (updateDebtPersonSelect) {
        updateDebtPersonSelect.addEventListener('change', showSelectedDebtInfo);
    }
    
    // מאזין לשינוי בסוג העדכון
    const updateDebtTypeSelect = document.getElementById('update-debt-type');
    if (updateDebtTypeSelect) {
        updateDebtTypeSelect.addEventListener('change', toggleAmountField);
    }
    
    // מאזין לפילטר סוג החוב
    const debtFilterSelect = document.getElementById('debt-filter');
    if (debtFilterSelect) {
        debtFilterSelect.addEventListener('change', renderDebts);
    }
    
    // מאזין לבחירת אדם להצגת היסטוריה
    const debtHistoryPersonSelect = document.getElementById('debt-history-person');
    if (debtHistoryPersonSelect) {
        debtHistoryPersonSelect.addEventListener('change', function() {
            const debtId = this.value;
            if (debtId) {
                renderDebtHistoryForPerson(debtId);
            } else {
                document.getElementById('debt-history-container').style.display = 'none';
            }
        });
    }
    
    // הגדרת תאריך ברירת מחדל להיום
    const today = new Date().toISOString().split('T')[0];
    const debtDateInput = document.getElementById('debt-date');
    const updateDebtDateInput = document.getElementById('update-debt-date');
    
    if (debtDateInput) debtDateInput.value = today;
    if (updateDebtDateInput) updateDebtDateInput.value = today;
}

// פונקציה להוספת חוב חדש
function addDebt() {
    const person = document.getElementById('debt-person').value.trim();
    const type = document.getElementById('debt-type').value;
    const amount = parseFloat(document.getElementById('debt-amount').value);
    const date = document.getElementById('debt-date').value;
    const description = document.getElementById('debt-description').value;
    
    if (!person || isNaN(amount) || amount <= 0 || !date) {
        alert('נא למלא את כל השדות בצורה תקינה');
        return;
    }
    
    // בדיקה אם כבר קיים חוב עם אותו אדם
    const existingDebtIndex = debts.findIndex(debt => 
        debt.person.toLowerCase() === person.toLowerCase() && debt.active
    );
    
    const newTransaction = {
        id: Date.now(),
        date: date,
        amount: amount,
        type: 'new',
        description: description || 'חוב חדש'
    };
    
    if (existingDebtIndex >= 0) {
        // יש כבר חוב פעיל לאדם זה - צריך לשאול אם לעדכן
        if (confirm(`כבר קיים חוב פעיל עם ${person}. האם להוסיף את החוב החדש לחוב הקיים?`)) {
            const existingDebt = debts[existingDebtIndex];
            
            // בדיקה אם יש התנגשות בסוגי החוב
            if (existingDebt.type !== type) {
                alert(`לא ניתן לאחד חובות בכיוונים הפוכים. החוב הקיים הוא "${existingDebt.type === 'they-owe-me' ? 'חייבים לי' : 'אני חייב'}" ואילו החוב החדש הוא "${type === 'they-owe-me' ? 'חייבים לי' : 'אני חייב'}"`);
                return;
            }
            
            // הוספת טרנזקציה חדשה להיסטוריה
            existingDebt.transactions.push(newTransaction);
            
            // עדכון סכום החוב
            existingDebt.amount += amount;
            
            // עדכון תאריך עדכון אחרון
            existingDebt.lastUpdated = date;
        } else {
            // המשתמש לא מעוניין לעדכן את החוב הקיים - מבטלים
            return;
        }
    } else {
        // אין חוב קיים - יוצרים חדש
        const newDebt = {
            id: Date.now(),
            person: person,
            type: type,
            amount: amount,
            createdAt: date,
            lastUpdated: date,
            active: true,
            transactions: [newTransaction]
        };
        
        debts.push(newDebt);
    }
    
    saveData();
    renderDebts();
    updateDebtPersonDropdowns();
    
    // איפוס שדות הטופס
    document.getElementById('debt-person').value = '';
    document.getElementById('debt-amount').value = '';
    document.getElementById('debt-description').value = '';
    
    // שליחת אירוע לאנליטיקס של Firebase
    try {
        if (typeof analytics !== 'undefined') {
            analytics.logEvent('debt_added', {
                debt_type: type,
                amount: amount
            });
        }
    } catch (error) {
        console.error('Analytics error:', error);
    }
}

// פונקציה לעדכון חוב קיים
function updateDebt() {
    const debtId = document.getElementById('update-debt-person').value;
    if (!debtId) {
        alert('נא לבחור אדם');
        return;
    }
    
    const updateType = document.getElementById('update-debt-type').value;
    const date = document.getElementById('update-debt-date').value;
    const description = document.getElementById('update-debt-description').value;
    
    // מציאת החוב המבוקש
    const debtIndex = debts.findIndex(debt => debt.id.toString() === debtId);
    if (debtIndex === -1) {
        alert('החוב לא נמצא');
        return;
    }
    
    const debt = debts[debtIndex];
    
    if (updateType === 'clear') {
        // סגירת חוב
        debt.active = false;
        debt.lastUpdated = date;
        
        debt.transactions.push({
            id: Date.now(),
            date: date,
            amount: debt.amount,
            type: 'clear',
            description: description || 'סגירת חוב'
        });
        
        // איפוס סכום החוב
        debt.amount = 0;
    } else {
        // עדכון סכום החוב (הגדלה או הקטנה)
        const amount = parseFloat(document.getElementById('update-debt-amount').value);
        
        if (isNaN(amount) || amount <= 0) {
            alert('נא להזין סכום תקין');
            return;
        }
        
        // הוספת טרנזקציה חדשה להיסטוריה
        debt.transactions.push({
            id: Date.now(),
            date: date,
            amount: amount,
            type: updateType,
            description: description || (updateType === 'increase' ? 'הגדלת חוב' : 'הקטנת חוב')
        });
        
        // עדכון סכום החוב
        if (updateType === 'increase') {
            debt.amount += amount;
        } else if (updateType === 'decrease') {
            // וידוא שהסכום לא גדול מהחוב הקיים
            if (amount > debt.amount) {
                const confirmOverpay = confirm('סכום ההקטנה גדול מהחוב הקיים. האם ברצונך לסגור את החוב?');
                if (confirmOverpay) {
                    debt.amount = 0;
                    debt.active = false;
                } else {
                    debt.amount = 0;
                }
            } else {
                debt.amount -= amount;
                
                // אם החוב ירד ל-0, מסמנים אותו כלא פעיל
                if (debt.amount === 0) {
                    debt.active = false;
                }
            }
        }
        
        // עדכון תאריך עדכון אחרון
        debt.lastUpdated = date;
    }
    
    saveData();
    renderDebts();
    updateDebtPersonDropdowns();
    
    // איפוס אזור העדכון
    document.getElementById('update-debt-person').value = '';
    document.getElementById('update-debt-info').style.display = 'none';
    document.getElementById('update-debt-description').value = '';
    document.getElementById('update-debt-amount').value = '';
    
    // שליחת אירוע לאנליטיקס של Firebase
    try {
        if (typeof analytics !== 'undefined') {
            analytics.logEvent('debt_updated', {
                update_type: updateType
            });
        }
    } catch (error) {
        console.error('Analytics error:', error);}
}

// פונקציה להצגת מידע על חוב נבחר
function showSelectedDebtInfo() {
    const debtId = document.getElementById('update-debt-person').value;
    const updateDebtInfo = document.getElementById('update-debt-info');
    
    if (!debtId) {
        updateDebtInfo.style.display = 'none';
        return;
    }
    
    // מציאת החוב המבוקש
    const debt = debts.find(debt => debt.id.toString() === debtId);
    if (!debt) {
        alert('החוב לא נמצא');
        updateDebtInfo.style.display = 'none';
        return;
    }
    
    // הצגת מידע על החוב
    const debtStatus = document.getElementById('debt-current-status');
    const debtAmount = document.getElementById('debt-current-amount');
    
    debtStatus.textContent = debt.type === 'they-owe-me' ? 'חייבים לי' : 'אני חייב';
    debtAmount.textContent = `₪${debt.amount.toFixed(2)}`;
    
    // הצגת טופס העדכון
    updateDebtInfo.style.display = 'block';
    
    // בדיקה אם סגירת חוב אמורה להסתיר את שדה הסכום
    toggleAmountField();
}

// פונקציה להסתרה/הצגה של שדה הסכום בהתאם לסוג העדכון
function toggleAmountField() {
    const updateType = document.getElementById('update-debt-type').value;
    const amountGroup = document.getElementById('update-amount-group');
    
    if (updateType === 'clear') {
        amountGroup.style.display = 'none';
    } else {
        amountGroup.style.display = 'block';
    }
}

// פונקציה לרענון רשימות האנשים בדרופדאונים של החובות
function updateDebtPersonDropdowns() {
    // סלקטור לעדכון חוב
    const updateDebtPersonSelect = document.getElementById('update-debt-person');
    // סלקטור להיסטוריית חוב
    const debtHistoryPersonSelect = document.getElementById('debt-history-person');
    
    if (!updateDebtPersonSelect || !debtHistoryPersonSelect) return;
    
    // איפוס הסלקטורים
    updateDebtPersonSelect.innerHTML = '';
    debtHistoryPersonSelect.innerHTML = '';
    
    // הוספת אופציה ריקה
    const emptyOption1 = document.createElement('option');
    emptyOption1.value = '';
    emptyOption1.textContent = '-- בחר אדם --';
    updateDebtPersonSelect.appendChild(emptyOption1);
    
    const emptyOption2 = document.createElement('option');
    emptyOption2.value = '';
    emptyOption2.textContent = '-- בחר אדם --';
    debtHistoryPersonSelect.appendChild(emptyOption2);
    
    // הוספת כל האנשים עם חובות פעילים לסלקטור העדכון
    const activeDebtors = debts.filter(debt => debt.active);
    activeDebtors.sort((a, b) => a.person.localeCompare(b.person)).forEach(debt => {
        const option = document.createElement('option');
        option.value = debt.id;
        option.textContent = debt.person;
        updateDebtPersonSelect.appendChild(option);
    });
    
    // הוספת כל האנשים עם חובות (פעילים ולא פעילים) לסלקטור ההיסטוריה
    const allDebtors = [...new Set(debts.map(debt => debt.person))];
    allDebtors.sort().forEach(person => {
        // מציאת החוב האחרון (פעיל או לא) עבור האדם
        const personDebt = debts.filter(d => d.person === person)
            .sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated))[0];
        
        if (personDebt) {
            const option = document.createElement('option');
            option.value = personDebt.id;
            option.textContent = person;
            debtHistoryPersonSelect.appendChild(option);
        }
    });
}

// פונקציה להצגת היסטוריית חוב עבור אדם מסוים
function renderDebtHistoryForPerson(debtId) {
    const container = document.getElementById('debt-history-container');
    if (!container) return;
    
    // מציאת החוב המבוקש
    const debt = debts.find(d => d.id.toString() === debtId);
    if (!debt) {
        container.innerHTML = '<p>החוב לא נמצא.</p>';
        container.style.display = 'block';
        return;
    }
    
    // מיון עסקאות לפי תאריך (מהחדש לישן)
    const sortedTransactions = [...debt.transactions].sort((a, b) => 
        new Date(b.date) - new Date(a.date)
    );
    
    // בניית טבלת היסטוריה
    let historyHtml = `
        <h4>היסטוריית חוב: ${debt.person}</h4>
        <table>
            <thead>
                <tr>
                    <th>תאריך</th>
                    <th>סוג פעולה</th>
                    <th>סכום</th>
                    <th>תיאור</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    sortedTransactions.forEach(transaction => {
        // קביעת מחלקת עיצוב לפי סוג העסקה
        let transactionClass = '';
        let actionText = '';
        
        switch (transaction.type) {
            case 'new':
                transactionClass = 'new-debt';
                actionText = 'חוב חדש';
                break;
            case 'increase':
                transactionClass = 'increase-debt';
                actionText = 'הגדלת חוב';
                break;
            case 'decrease':
                transactionClass = 'decrease-debt';
                actionText = 'הקטנת חוב';
                break;
            case 'clear':
                transactionClass = 'clear-debt';
                actionText = 'סגירת חוב';
                break;
        }
        
        // פורמט התאריך
        const date = new Date(transaction.date);
        const formattedDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
        
        historyHtml += `
            <tr class="${transactionClass}">
                <td>${formattedDate}</td>
                <td>${actionText}</td>
                <td>${transaction.amount.toFixed(2)} ₪</td>
                <td>${transaction.description}</td>
            </tr>
        `;
    });
    
    historyHtml += `
            </tbody>
        </table>
    `;
    
    container.innerHTML = historyHtml;
    container.style.display = 'block';
}

// פונקציה להצגת כל החובות הפעילים
function renderDebts() {
    const container = document.getElementById('active-debts');
    if (!container) return;
    
    container.innerHTML = '';
    
    // סינון חובות לפי הפילטר
    const filterType = document.getElementById('debt-filter').value;
    let filteredDebts = debts.filter(debt => debt.active);
    
    if (filterType !== 'all') {
        filteredDebts = filteredDebts.filter(debt => debt.type === filterType);
    }
    
    // חישוב סיכומים
    let totalOwedToMe = 0;
    let totalIOwe = 0;
    
    debts.filter(debt => debt.active).forEach(debt => {
        if (debt.type === 'they-owe-me') {
            totalOwedToMe += debt.amount;
        } else {
            totalIOwe += debt.amount;
        }
    });
    
    // עדכון תצוגת הסיכומים
    document.getElementById('total-debt-owed-to-me').textContent = `₪${totalOwedToMe.toFixed(2)}`;
    document.getElementById('total-debt-i-owe').textContent = `₪${totalIOwe.toFixed(2)}`;
    
    // עדכון המאזן
    const balance = totalOwedToMe - totalIOwe;
    const balanceElement = document.getElementById('debt-balance');
    
    balanceElement.textContent = `₪${balance.toFixed(2)}`;
    if (balance >= 0) {
        balanceElement.className = 'balance-positive';
    } else {
        balanceElement.className = 'balance-negative';
    }
    
    // אם אין חובות פעילים, מציגים הודעה
    if (filteredDebts.length === 0) {
        container.innerHTML = '<p>אין חובות פעילים.</p>';
        return;
    }
    
    // מיון חובות לפי שם
    filteredDebts.sort((a, b) => a.person.localeCompare(b.person)).forEach(debt => {
        const debtElement = document.createElement('div');
        debtElement.className = 'recurring-item';
        
        // פורמט תאריך יצירה
        const createdDate = new Date(debt.createdAt);
        const formattedCreatedDate = `${createdDate.getDate().toString().padStart(2, '0')}/${(createdDate.getMonth() + 1).toString().padStart(2, '0')}/${createdDate.getFullYear()}`;
        
        // פורמט תאריך עדכון אחרון
        const lastUpdateDate = new Date(debt.lastUpdated);
        const formattedLastUpdateDate = `${lastUpdateDate.getDate().toString().padStart(2, '0')}/${(lastUpdateDate.getMonth() + 1).toString().padStart(2, '0')}/${lastUpdateDate.getFullYear()}`;
        
        debtElement.innerHTML = `
            <h3>${debt.person}</h3>
            <div class="recurring-details">
                <div class="recurring-detail">
                    <p><strong>סוג</strong></p>
                    <p>${debt.type === 'they-owe-me' ? 'חייבים לי' : 'אני חייב'}</p>
                </div>
                <div class="recurring-detail">
                    <p><strong>סכום</strong></p>
                    <p>${debt.amount.toFixed(2)} ₪</p>
                </div>
                <div class="recurring-detail">
                    <p><strong>תאריך יצירה</strong></p>
                    <p>${formattedCreatedDate}</p>
                </div>
                <div class="recurring-detail">
                    <p><strong>עדכון אחרון</strong></p>
                    <p>${formattedLastUpdateDate}</p>
                </div>
            </div>
        `;
        
        container.appendChild(debtElement);
    });
}// פונקציה להוספת מאזינים (event listeners) לאלמנטים בממשק הדיאלוג של חסכונות (חדש)
function setupSavingEventListeners() {
    // מאזין לכפתור הוספת חסכון
    const addSavingButton = document.getElementById('add-saving');
    if (addSavingButton) {
        addSavingButton.addEventListener('click', addSaving);
    }
    
    // מאזין לכפתור הוספת פעולה לחסכון
    const addSavingTransactionButton = document.getElementById('add-saving-transaction');
    if (addSavingTransactionButton) {
        addSavingTransactionButton.addEventListener('click', addSavingTransaction);
    }
    
    // מאזין לשינוי בחסכון שנבחר לעדכון
    const updateSavingIdSelect = document.getElementById('update-saving-id');
    if (updateSavingIdSelect) {
        updateSavingIdSelect.addEventListener('change', showSelectedSavingInfo);
    }
    
    // מאזין לבחירת חסכון להצגת היסטוריה
    const savingHistoryIdSelect = document.getElementById('saving-history-id');
    if (savingHistoryIdSelect) {
        savingHistoryIdSelect.addEventListener('change', function() {
            const savingId = this.value;
            if (savingId) {
                renderSavingHistoryForSaving(savingId);
            } else {
                document.getElementById('saving-history-container').style.display = 'none';
            }
        });
    }
    
    // הגדרת תאריכים ברירת מחדל להיום
    const today = new Date().toISOString().split('T')[0];
    const savingStartDateInput = document.getElementById('saving-start-date');
    const savingTransactionDateInput = document.getElementById('saving-transaction-date');
    
    if (savingStartDateInput) savingStartDateInput.value = today;
    if (savingTransactionDateInput) savingTransactionDateInput.value = today;
}

// פונקציה להוספת חסכון חדש
function addSaving() {
    const name = document.getElementById('saving-name').value.trim();
    const type = document.getElementById('saving-type').value;
    const startAmount = parseFloat(document.getElementById('saving-start-amount').value) || 0;
    const targetAmount = parseFloat(document.getElementById('saving-target-amount').value) || 0;
    const interest = parseFloat(document.getElementById('saving-interest').value) || 0;
    const startDate = document.getElementById('saving-start-date').value;
    const endDate = document.getElementById('saving-end-date').value || null;
    const description = document.getElementById('saving-description').value || '';
    
    if (!name || startAmount < 0) {
        alert('נא למלא לפחות שם חסכון וסכום התחלתי תקין');
        return;
    }
    
    // בדיקה אם כבר קיים חסכון עם אותו שם
    const existsSaving = savings.some(s => s.name.toLowerCase() === name.toLowerCase());
    if (existsSaving) {
        alert('חסכון בשם זה כבר קיים');
        return;
    }
    
    // יצירת חסכון חדש
    const newSaving = {
        id: Date.now(),
        name: name,
        type: type,
        startAmount: startAmount,
        currentAmount: startAmount,
        targetAmount: targetAmount,
        interest: interest,
        startDate: startDate,
        endDate: endDate,
        description: description,
        transactions: []
    };
    
    // אם יש סכום התחלתי, נוסיף טרנזקציה ראשונית
    if (startAmount > 0) {
        newSaving.transactions.push({
            id: Date.now(),
            date: startDate,
            type: 'deposit',
            amount: startAmount,
            description: 'הפקדה ראשונית'
        });
    }
    
    // הוספה למערך החסכונות
    savings.push(newSaving);
    saveData();
    renderSavings();
    updateSavingSelects();
    
    // איפוס הטופס
    document.getElementById('saving-name').value = '';
    document.getElementById('saving-start-amount').value = '';
    document.getElementById('saving-target-amount').value = '';
    document.getElementById('saving-interest').value = '';
    document.getElementById('saving-description').value = '';
    
    // שליחת אירוע לאנליטיקס של Firebase
    try {
        if (typeof analytics !== 'undefined') {
            analytics.logEvent('saving_added', {
                saving_type: type,
                start_amount: startAmount,
                target_amount: targetAmount
            });
        }
    } catch (error) {
        console.error('Analytics error:', error);
    }
}

// פונקציה להוספת פעולה לחסכון קיים
function addSavingTransaction() {
    const savingId = document.getElementById('update-saving-id').value;
    const transactionType = document.getElementById('saving-transaction-type').value;
    const amount = parseFloat(document.getElementById('saving-transaction-amount').value);
    const date = document.getElementById('saving-transaction-date').value;
    const description = document.getElementById('saving-transaction-description').value || '';
    
    if (!savingId || isNaN(amount) || amount <= 0 || !date) {
        alert('נא למלא את כל השדות בצורה תקינה');
        return;
    }
    
    // מציאת החסכון המבוקש
    const savingIndex = savings.findIndex(s => s.id.toString() === savingId);
    if (savingIndex === -1) {
        alert('החסכון לא נמצא');
        return;
    }
    
    const saving = savings[savingIndex];
    
    // בדיקה במקרה של משיכה שהסכום לא גדול מהיתרה
    if (transactionType === 'withdraw' && amount > saving.currentAmount) {
        alert('לא ניתן למשוך סכום גדול מהיתרה הקיימת');
        return;
    }
    
    // יצירת הטרנזקציה החדשה
    const newTransaction = {
        id: Date.now(),
        date: date,
        type: transactionType,
        amount: amount,
        description: description || (transactionType === 'deposit' ? 'הפקדה' : 'משיכה')
    };
    
    // הוספת הטרנזקציה להיסטוריה
    saving.transactions.push(newTransaction);
    
    // עדכון הסכום הנוכחי
    if (transactionType === 'deposit') {
        saving.currentAmount += amount;
    } else {
        saving.currentAmount -= amount;
    }
    
    saveData();
    renderSavings();
    
    // איפוס שדות הטופס
    document.getElementById('saving-transaction-amount').value = '';
    document.getElementById('saving-transaction-description').value = '';
    
    // עדכון תצוגת המידע על החסכון
    showSelectedSavingInfo();
    
    // שליחת אירוע לאנליטיקס של Firebase
    try {
        if (typeof analytics !== 'undefined') {
            analytics.logEvent('saving_transaction_added', {
                transaction_type: transactionType,
                amount: amount,
                saving_name: saving.name
            });
        }
    } catch (error) {
        console.error('Analytics error:', error);
    }
}

// פונקציה להצגת מידע על חסכון נבחר
function showSelectedSavingInfo() {
    const savingId = document.getElementById('update-saving-id').value;
    const updateSavingForm = document.getElementById('update-saving-form');
    
    if (!savingId) {
        updateSavingForm.style.display = 'none';
        return;
    }
    
    // מציאת החסכון המבוקש
    const saving = savings.find(s => s.id.toString() === savingId);
    if (!saving) {
        alert('החסכון לא נמצא');
        updateSavingForm.style.display = 'none';
        return;
    }
    
    // הצגת מידע נוכחי
    const currentBalanceElement = document.getElementById('saving-current-balance');
    const goalAmountElement = document.getElementById('saving-goal-amount');
    
    currentBalanceElement.textContent = `₪${saving.currentAmount.toFixed(2)}`;
    goalAmountElement.textContent = saving.targetAmount > 0 ? `₪${saving.targetAmount.toFixed(2)}` : 'לא הוגדר';
    
    // הצגת טופס העדכון
    updateSavingForm.style.display = 'block';
}

// פונקציה לעדכון רשימות החסכונות בדרופדאונים
function updateSavingSelects() {
    // סלקטור לעדכון חסכון
    const updateSavingIdSelect = document.getElementById('update-saving-id');
    // סלקטור להיסטוריית חסכון
    const savingHistoryIdSelect = document.getElementById('saving-history-id');
    
    if (!updateSavingIdSelect || !savingHistoryIdSelect) return;
    
    // איפוס הסלקטורים
    updateSavingIdSelect.innerHTML = '';
    savingHistoryIdSelect.innerHTML = '';
    
    // הוספת אופציה ריקה
    const emptyOption1 = document.createElement('option');
    emptyOption1.value = '';
    emptyOption1.textContent = '-- בחר חסכון --';
    updateSavingIdSelect.appendChild(emptyOption1);
    
    const emptyOption2 = document.createElement('option');
    emptyOption2.value = '';
    emptyOption2.textContent = '-- בחר חסכון --';
    savingHistoryIdSelect.appendChild(emptyOption2);
    
    // מיון חסכונות לפי שם
    const sortedSavings = [...savings].sort((a, b) => a.name.localeCompare(b.name));
    
    // הוספת כל החסכונות לסלקטורים
    sortedSavings.forEach(saving => {
        // לסלקטור העדכון
        const option1 = document.createElement('option');
        option1.value = saving.id;
        option1.textContent = saving.name;
        updateSavingIdSelect.appendChild(option1);
        
        // לסלקטור ההיסטוריה
        const option2 = document.createElement('option');
        option2.value = saving.id;
        option2.textContent = saving.name;
        savingHistoryIdSelect.appendChild(option2);
    });
}

// פונקציה להצגת חסכונות
function renderSavings() {
    const container = document.getElementById('savings-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    // חישוב סיכומים
    let totalSavingsAmount = 0;
    let totalTargetAmount = 0;
    
    savings.forEach(saving => {
        totalSavingsAmount += saving.currentAmount;
        
        if (saving.targetAmount > 0) {
            totalTargetAmount += saving.targetAmount;
        }
    });
    
    // עדכון אלמנטים בתצוגה
    const totalSavingsElement = document.getElementById('total-savings');
    const totalGoalsElement = document.getElementById('total-savings-goals');
    const totalProgressElement = document.getElementById('total-savings-progress');
    
    if (totalSavingsElement) totalSavingsElement.textContent = `₪${totalSavingsAmount.toFixed(2)}`;
    if (totalGoalsElement) totalGoalsElement.textContent = totalTargetAmount > 0 ? `₪${totalTargetAmount.toFixed(2)}` : '₪0.00';
    
    // חישוב אחוז המימוש הכולל
    if (totalProgressElement) {
        if (totalTargetAmount > 0) {
            const progress = (totalSavingsAmount / totalTargetAmount) * 100;
            totalProgressElement.textContent = `${progress.toFixed(1)}%`;
        } else {
            totalProgressElement.textContent = '0%';
        }
    }
    
    // הצגת כל החסכונות
    if (savings.length === 0) {
        container.innerHTML = '<p>אין חסכונות. צור חסכון חדש כדי להתחיל.</p>';
        return;
    }
    
    // מיון חסכונות לפי שם
    const sortedSavings = [...savings].sort((a, b) => a.name.localeCompare(b.name));
    
    sortedSavings.forEach(saving => {
        const savingElement = document.createElement('div');
        savingElement.className = `saving-item saving-type-${saving.type}`;
        
        // חישוב אחוז מימוש היעד
        let progressPercentage = 0;
        if (saving.targetAmount > 0) {
            progressPercentage = (saving.currentAmount / saving.targetAmount) * 100;
        }
        
        // פורמט תאריך התחלה
        const startDate = new Date(saving.startDate);
        const formattedStartDate = `${startDate.getDate().toString().padStart(2, '0')}/${(startDate.getMonth() + 1).toString().padStart(2, '0')}/${startDate.getFullYear()}`;
        
        // פורמט תאריך יעד (אם קיים)
        let formattedEndDate = 'לא הוגדר';
        if (saving.endDate) {
            const endDate = new Date(saving.endDate);
            formattedEndDate = `${endDate.getDate().toString().padStart(2, '0')}/${(endDate.getMonth() + 1).toString().padStart(2, '0')}/${endDate.getFullYear()}`;
        }
        
        // טקסט סוג החסכון
        let typeText = '';
        switch (saving.type) {
            case 'regular': typeText = 'חסכון רגיל'; break;
            case 'pension': typeText = 'פנסיה'; break;
            case 'education': typeText = 'חסכון לחינוך'; break;
            case 'emergency': typeText = 'קרן חירום'; break;
            case 'investment': typeText = 'השקעה'; break;
            case 'other': typeText = 'אחר'; break;
            default: typeText = 'חסכון רגיל';
        }
        
        savingElement.innerHTML = `
            <h3>${saving.name}</h3>
            <div class="recurring-details">
                <div class="recurring-detail">
                    <p><strong>סוג</strong></p>
                    <p>${typeText}</p>
                </div>
                <div class="recurring-detail">
                    <p><strong>סכום נוכחי</strong></p>
                    <p>${saving.currentAmount.toFixed(2)} ₪</p>
                </div>
                <div class="recurring-detail">
                    <p><strong>סכום יעד</strong></p>
                    <p>${saving.targetAmount > 0 ? saving.targetAmount.toFixed(2) + ' ₪' : 'לא הוגדר'}</p>
                </div>
                <div class="recurring-detail">
                    <p><strong>ריבית שנתית</strong></p>
                    <p>${saving.interest > 0 ? saving.interest.toFixed(2) + '%' : '0%'}</p>
                </div>
            </div>
            <div class="recurring-details">
                <div class="recurring-detail">
                    <p><strong>תאריך התחלה</strong></p>
                    <p>${formattedStartDate}</p>
                </div>
                <div class="recurring-detail">
                    <p><strong>תאריך יעד</strong></p>
                    <p>${formattedEndDate}</p>
                </div>
            </div>
            ${saving.description ? `<p><strong>הערות:</strong> ${saving.description}</p>` : ''}
        `;
        
        // הוספת פס התקדמות אם יש יעד
        if (saving.targetAmount > 0) {
            savingElement.innerHTML += `
                <p><strong>התקדמות:</strong> ${progressPercentage.toFixed(1)}%</p>
                <div class="saving-progress-container">
                    <div class="saving-progress-bar" style="width: ${Math.min(progressPercentage, 100)}%"></div>
                </div>
            `;
        }
        
        // הוספת כפתור מחיקה
        savingElement.innerHTML += `
            <button class="delete-btn" onclick="deleteSaving(${saving.id})">מחק</button>
        `;
        
        container.appendChild(savingElement);
    });
}// פונקציה למחיקת חסכון
function deleteSaving(savingId) {
    if (confirm('האם אתה בטוח שברצונך למחוק חסכון זה? כל ההיסטוריה תימחק.')) {
        savings = savings.filter(s => s.id !== savingId);
        saveData();
        renderSavings();
        updateSavingSelects();
        
        // שליחת אירוע לאנליטיקס של Firebase
        try {
            if (typeof analytics !== 'undefined') {
                analytics.logEvent('saving_deleted');
            }
        } catch (error) {
            console.error('Analytics error:', error);
        }
    }
}

// פונקציה להצגת היסטוריית חסכון
function renderSavingHistoryForSaving(savingId) {
    const container = document.getElementById('saving-history-container');
    if (!container) return;
    
    // מציאת החסכון המבוקש
    const saving = savings.find(s => s.id.toString() === savingId);
    if (!saving) {
        container.innerHTML = '<p>החסכון לא נמצא.</p>';
        container.style.display = 'block';
        return;
    }
    
    // בדיקה אם יש טרנזקציות
    if (!saving.transactions || saving.transactions.length === 0) {
        container.innerHTML = '<p>אין היסטוריית פעולות לחסכון זה.</p>';
        container.style.display = 'block';
        return;
    }
    
    // מיון טרנזקציות לפי תאריך (מהחדש לישן)
    const sortedTransactions = [...saving.transactions].sort((a, b) => 
        new Date(b.date) - new Date(a.date)
    );
    
    // בניית טבלת היסטוריה
    let historyHtml = `
        <h4>היסטוריית פעולות: ${saving.name}</h4>
        <table>
            <thead>
                <tr>
                    <th>תאריך</th>
                    <th>סוג פעולה</th>
                    <th>סכום</th>
                    <th>תיאור</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    sortedTransactions.forEach(transaction => {
        // קביעת מחלקת עיצוב לפי סוג העסקה
        const transactionClass = transaction.type === 'deposit' ? 'saving-transaction-deposit' : 'saving-transaction-withdraw';
        const actionText = transaction.type === 'deposit' ? 'הפקדה' : 'משיכה';
        
        // פורמט התאריך
        const date = new Date(transaction.date);
        const formattedDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
        
        historyHtml += `
            <tr class="${transactionClass}">
                <td>${formattedDate}</td>
                <td>${actionText}</td>
                <td>${transaction.amount.toFixed(2)} ₪</td>
                <td>${transaction.description}</td>
            </tr>
        `;
    });
    
    historyHtml += `
            </tbody>
        </table>
    `;
    
    container.innerHTML = historyHtml;
    container.style.display = 'block';
}// ===== קוד הסטטיסטיקות החדש =====

// מערך לאחסון גרפים
let statisticsCharts = {
    categoryChart: null,
    paymentChart: null, 
    trendChart: null,
    monthlyChart: null,
    dayChart: null,
    comparisonChart: null
};

// פונקציה להפקת סטטיסטיקות
function generateStatistics() {
    // קבלת תקופת הסטטיסטיקות
    const period = document.getElementById('stats-period').value;
    
    // קביעת תאריכי התחלה וסיום
    let startDate, endDate;
    const today = new Date();
    endDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    
    switch (period) {
        case 'month':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            break;
        case 'last-month':
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            endDate = new Date(today.getFullYear(), today.getMonth(), 0);
            break;
        case '3-months':
            startDate = new Date(today.getFullYear(), today.getMonth() - 3, 1);
            break;
        case '6-months':
            startDate = new Date(today.getFullYear(), today.getMonth() - 6, 1);
            break;
        case 'year':
            startDate = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
            break;
        case 'custom':
            startDate = new Date(document.getElementById('stats-start-date').value);
            endDate = new Date(document.getElementById('stats-end-date').value);
            break;
        case 'all':
        default:
            // מציאת העסקה המוקדמת ביותר
            if (transactions.length > 0) {
                const dates = transactions.map(t => new Date(t.date));
                startDate = new Date(Math.min(...dates));
            } else {
                startDate = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
            }
            break;
    }
    
    // סינון העסקאות הרלוונטיות
    const relevantTransactions = transactions.filter(transaction => {
        const transactionDate = new Date(transaction.date);
        return transactionDate >= startDate && transactionDate <= endDate;
    });
    
    // עדכון סיכומים
    updateStatisticsSummary(relevantTransactions, startDate, endDate);
    
    // יצירת גרפים
    createCategoryChart(relevantTransactions);
    createPaymentMethodChart(relevantTransactions);
    createIncomeExpensesTrendChart(relevantTransactions, startDate, endDate);
    createMonthlyExpensesChart(relevantTransactions);
    createDayOfWeekExpensesChart(relevantTransactions);
    createMonthComparisonChart(relevantTransactions);
    
    // ניתוח תובנות
    generateInsights(relevantTransactions, startDate, endDate);
    
    // שליחת אירוע לאנליטיקס של Firebase
    try {
        if (typeof analytics !== 'undefined') {
            analytics.logEvent('statistics_generated', {
                period: period,
                transactions_count: relevantTransactions.length
            });
        }
    } catch (error) {
        console.error('Analytics error:', error);
    }
}

// עדכון סיכומים
function updateStatisticsSummary(transactions, startDate, endDate) {
    // חישוב מספר החודשים בתקופה
    const monthsDiff = (
        (endDate.getFullYear() - startDate.getFullYear()) * 12 +
        endDate.getMonth() - startDate.getMonth() + 1
    );
    
    // חישוב סיכומים
    let totalIncome = 0;
    let totalExpenses = 0;
    
    transactions.forEach(transaction => {
        if (transaction.type === 'income') {
            totalIncome += transaction.amount;
        } else {
            totalExpenses += transaction.amount;
        }
    });
    
    const balance = totalIncome - totalExpenses;
    const monthlyAverage = monthsDiff > 0 ? (totalExpenses / monthsDiff) : totalExpenses;
    
    // עדכון האלמנטים
    document.getElementById('stats-income').textContent = `${totalIncome.toLocaleString()} ₪`;
    document.getElementById('stats-expenses').textContent = `${totalExpenses.toLocaleString()} ₪`;
    document.getElementById('stats-monthly-average').textContent = `${monthlyAverage.toLocaleString()} ₪`;
    
    const savingsElement = document.getElementById('stats-savings');
    savingsElement.textContent = `${balance.toLocaleString()} ₪`;
    if (balance >= 0) {
        savingsElement.className = 'balance-positive';
    } else {
        savingsElement.className = 'balance-negative';
    }
}

// יצירת גרף התפלגות הוצאות לפי קטגוריות
function createCategoryChart(transactions) {
    // סינון רק הוצאות
    const expenseTransactions = transactions.filter(t => t.type === 'expense');
    
    // חישוב סכומים לפי קטגוריות
    const categorySums = {};
    
    expenseTransactions.forEach(transaction => {
        const categoryId = parseInt(transaction.categoryId);
        const category = categories.find(c => c.id === categoryId);
        const categoryName = category ? category.name : 'לא מוגדרת';
        
        if (!categorySums[categoryName]) {
            categorySums[categoryName] = 0;
        }
        
        categorySums[categoryName] += transaction.amount;
    });
    
    // מיון לפי סכום בסדר יורד וחיתוך ל-10 הראשונות
    const sortedCategories = Object.entries(categorySums)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
    
    // חישוב סה"כ הוצאות
    const totalExpenses = expenseTransactions.reduce((sum, t) => sum + t.amount, 0);
    
    // הכנת נתונים לגרף
    const chartLabels = sortedCategories.map(c => c[0]);
    const chartData = sortedCategories.map(c => c[1]);
    const chartPercentages = sortedCategories.map(c => ((c[1] / totalExpenses) * 100).toFixed(1) + '%');
    
    // צבעים לגרף
    const backgroundColors = [
        '#4CAF50', '#2196F3', '#FF9800', '#F44336', '#9C27B0', 
        '#3F51B5', '#00BCD4', '#009688', '#8BC34A', '#FFC107'
    ];
    
    // הגדרת קנבס
    const ctx = document.getElementById('expenses-by-category-chart');
    if (!ctx) return;
    
    // ניקוי כל התוכן של המיכל
    ctx.innerHTML = '';
    
    // יצירת קנבס חדש
    const canvas = document.createElement('canvas');
    ctx.appendChild(canvas);
    
    // השמדת גרף קיים אם יש
    if (statisticsCharts.categoryChart) {
        statisticsCharts.categoryChart.destroy();
    }
    
    // יצירת גרף חדש
    statisticsCharts.categoryChart = new Chart(canvas, {
        type: 'doughnut',
        data: {
            labels: chartLabels,
            datasets: [{
                data: chartData,
                backgroundColor: backgroundColors,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    align: 'center',
                    rtl: true,
                    labels: {
                        font: {
                            family: 'Rubik, sans-serif',
                            size: 12
                        },
                        color: '#333333'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const label = context.label || '';
                            const percentage = chartPercentages[context.dataIndex];
                            return `${label}: ${value.toLocaleString()} ₪ (${percentage})`;
                        }
                    }
                }
            },
            cutout: '60%'
        }
    });
}

// יצירת גרף התפלגות הוצאות לפי אמצעי תשלום
function createPaymentMethodChart(transactions) {
    // סינון רק הוצאות
    const expenseTransactions = transactions.filter(t => t.type === 'expense');
    
    // חישוב סכומים לפי אמצעי תשלום
    let cashTotal = 0;
    let creditTotal = 0;
    
    expenseTransactions.forEach(transaction => {
        if (transaction.paymentMethod === 'cash') {
            cashTotal += transaction.amount;
        } else if (transaction.paymentMethod === 'credit') {
            creditTotal += transaction.amount;
        }
    });
    
    // הכנת נתונים לגרף
    const totalExpenses = cashTotal + creditTotal;
    const cashPercentage = totalExpenses > 0 ? ((cashTotal / totalExpenses) * 100).toFixed(1) : 0;
    const creditPercentage = totalExpenses > 0 ? ((creditTotal / totalExpenses) * 100).toFixed(1) : 0;
    
    // הגדרת קנבס
    const ctx = document.getElementById('expenses-by-payment-chart');
    if (!ctx) return;
    
    // ניקוי כל התוכן של המיכל
    ctx.innerHTML = '';
    
    // יצירת קנבס חדש
    const canvas = document.createElement('canvas');
    ctx.appendChild(canvas);
    
    // השמדת גרף קיים אם יש
    if (statisticsCharts.paymentChart) {
        statisticsCharts.paymentChart.destroy();
    }
    
    // יצירת גרף חדש
    statisticsCharts.paymentChart = new Chart(canvas, {
        type: 'pie',
        data: {
            labels: ['מזומן', 'אשראי'],
            datasets: [{
                data: [cashTotal, creditTotal],
                backgroundColor: ['#4CAF50', '#9C27B0'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    rtl: true,
                    labels: {
                        font: {
                            family: 'Rubik, sans-serif',
                            size: 12
                        },
                        color: '#333333'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const label = context.label || '';
                            const percentage = label === 'מזומן' ? cashPercentage : creditPercentage;
                            return `${label}: ${value.toLocaleString()} ₪ (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// יצירת גרף מגמות הוצאות והכנסות
function createIncomeExpensesTrendChart(transactions, startDate, endDate) {
    // מיון עסקאות לפי תאריך
    const sortedTransactions = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date));
    
    // ארגון הנתונים לפי חודשים
    const monthlyData = {};
    
    // חישוב מספר החודשים בטווח
    const months = [];
    const currentDate = new Date(startDate);
    while (currentDate <= endDate) {
        const monthKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
        months.push(monthKey);
        monthlyData[monthKey] = { income: 0, expenses: 0, balance: 0 };
        
        currentDate.setMonth(currentDate.getMonth() + 1);
    }
    
    // סיכום עסקאות לפי חודשים
    sortedTransactions.forEach(transaction => {
        const date = new Date(transaction.date);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        
        if (monthlyData[monthKey]) {
            if (transaction.type === 'income') {
                monthlyData[monthKey].income += transaction.amount;
            } else {
                monthlyData[monthKey].expenses += transaction.amount;
            }
            monthlyData[monthKey].balance = monthlyData[monthKey].income - monthlyData[monthKey].expenses;
        }
    });
    
    // הכנת נתונים לגרף
    const labels = months.map(month => {
        const [year, monthNum] = month.split('-');
        const date = new Date(parseInt(year), parseInt(monthNum) - 1, 1);
        
        const monthNames = [
            'ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני',
            'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'
        ];
        
        return `${monthNames[date.getMonth()]} ${year}`;
    });
    
    const incomeData = months.map(month => monthlyData[month].income);
    const expensesData = months.map(month => monthlyData[month].expenses);
    const balanceData = months.map(month => monthlyData[month].balance);
    
    // הגדרת קנבס
    const ctx = document.getElementById('income-expenses-trend-chart');
    if (!ctx) return;
    
    // ניקוי כל התוכן של המיכל
    ctx.innerHTML = '';
    
    // יצירת קנבס חדש
    const canvas = document.createElement('canvas');
    ctx.appendChild(canvas);
    
    // השמדת גרף קיים אם יש
    if (statisticsCharts.trendChart) {
        statisticsCharts.trendChart.destroy();
    }
    
    // יצירת גרף חדש
    statisticsCharts.trendChart = new Chart(canvas, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'הכנסות',
                    data: incomeData,
                    borderColor: '#4CAF50',
                    backgroundColor: 'rgba(76, 175, 80, 0.2)',
                    fill: false,
                    tension: 0.3,
                    borderWidth: 3,
                    pointBackgroundColor: '#4CAF50',
                    pointRadius: 4
                },
                {
                    label: 'הוצאות',
                    data: expensesData,
                    borderColor: '#F44336',
                    backgroundColor: 'rgba(244, 67, 54, 0.2)',
                    fill: false,
                    tension: 0.3,
                    borderWidth: 3,
                    pointBackgroundColor: '#F44336',
                    pointRadius: 4
                },
                {
                    label: 'מאזן',
                    data: balanceData,
                    borderColor: '#2196F3',
                    backgroundColor: 'rgba(33, 150, 243, 0.2)',
                    fill: false,
                    tension: 0.3,
                    borderWidth: 3,
                    pointBackgroundColor: '#2196F3',
                    pointRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    align: 'center',
                    rtl: true,
                    labels: {
                        font: {
                            family: 'Rubik, sans-serif',
                            size: 12
                        },
                        color: '#333333'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed.y;
                            const label = context.dataset.label || '';
                            return `${label}: ${value.toLocaleString()} ₪`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            family: 'Rubik, sans-serif'
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + ' ₪';
                        },
                        font: {
                            family: 'Rubik, sans-serif'
                        }
                    }
                }
            }
        }
    });
}// יצירת גרף התפלגות הוצאות חודשית
function createMonthlyExpensesChart(transactions) {
    // סינון רק הוצאות
    const expenseTransactions = transactions.filter(t => t.type === 'expense');
    
    // ארגון הנתונים לפי חודשים
    const monthlyExpensesByCategory = {};
    const categoryMap = {};
    
    // יצירת מיפוי של ID לשם קטגוריה
    categories.forEach(category => {
        categoryMap[category.id] = category.name;
    });
    
    // עיבוד העסקאות
    expenseTransactions.forEach(transaction => {
        const date = new Date(transaction.date);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        const categoryId = parseInt(transaction.categoryId);
        const categoryName = categoryMap[categoryId] || 'לא מוגדרת';
        
        if (!monthlyExpensesByCategory[monthKey]) {
            monthlyExpensesByCategory[monthKey] = {};
        }
        
        if (!monthlyExpensesByCategory[monthKey][categoryName]) {
            monthlyExpensesByCategory[monthKey][categoryName] = 0;
        }
        
        monthlyExpensesByCategory[monthKey][categoryName] += transaction.amount;
    });
    
    // מיון המפתחות לפי תאריך
    const sortedMonths = Object.keys(monthlyExpensesByCategory).sort();
    
    // מציאת כל הקטגוריות הייחודיות
    const uniqueCategories = new Set();
    Object.values(monthlyExpensesByCategory).forEach(monthData => {
        Object.keys(monthData).forEach(category => uniqueCategories.add(category));
    });
    const allCategories = Array.from(uniqueCategories).sort();
    
    // יצירת מערך הנתונים לגרף
    const labels = sortedMonths.map(month => {
        const [year, monthNum] = month.split('-');
        const monthNames = [
            'ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני',
            'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'
        ];
        return `${monthNames[parseInt(monthNum) - 1]} ${year}`;
    });
    
    // הכנת מערך צבעים עבור הקטגוריות
    const colorPalette = [
        '#4CAF50', '#2196F3', '#FF9800', '#F44336', '#9C27B0', 
        '#3F51B5', '#00BCD4', '#009688', '#8BC34A', '#FFC107',
        '#673AB7', '#E91E63', '#CDDC39', '#795548', '#607D8B'
    ];
    
    // יצירת מערכי נתונים לכל קטגוריה
    const datasets = allCategories.map((category, index) => {
        const color = colorPalette[index % colorPalette.length];
        
        return {
            label: category,
            data: sortedMonths.map(month => monthlyExpensesByCategory[month][category] || 0),
            backgroundColor: color,
            borderColor: color,
            borderWidth: 1
        };
    });
    
    // הגדרת קנבס
    const ctx = document.getElementById('monthly-expenses-chart');
    if (!ctx) return;
    
    // ניקוי כל התוכן של המיכל
    ctx.innerHTML = '';
    
    // יצירת קנבס חדש
    const canvas = document.createElement('canvas');
    ctx.appendChild(canvas);
    
    // השמדת גרף קיים אם יש
    if (statisticsCharts.monthlyChart) {
        statisticsCharts.monthlyChart.destroy();
    }
    
    // יצירת גרף חדש
    statisticsCharts.monthlyChart = new Chart(canvas, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    rtl: true,
                    labels: {
                        font: {
                            family: 'Rubik, sans-serif',
                            size: 12
                        },
                        color: '#333333'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed.y;
                            const label = context.dataset.label || '';
                            return `${label}: ${value.toLocaleString()} ₪`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    stacked: true,
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            family: 'Rubik, sans-serif'
                        }
                    }
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + ' ₪';
                        },
                        font: {
                            family: 'Rubik, sans-serif'
                        }
                    }
                }
            }
        }
    });
}// יצירת גרף הוצאות לפי ימי השבוע
function createDayOfWeekExpensesChart(transactions) {
    // סינון רק הוצאות
    const expenseTransactions = transactions.filter(t => t.type === 'expense');
    
    // חישוב הוצאות לפי יום בשבוע
    const daysOfWeek = [0, 1, 2, 3, 4, 5, 6]; // 0=ראשון, 1=שני וכו'
    const dayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
    
    // איתחול מערך סיכומים
    const daySums = Array(7).fill(0);
    const dayTransactionCounts = Array(7).fill(0);
    
    // סיכום הוצאות לפי יום
    expenseTransactions.forEach(transaction => {
        const date = new Date(transaction.date);
        const dayOfWeek = date.getDay(); // 0-6
        daySums[dayOfWeek] += transaction.amount;
        dayTransactionCounts[dayOfWeek]++;
    });
    
    // חישוב ממוצע יומי
    const dayAverages = daySums.map((sum, i) => 
        dayTransactionCounts[i] > 0 ? sum / dayTransactionCounts[i] : 0
    );
    
    // הגדרת קנבס
    const ctx = document.getElementById('expenses-by-day-chart');
    if (!ctx) return;
    
    // ניקוי כל התוכן של המיכל
    ctx.innerHTML = '';
    
    // יצירת קנבס חדש
    const canvas = document.createElement('canvas');
    ctx.appendChild(canvas);
    
    // השמדת גרף קיים אם יש
    if (statisticsCharts.dayChart) {
        statisticsCharts.dayChart.destroy();
    }
    
    // יצירת מערכים לגרף
    const totalData = daysOfWeek.map(day => daySums[day]);
    const countData = daysOfWeek.map(day => dayTransactionCounts[day]);
    const avgData = daysOfWeek.map(day => dayAverages[day]);
    
    // ייצור מספרים קריאים מעוגלים כלפי מעלה לתוויות
    const formattedAvgData = avgData.map(avg => 
        avg > 0 ? `${Math.ceil(avg).toLocaleString()} ₪` : '0 ₪'
    );
    
    // יצירת גרף חדש
    statisticsCharts.dayChart = new Chart(canvas, {
        type: 'bar',
        data: {
            labels: dayNames,
            datasets: [
                {
                    label: 'סה"כ הוצאות',
                    data: totalData,
                    backgroundColor: 'rgba(33, 150, 243, 0.7)',
                    borderColor: 'rgb(33, 150, 243)',
                    borderWidth: 1,
                    order: 2
                },
                {
                    label: 'הוצאה ממוצעת',
                    data: avgData,
                    backgroundColor: 'rgba(156, 39, 176, 0.7)',
                    borderColor: 'rgb(156, 39, 176)',
                    borderWidth: 1,
                    type: 'line',
                    order: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    rtl: true,
                    labels: {
                        font: {
                            family: 'Rubik, sans-serif'
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const datasetLabel = context.dataset.label;
                            const value = context.parsed.y;
                            const transactions = countData[context.dataIndex];
                            
                            if (datasetLabel === 'סה"כ הוצאות') {
                                return [`${datasetLabel}: ${value.toLocaleString()} ₪`, `מספר עסקאות: ${transactions}`];
                            } else {
                                return `${datasetLabel}: ${value.toLocaleString()} ₪`;
                            }
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            family: 'Rubik, sans-serif'
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + ' ₪';
                        },
                        font: {
                            family: 'Rubik, sans-serif'
                        }
                    }
                }
            }
        }
    });
}

// יצירת גרף השוואת הוצאות בין חודשים
function createMonthComparisonChart(transactions) {
    // סינון רק הוצאות
    const expenseTransactions = transactions.filter(t => t.type === 'expense');
    
    // ארגון הנתונים לפי חודשים
    const monthlyExpenses = {};
    
    // עיבוד העסקאות
    expenseTransactions.forEach(transaction => {
        const date = new Date(transaction.date);
        const month = date.getMonth(); // 0-11
        
        if (!monthlyExpenses[month]) {
            monthlyExpenses[month] = {
                total: 0,
                count: 0,
                year: date.getFullYear()
            };
        }
        
        monthlyExpenses[month].total += transaction.amount;
        monthlyExpenses[month].count++;
    });
    
    // שמות החודשים העבריים
    const monthNames = [
        'ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני',
        'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'
    ];
    
    // הכנת נתונים לגרף
    const labels = monthNames;
    const totals = Array(12).fill(0);
    
    // מילוי הנתונים
    Object.entries(monthlyExpenses).forEach(([month, data]) => {
        totals[month] = data.total;
    });
    
    // זיהוי החודש עם ההוצאות הכי גבוהות והכי נמוכות
    let maxMonth = 0;
    let minMonth = 0;
    for (let i = 0; i < 12; i++) {
        if (totals[i] > totals[maxMonth]) maxMonth = i;
        if (totals[i] > 0 && (totals[i] < totals[minMonth] || totals[minMonth] === 0)) minMonth = i;
    }
    
    // הגדרת קנבס
    const ctx = document.getElementById('month-comparison-chart');
    if (!ctx) return;
    
    // ניקוי כל התוכן של המיכל
    ctx.innerHTML = '';
    
    // יצירת קנבס חדש
    const canvas = document.createElement('canvas');
    ctx.appendChild(canvas);
    
    // השמדת גרף קיים אם יש
    if (statisticsCharts.comparisonChart) {
        statisticsCharts.comparisonChart.destroy();
    }
    
    // יצירת גרף חדש - גרף עמודות עם צבעים דינמיים
    statisticsCharts.comparisonChart = new Chart(canvas, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'הוצאות חודשיות',
                data: totals,
                backgroundColor: function(context) {
                    const index = context.dataIndex;
                    
                    if (index === maxMonth) return 'rgba(244, 67, 54, 0.7)'; // הכי גבוה - אדום
                    if (index === minMonth) return 'rgba(76, 175, 80, 0.7)'; // הכי נמוך - ירוק
                    return 'rgba(33, 150, 243, 0.7)'; // רגיל - כחול
                },
                borderColor: function(context) {
                    const index = context.dataIndex;
                    
                    if (index === maxMonth) return 'rgb(244, 67, 54)'; // הכי גבוה - אדום
                    if (index === minMonth) return 'rgb(76, 175, 80)'; // הכי נמוך - ירוק
                    return 'rgb(33, 150, 243)'; // רגיל - כחול
                },
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed.y;
                            
                            if (context.dataIndex === maxMonth) {
                                return [`הוצאות: ${value.toLocaleString()} ₪`, 'החודש עם ההוצאות הגבוהות ביותר'];
                            } else if (context.dataIndex === minMonth) {
                                return [`הוצאות: ${value.toLocaleString()} ₪`, 'החודש עם ההוצאות הנמוכות ביותר'];
                            } else {
                                return `הוצאות: ${value.toLocaleString()} ₪`;
                            }
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            family: 'Rubik, sans-serif'
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + ' ₪';
                        },
                        font: {
                            family: 'Rubik, sans-serif'
                        }
                    }
                }
            }
        }
    });
}// ניתוח תובנות אוטומטיות
function generateInsights(transactions, startDate, endDate) {
    const insightsContainer = document.getElementById('stats-insights');
    if (!insightsContainer) return;
    
    // ניקוי תכולה קודמת
    insightsContainer.innerHTML = '';
    
    // בדיקה אם אין נתונים
    if (transactions.length === 0) {
        const noDataMsg = document.createElement('div');
        noDataMsg.classList.add('insight-item', 'info');
        noDataMsg.innerHTML = '<h4>אין מספיק נתונים</h4><p>הוסף עסקאות כדי לקבל תובנות מפורטות על דפוסי ההוצאות וההכנסות שלך.</p>';
        insightsContainer.appendChild(noDataMsg);
        return;
    }
    
    // חישובים בסיסיים
    const expenses = transactions.filter(t => t.type === 'expense');
    const incomes = transactions.filter(t => t.type === 'income');
    
    const totalExpenses = expenses.reduce((sum, t) => sum + t.amount, 0);
    const totalIncomes = incomes.reduce((sum, t) => sum + t.amount, 0);
    const balance = totalIncomes - totalExpenses;
    
    // סיכום הוצאות לפי קטגוריות
    const expensesByCategory = {};
    expenses.forEach(transaction => {
        const categoryId = parseInt(transaction.categoryId);
        const category = categories.find(c => c.id === categoryId);
        const categoryName = category ? category.name : 'לא מוגדרת';
        
        if (!expensesByCategory[categoryName]) {
            expensesByCategory[categoryName] = 0;
        }
        
        expensesByCategory[categoryName] += transaction.amount;
    });
    
    // זיהוי קטגוריה עם הכי הרבה הוצאות
    const sortedCategories = Object.entries(expensesByCategory)
        .sort((a, b) => b[1] - a[1]);
    
    const topCategory = sortedCategories.length > 0 ? sortedCategories[0] : null;
    const topCategoryPercentage = topCategory ? (topCategory[1] / totalExpenses * 100).toFixed(1) : 0;
    
    // מציאת היום בשבוע עם הכי הרבה הוצאות
    const expensesByDay = Array(7).fill(0);
    const dayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
    
    expenses.forEach(transaction => {
        const date = new Date(transaction.date);
        const dayOfWeek = date.getDay(); // 0-6
        expensesByDay[dayOfWeek] += transaction.amount;
    });
    
    const maxDayIndex = expensesByDay.indexOf(Math.max(...expensesByDay));
    const maxDayName = dayNames[maxDayIndex];
    
    // מציאת ממוצע הוצאות חודשי
    const months = Math.max(1, Math.round((endDate - startDate) / (1000 * 60 * 60 * 24 * 30)));
    const monthlyExpenseAvg = totalExpenses / months;
    
    // מציאת מגמות - חישוב ההפרש לתקופה קודמת באותו אורך
    const midPoint = new Date((startDate.getTime() + endDate.getTime()) / 2);
    const firstPeriodTransactions = transactions.filter(t => new Date(t.date) < midPoint);
    const secondPeriodTransactions = transactions.filter(t => new Date(t.date) >= midPoint);
    
    const firstPeriodExpenses = firstPeriodTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
    const secondPeriodExpenses = secondPeriodTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
    
    const expenseTrend = secondPeriodExpenses - firstPeriodExpenses;
    const expenseTrendPercentage = firstPeriodExpenses > 0 ? (expenseTrend / firstPeriodExpenses * 100).toFixed(1) : 0;
    
    // יצירת תובנות
    const insights = [];
    
    // תובנת מאזן כללי
    if (balance >= 0) {
        insights.push({
            type: 'positive',
            title: 'מאזן חיובי',
            content: `ההכנסות שלך (${totalIncomes.toLocaleString()} ₪) גבוהות מההוצאות (${totalExpenses.toLocaleString()} ₪), כך שנשארת עם ${balance.toLocaleString()} ₪ בתקופה זו. המשך כך!`
        });
    } else {
        insights.push({
            type: 'alert',
            title: 'מאזן שלילי',
            content: `ההוצאות שלך (${totalExpenses.toLocaleString()} ₪) גבוהות מההכנסות (${totalIncomes.toLocaleString()} ₪) בתקופה זו, דבר שיצר גרעון של ${Math.abs(balance).toLocaleString()} ₪. כדאי לבדוק דרכים להגדיל הכנסות או להקטין הוצאות.`
        });
    }
    
    // תובנת קטגוריה מובילה
    if (topCategory) {
        insights.push({
            type: 'info',
            title: 'קטגוריית ההוצאות המובילה',
            content: `הקטגוריה "${topCategory[0]}" מהווה ${topCategoryPercentage}% מסך ההוצאות שלך, עם סכום של ${topCategory[1].toLocaleString()} ₪. חשוב על דרכים לצמצם הוצאות בקטגוריה זו אם תרצה לחסוך.`
        });
    }
    
    // תובנת יום בשבוע
    insights.push({
        type: 'info',
        title: 'היום עם ההוצאות הגבוהות ביותר',
        content: `יום ${maxDayName} הוא היום שבו אתה מוציא הכי הרבה כסף בשבוע, עם סך של ${expensesByDay[maxDayIndex].toLocaleString()} ₪. שים לב במיוחד להוצאות ביום זה.`
    });
    
    // תובנת מגמה
    if (Math.abs(expenseTrendPercentage) > 5) {
        if (expenseTrend > 0) {
            insights.push({
                type: 'warning',
                title: 'מגמת עלייה בהוצאות',
                content: `הוצאותיך עלו ב-${expenseTrendPercentage}% בהשוואה לתקופה הקודמת. כדאי לבדוק מה גרם לעלייה זו.`
            });
        } else {
            insights.push({
                type: 'positive',
                title: 'מגמת ירידה בהוצאות',
                content: `הוצאותיך ירדו ב-${Math.abs(expenseTrendPercentage)}% בהשוואה לתקופה הקודמת. המשך לשמור על הרגלי החיסכון שלך!`
            });
        }
    } else {
        insights.push({
            type: 'info',
            title: 'הוצאות יציבות',
            content: `הוצאותיך נשארו יציבות יחסית בהשוואה לתקופה הקודמת, עם שינוי של ${expenseTrendPercentage}%.`
        });
    }
    
    // תובנת הוצאה חודשית ממוצעת
    insights.push({
        type: 'info',
        title: 'הוצאה חודשית ממוצעת',
        content: `ההוצאה החודשית הממוצעת שלך היא ${monthlyExpenseAvg.toLocaleString()} ₪. חשוב להתאים את התקציב החודשי שלך בהתאם.`
    });
    
    // הוספת תובנות לדף
    insights.forEach(insight => {
        const insightElement = document.createElement('div');
        insightElement.classList.add('insight-item');
        
        if (insight.type === 'positive') {
            insightElement.classList.add('info'); // ירוק-כחול
        } else if (insight.type === 'warning') {
            insightElement.classList.add('warning'); // כתום
        } else if (insight.type === 'alert') {
            insightElement.classList.add('alert'); // אדום
        } else {
            insightElement.classList.add('info'); // כחול
        }
        
        insightElement.innerHTML = `<h4>${insight.title}</h4><p>${insight.content}</p>`;
        insightsContainer.appendChild(insightElement);
    });
}

// מאזינים לשינויים בבחירת תקופה
function setupStatisticsEventListeners() {
    const periodSelect = document.getElementById('stats-period');
    const customDateFields = document.querySelectorAll('.custom-date-range');
    
    if (periodSelect) {
        periodSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customDateFields.forEach(field => field.style.display = 'block');
            } else {
                customDateFields.forEach(field => field.style.display = 'none');
            }
        });
    }
    
    // הגדרת תאריכי ברירת מחדל לטווח המותאם אישית
    const today = new Date();
    const sixMonthsAgo = new Date();
    sixMonthsAgo.setMonth(today.getMonth() - 6);
    
    const startDateInput = document.getElementById('stats-start-date');
    const endDateInput = document.getElementById('stats-end-date');
    
    if (startDateInput) {
        startDateInput.value = sixMonthsAgo.toISOString().split('T')[0];
    }
    
    if (endDateInput) {
        endDateInput.value = today.toISOString().split('T')[0];
    }
    
    // מאזין לכפתור הפקת הסטטיסטיקות
    const generateButton = document.getElementById('generate-statistics');
    if (generateButton) {
        generateButton.addEventListener('click', generateStatistics);
    }
}

// ----- פונקציות דוחות וסיכומים -----

function generateReport() {
    const month = document.getElementById('report-month').value;
    const year = document.getElementById('report-year').value;
    
    // סינון העסקאות הרלוונטיות
    let filteredTransactions = [...transactions];
    
    if (month !== 'all') {
        filteredTransactions = filteredTransactions.filter(transaction => {
            const transactionDate = new Date(transaction.date);
            return transactionDate.getMonth() + 1 === parseInt(month);
        });
    }
    
    if (year !== 'all') {
        filteredTransactions = filteredTransactions.filter(transaction => {
            const transactionDate = new Date(transaction.date);
            return transactionDate.getFullYear() === parseInt(year);
        });
    }
    
    // חישוב סיכומים
    let totalIncome = 0;
    let totalExpenses = 0;
    let totalCash = 0;
    let totalCredit = 0;
    
    filteredTransactions.forEach(transaction => {
        if (transaction.type === 'income') {
            totalIncome += transaction.amount;
        } else {
            totalExpenses += transaction.amount;
            
            // סיכום לפי אמצעי תשלום
            if (transaction.paymentMethod === 'cash') {
                totalCash += transaction.amount;
            } else if (transaction.paymentMethod === 'credit') {
                totalCredit += transaction.amount;
            }
        }
    });
    
    const balance = totalIncome - totalExpenses;
    
    // עדכון סיכומים בתצוגה
    document.getElementById('report-income').textContent = `${totalIncome.toFixed(2)} ₪`;
    document.getElementById('report-expenses').textContent = `${totalExpenses.toFixed(2)} ₪`;
    document.getElementById('report-balance').textContent = `${balance.toFixed(2)} ₪`;
    
    // עדכון סיכומי אמצעי תשלום
    document.getElementById('report-cash-total').textContent = `${totalCash.toFixed(2)} ₪`;
    document.getElementById('report-credit-total').textContent = `${totalCredit.toFixed(2)} ₪`;
    
    if (balance >= 0) {
        document.getElementById('report-balance').className = 'balance-positive';
    } else {
        document.getElementById('report-balance').className = 'balance-negative';
    }
    
    // הצגת תשלומים עתידיים
    renderFuturePayments();
    
    // שליחת אירוע לאנליטיקס של Firebase
    try {
        if (typeof analytics !== 'undefined') {
            analytics.logEvent('report_generated', {
                month: month,
                year: year
            });
        }
    } catch (error) {
        console.error('Analytics error:', error);
    }
}

function renderFuturePayments() {
    const tableBody = document.getElementById('future-payments-body');
    if (!tableBody) return;
    
    tableBody.innerHTML = '';
    
    // מציאת תאריך הנוכחי
    const today = new Date();
    today.setHours(0, 0, 0, 0); // איפוס שעות כדי להשוות רק תאריכים
    
    // סינון עסקאות עתידיות בלבד
    const futureTransactions = transactions.filter(transaction => {
        const transactionDate = new Date(transaction.date);
        transactionDate.setHours(0, 0, 0, 0);
        return transactionDate > today;
    });
    
    // מיון לפי תאריך (מהקרוב לרחוק)
    futureTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    // הגבלה ל-10 התשלומים הקרובים ביותר
    const nextPayments = futureTransactions.slice(0, 10);
    
    // הצגת התשלומים העתידיים
    if (nextPayments.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = '<td colspan="6">אין תשלומים עתידיים.</td>';
        tableBody.appendChild(emptyRow);
    } else {
        nextPayments.forEach(payment => {
            const row = document.createElement('tr');
            
            // מציאת שם הקטגוריה
            const category = categories.find(c => c.id === parseInt(payment.categoryId)) || { name: 'לא מוגדרת' };
            
            // פורמט התאריך
            const date = new Date(payment.date);
            const formattedDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
            
            // טקסט אמצעי תשלום
            let paymentMethodText = '-';
            if (payment.type === 'expense') {
                if (payment.paymentMethod === 'cash') {
                    paymentMethodText = 'מזומן';
                } else if (payment.paymentMethod === 'credit') {
                    paymentMethodText = 'אשראי';
                }
            }
            
            // טקסט סוג עסקה
            let typeText = '';
            if (payment.isRecurring) {
                typeText = 'הוצאה קבועה';
            } else if (payment.installments) {
                typeText = `תשלום ${payment.installments.current}/${payment.installments.total}`;
            } else {
                typeText = payment.type === 'income' ? 'הכנסה' : 'הוצאה';
            }
            
            row.innerHTML = `
                <td>${formattedDate}</td>
                <td>${payment.description}</td>
                <td>${category.name}</td>
                <td>${payment.amount.toFixed(2)} ₪</td>
                <td>${paymentMethodText}</td>
                <td>${typeText}</td>
            `;
            
            tableBody.appendChild(row);
        });
    }
}// פונקציות ייצוא וייבוא נתונים

// פונקציה לייצוא כל הנתונים כקובץ JSON
function exportData() {
    // הכנת אובייקט עם כל הנתונים
    const exportData = {
        transactions: transactions,
        recurringExpenses: recurringExpenses,
        categories: categories,
        budgets: budgets,
        totalBudget: totalBudget,
        debts: debts,
        savings: savings,
        exportDate: new Date().toISOString(),
        version: '1.0'
    };
    
    // המרה ל-JSON
    const jsonData = JSON.stringify(exportData, null, 2);
    
    // יצירת קישור להורדה
    const blob = new Blob([jsonData], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    
    // הגדרת שם קובץ עם תאריך
    const now = new Date();
    const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    a.download = `finance-data-backup-${dateStr}.json`;
    
    // לחיצה אוטומטית על הקישור להתחלת ההורדה
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    // שליחת אירוע לאנליטיקס של Firebase
    try {
        if (typeof analytics !== 'undefined') {
            analytics.logEvent('data_exported');
        }
    } catch (error) {
        console.error('Analytics error:', error);
    }
}

// פונקציה לפתיחת דיאלוג ייבוא
function openImportDialog() {
    // יצירת אלמנט קלט קובץ זמני
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.json';
    
    // הוספת מאזין לשינוי בבחירת קובץ
    fileInput.addEventListener('change', function(event) {
        if (event.target.files.length > 0) {
            const file = event.target.files[0];
            
            // קריאת הקובץ
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // בדיקת תקינות הקובץ
                    if (!validateImportData(importedData)) {
                        alert('הקובץ אינו בפורמט תקין של נתוני מערכת זו.');
                        return;
                    }
                    
                    // בקשת אישור מהמשתמש
                    if (confirm('ייבוא הנתונים יחליף את כל הנתונים הקיימים במערכת. האם להמשיך?')) {
                        importData(importedData);
                    }
                } catch (error) {
                    console.error('Error parsing imported file:', error);
                    alert('שגיאה בפענוח הקובץ. ודא שהקובץ הוא בפורמט JSON תקין.');
                }
            };
            reader.readAsText(file);
        }
    });
    
    // לחיצה אוטומטית על אלמנט הקלט
    fileInput.click();
}

// בדיקת תקינות קובץ הייבוא
function validateImportData(data) {
    // בדיקה שיש את כל השדות הדרושים
    const requiredFields = ['transactions', 'recurringExpenses', 'categories', 'budgets', 'totalBudget'];
    
    for (const field of requiredFields) {
        if (!data.hasOwnProperty(field)) {
            console.error(`Missing required field: ${field}`);
            return false;
        }
    }
    
    // בדיקות נוספות יכולות להיות כאן, כגון בדיקת מבנה של כל אובייקט וכו'
    
    return true;
}

// ייבוא הנתונים למערכת
function importData(data) {
    try {
        showLoading('מייבא נתונים...');
        
        // העתקת הנתונים המיובאים למשתני המערכת
        transactions = data.transactions || [];
        recurringExpenses = data.recurringExpenses || [];
        categories = data.categories || [];
        budgets = data.budgets || [];
        totalBudget = data.totalBudget || { amount: 0, description: '' };
        
        // נתונים אופציונליים (יתכן שלא קיימים בקבצי גיבוי ישנים)
        debts = data.debts || [];
        savings = data.savings || [];
        
        // שמירת הנתונים
        saveData();
        
        // עדכון התצוגה
        renderTransactions();
        renderRecurringExpenses();
        renderCategories();
        renderBudgets();
        renderDebts();
        renderSavings();
        updateDebtPersonDropdowns();
        updateSavingSelects();
        populateCategoryDropdowns();
        
        hideLoading();
        alert('הנתונים יובאו בהצלחה!');
        
        // שליחת אירוע לאנליטיקס של Firebase
        try {
            if (typeof analytics !== 'undefined') {
                analytics.logEvent('data_imported', {
                    transactions_count: transactions.length,
                    categories_count: categories.length
                });
            }
        } catch (error) {
            console.error('Analytics error:', error);
        }
    } catch (error) {
        hideLoading();
        console.error('Error importing data:', error);
        alert('שגיאה בייבוא הנתונים: ' + error.message);
    }
}

// פונקציה למחיקת כל הנתונים
function clearAllData() {
    if (confirm('האם אתה בטוח שברצונך למחוק את כל הנתונים? לא ניתן לשחזר נתונים לאחר מחיקה.')) {
        if (confirm('האם אתה באמת בטוח? כדאי לייצא גיבוי לפני מחיקה.')) {
            // איפוס כל המשתנים
            transactions = [];
            recurringExpenses = [];
            categories = [
                { id: 1, name: "שכר", type: "income" },
                { id: 2, name: "מזון", type: "expense" },
                { id: 3, name: "תחבורה", type: "expense" },
                { id: 4, name: "דיור", type: "expense" },
                { id: 5, name: "בילויים", type: "expense" },
                { id: 6, name: "חשבונות", type: "expense" },
                { id: 7, name: "ביגוד", type: "expense" },
                { id: 8, name: "בריאות", type: "expense" },
                { id: 9, name: "חינוך", type: "expense" },
                { id: 10, name: "אחר", type: "both" }
            ];
            budgets = [];
            totalBudget = { amount: 0, description: '' };
            debts = [];
            savings = [];
            
            // שמירת הנתונים
            saveData();
            
            // עדכון התצוגה
            renderTransactions();
            renderRecurringExpenses();
            renderCategories();
            renderBudgets();
            renderDebts();
            renderSavings();
            updateDebtPersonDropdowns();
            updateSavingSelects();
            populateCategoryDropdowns();
            
            alert('כל הנתונים נמחקו בהצלחה.');
            
            // שליחת אירוע לאנליטיקס של Firebase
            try {
                if (typeof analytics !== 'undefined') {
                    analytics.logEvent('data_cleared');
                }
            } catch (error) {
                console.error('Analytics error:', error);
            }
        }
    }
}

// פונקציית שמירת נתונים - עם תמיכה בסנכרון Firebase, חובות וחסכונות
function saveData() {
    if (syncState.isLoggedIn) {
        // סימון שיש נתונים לשמירה
        syncState.pendingSave = true;
        
        // עדכון סטטוס סנכרון
        updateSyncStatus(false, 'ממתין לסנכרון...');
        
        // ניסיון מיידי לסנכרן, אם אפשר
        if (!syncState.isSyncing) {
            // טיימר קצר לתת לפעולות נוספות להסתיים
            setTimeout(() => saveAllDataToFirebase(), 1000);
        }
    }
    
    // שמירת הנתונים לאחסון מקומי (גיבוי)
    localStorage.setItem('budget-transactions', JSON.stringify(transactions));
    localStorage.setItem('budget-recurring', JSON.stringify(recurringExpenses));
    localStorage.setItem('budget-categories', JSON.stringify(categories));
    localStorage.setItem('budget-budgets', JSON.stringify(budgets));
    localStorage.setItem('budget-total-budget', JSON.stringify(totalBudget));
    localStorage.setItem('budget-debts', JSON.stringify(debts));
    localStorage.setItem('budget-savings', JSON.stringify(savings)); // חדש - שמירת חסכונות
    
    // שליחת אירוע לאנליטיקס של Firebase
    try {
        if (typeof analytics !== 'undefined') {
            analytics.logEvent('data_saved');
        }
    } catch (error) {
        console.error('Analytics error:', error);
    }
}

// פונקציית טעינת נתונים
function loadData() {
    if (syncState.isLoggedIn && !dataLoaded) {
        // טעינת נתונים מהענן אם המשתמש מחובר
        console.log('Loading data from Firebase...');
        loadAllDataFromFirebase()
            .catch(error => {
                console.error('Error loading data from Firebase, falling back to local storage:', error);
                loadFromLocalStorage();
            });
    } else if (!dataLoaded) {
        // טעינת נתונים מהאחסון המקומי אם המשתמש לא מחובר
        console.log('Loading data from local storage...');
        loadFromLocalStorage();
    }
}

// פונקציה לטעינה מאחסון מקומי
function loadFromLocalStorage() {
    const savedTransactions = localStorage.getItem('budget-transactions');
    const savedRecurring = localStorage.getItem('budget-recurring');
    const savedCategories = localStorage.getItem('budget-categories');
    const savedBudgets = localStorage.getItem('budget-budgets');
    const savedTotalBudget = localStorage.getItem('budget-total-budget');
    const savedDebts = localStorage.getItem('budget-debts');
    const savedSavings = localStorage.getItem('budget-savings'); // חדש - טעינת חסכונות
    
    if (savedTransactions) {
        transactions = JSON.parse(savedTransactions);
        
        // בדיקה ותיקון שדה אמצעי תשלום אם חסר - חדש
        transactions.forEach(transaction => {
            if (!transaction.paymentMethod && transaction.type === 'expense') {
                transaction.paymentMethod = 'cash'; // ברירת מחדל - מזומן
            }
        });
    }
    
    if (savedRecurring) {
        recurringExpenses = JSON.parse(savedRecurring);
        
        // בדיקה ותיקון שדה אמצעי תשלום אם חסר - חדש
        recurringExpenses.forEach(expense => {
            if (!expense.paymentMethod) {
                expense.paymentMethod = 'cash'; // ברירת מחדל - מזומן
            }
        });
    }
    
    if (savedCategories) {
        categories = JSON.parse(savedCategories);
    }
    
    if (savedBudgets) {
        budgets = JSON.parse(savedBudgets);
    }
    
    if (savedTotalBudget) {
        totalBudget = JSON.parse(savedTotalBudget);
    }
    
    if (savedDebts) {
        debts = JSON.parse(savedDebts);
    }
    
    if (savedSavings) { // חדש - טעינת חסכונות
        savings = JSON.parse(savedSavings);
    }
    
    populateCategoryDropdowns();
    renderTransactions();
    renderRecurringExpenses();
    renderCategories();
    renderBudgets();
    renderDebts();
    renderSavings(); // חדש - הצגת חסכונות
    updateDebtPersonDropdowns();
    updateSavingSelects(); // חדש - עדכון רשימות החסכונות
    generateRecurringTransactions();
    
    dataLoaded = true;
    
    // שליחת אירוע לאנליטיקס של Firebase
    try {
        if (typeof analytics !== 'undefined') {
            analytics.logEvent('data_loaded_from_local_storage');
        }
    } catch (error) {
        console.error('Analytics error:', error);
    }
}// אתחול המערכת
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM Content Loaded - initializing application");
    
    // הגדרת התאריך הנוכחי לשדות תאריך
    const today = new Date();
    const formattedDate = today.toISOString().split('T')[0];
    
    const transactionDateInput = document.getElementById('transaction-date');
    const recurringStartDateInput = document.getElementById('recurring-start-date');
    const firstPaymentDateInput = document.getElementById('first-payment-date');
    const debtDateInput = document.getElementById('debt-date');
    const updateDebtDateInput = document.getElementById('update-debt-date');
    const savingStartDateInput = document.getElementById('saving-start-date');
    const savingTransactionDateInput = document.getElementById('saving-transaction-date');
    
    if (transactionDateInput) transactionDateInput.value = formattedDate;
    if (recurringStartDateInput) recurringStartDateInput.value = formattedDate;
    if (firstPaymentDateInput) firstPaymentDateInput.value = formattedDate;
    if (debtDateInput) debtDateInput.value = formattedDate;
    if (updateDebtDateInput) updateDebtDateInput.value = formattedDate;
    if (savingStartDateInput) savingStartDateInput.value = formattedDate;
    if (savingTransactionDateInput) savingTransactionDateInput.value = formattedDate;
    
    // אתחול סלקטורים של שנים
    const currentYear = today.getFullYear();
    const yearSelects = document.querySelectorAll('#filter-year, #report-year, #budget-view-year');
    
    yearSelects.forEach(select => {
        if (!select) return;
        
        // ניקוי אפשרויות קיימות
        select.innerHTML = '';
        
        // הוספת אפשרות "הכל" לסלקטים מסוימים
        if (select.id === 'filter-year' || select.id === 'report-year') {
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'הכל';
            select.appendChild(allOption);
        }
        
        // הוספת שנים
        for (let i = currentYear - 5; i <= currentYear + 5; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            if (i === currentYear) {
                option.selected = true;
            }
            select.appendChild(option);
        }
    });
    
    // ניהול לשוניות אימות
    const authTabs = document.querySelectorAll('.auth-tab');
    authTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-auth-tab');
            
            // הסרת המחלקה 'active' מכל הלשוניות והתוכן
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-content').forEach(c => c.classList.remove('active'));
            
            // הוספת המחלקה 'active' ללשונית ולתוכן הנבחר
            this.classList.add('active');
            document.getElementById(targetTab + '-form').classList.add('active');
        });
    });
    
    // ניהול לשוניות המערכת
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');
            
            // הסרת המחלקה 'active' מכל הלשוניות והתוכן
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // הוספת המחלקה 'active' ללשונית ולתוכן הנבחר
            this.classList.add('active');
            document.getElementById(targetTab).classList.add('active');
            
            // שליחת אירוע לאנליטיקס של Firebase
            try {
                if (typeof analytics !== 'undefined') {
                    analytics.logEvent('tab_changed', {
                        tab_name: targetTab
                    });
                }
            } catch (error) {
                console.error('Analytics error:', error);
            }
        });
    });
    
    // מאזינים לאירועים - סוג עסקה ואמצעי תשלום
    const transactionTypeElement = document.getElementById('transaction-type');
    if (transactionTypeElement) {
        transactionTypeElement.addEventListener('change', function() {
            const installmentsSection = document.getElementById('installments-section');
            const paymentMethodSection = document.getElementById('payment-method-section'); // חדש
            
            if (this.value === 'expense') {
                installmentsSection.style.display = 'block';
                paymentMethodSection.style.display = 'block'; // חדש - הצגת בחירת אמצעי תשלום להוצאה
            } else {
                installmentsSection.style.display = 'none';
                paymentMethodSection.style.display = 'none'; // חדש - הסתרה לגבי הכנסה
                document.getElementById('is-installments').value = 'no';
                document.getElementById('installments-details').style.display = 'none';
            }
            
            // עדכון רשימת הקטגוריות לפי סוג העסקה
            populateCategoryDropdowns();
            
            // שליחת אירוע לאנליטיקס של Firebase
            try {
                if (typeof analytics !== 'undefined') {
                    analytics.logEvent('transaction_type_changed', {
                        new_type: this.value
                    });
                }
            } catch (error) {
                console.error('Analytics error:', error);
            }
        });
    }
    
    const isInstallmentsElement = document.getElementById('is-installments');
    if (isInstallmentsElement) {
        isInstallmentsElement.addEventListener('change', function() {
            const installmentsDetails = document.getElementById('installments-details');
            if (this.value === 'yes') {
                installmentsDetails.style.display = 'block';
                
                // שליחת אירוע לאנליטיקס של Firebase
                try {
                    if (typeof analytics !== 'undefined') {
                        analytics.logEvent('installments_enabled');
                    }
                } catch (error) {
                    console.error('Analytics error:', error);
                }
            } else {
                installmentsDetails.style.display = 'none';
            }
        });
    }
    
    const recurringEndTypeElement = document.getElementById('recurring-end-type');
    if (recurringEndTypeElement) {
        recurringEndTypeElement.addEventListener('change', function() {
            const endDateGroup = document.getElementById('recurring-end-date-group');
            const occurrencesGroup = document.getElementById('recurring-occurrences-group');
            
            endDateGroup.style.display = 'none';
            occurrencesGroup.style.display = 'none';
            
            if (this.value === 'date') {
                endDateGroup.style.display = 'block';
            } else if (this.value === 'occurrences') {
                occurrencesGroup.style.display = 'block';
            }
            
            // שליחת אירוע לאנליטיקס של Firebase
            try {
                if (typeof analytics !== 'undefined') {
                    analytics.logEvent('recurring_end_type_changed', {
                        end_type: this.value
                    });
                }
            } catch (error) {
                console.error('Analytics error:', error);
            }
        });
    }
    
    // הגדרת מאזינים לסטטיסטיקות
    setupStatisticsEventListeners();
    
    // מאזינים לכפתורים
    addEventListenerIfExists('add-transaction', 'click', addTransaction);
    addEventListenerIfExists('add-recurring', 'click', addRecurringExpense);
    addEventListenerIfExists('add-category', 'click', addCategory);
    addEventListenerIfExists('add-budget', 'click', addBudget);
    addEventListenerIfExists('add-total-budget', 'click', addTotalBudget);
    addEventListenerIfExists('generate-report', 'click', generateReport);
    addEventListenerIfExists('generate-statistics', 'click', generateStatistics);
    addEventListenerIfExists('print-report', 'click', function() {
        window.print();
        
        // שליחת אירוע לאנליטיקס של Firebase
        try {
            if (typeof analytics !== 'undefined') {
                analytics.logEvent('report_printed');
            }
        } catch (error) {
            console.error('Analytics error:', error);
        }
    });
    
    // מאזינים למערכת ניהול חובות
    setupDebtEventListeners();
    
    // מאזינים למערכת ניהול חסכונות (חדש)
    setupSavingEventListeners();
    
    // מאזינים לכפתורי אימות
    addEventListenerIfExists('login-button', 'click', loginUser);
    addEventListenerIfExists('register-button', 'click', registerUser);
    addEventListenerIfExists('logout-button', 'click', logoutUser);
    
    // מאזינים לשינויים בפילטרים
    const filterElements = document.querySelectorAll('#filter-month, #filter-year, #filter-type, #filter-category, #filter-payment-method');
    filterElements.forEach(filter => {
        if (filter) {
            filter.addEventListener('change', filterTransactions);
        }
    });
    
    // מאזינים לשינויים בפילטרים נוספים
    const categoryFilterElement = document.getElementById('category-filter');
    if (categoryFilterElement) {
        categoryFilterElement.addEventListener('change', filterCategories);
    }
    
    const budgetViewMonthElement = document.getElementById('budget-view-month');
    const budgetViewYearElement = document.getElementById('budget-view-year');
    
    if (budgetViewMonthElement && budgetViewYearElement) {
        budgetViewMonthElement.addEventListener('change', renderBudgets);
        budgetViewYearElement.addEventListener('change', renderBudgets);
        
        // הגדרת החודש הנוכחי לברירת מחדל
        budgetViewMonthElement.value = (today.getMonth() + 1).toString();
    }
    
    // מאזינים לכפתורי ייצוא/ייבוא נתונים
    addEventListenerIfExists('export-data', 'click', exportData);
    addEventListenerIfExists('import-data', 'click', openImportDialog);
    addEventListenerIfExists('clear-data', 'click', clearAllData);
    
    // פונקציה עזר להוספת Event Listener רק אם האלמנט קיים
    function addEventListenerIfExists(id, event, handler) {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener(event, handler);
        }
    }
    
    // בדיקה אם המשתמש כבר מחובר
    const currentUser = window.firebaseApp ? window.firebaseApp.getCurrentUser() : null;
    
    if (currentUser) {
        console.log("User already signed in:", currentUser.uid);
        syncState.isLoggedIn = true;
        syncState.userId = currentUser.uid;
        
        // עדכון התצוגה
        const userEmailElement = document.getElementById('user-email-display');
        if (userEmailElement) {
            userEmailElement.textContent = currentUser.email;
        }
        
        // טעינת נתונים מהענן
        loadAllDataFromFirebase()
            .catch(error => {
                console.error('Error loading data from Firebase during initial load:', error);
                // במקרה של שגיאה בטעינה הראשונית, ננסה להשתמש באחסון המקומי כגיבוי
                loadFromLocalStorage();
            });
        
        // מעבר למסך היישום
        showApp();
    } else {
        console.log("No user signed in - showing login screen");
        // טעינת נתונים מהאחסון המקומי כגיבוי
        loadData();
        
        // הצגת מסך ההתחברות
        showLoginScreen();
    }
    
    // שליחת אירוע לאנליטיקס של Firebase - אתחול המערכת
    try {
        if (typeof analytics !== 'undefined') {
            analytics.logEvent('app_initialized');
        }
    } catch (error) {
        console.error('Analytics error:', error);
    }
});

// האזנה לאירועי התחברות/ניתוק
document.addEventListener('userSignedIn', function(event) {
    const user = event.detail;
    console.log("User signed in event received:", user);
    syncState.isLoggedIn = true;
    syncState.userId = user.uid;
    
    // עדכון התצוגה
    document.getElementById('user-email-display').textContent = user.email;
    
    // טעינת נתונים מהענן
    loadAllDataFromFirebase();
    
    // מעבר למסך היישום
    showApp();
});

document.addEventListener('userSignedOut', function() {
    syncState.isLoggedIn = false;
    syncState.userId = null;
    dataLoaded = false;
    
    // מעבר למסך ההתחברות
    showLoginScreen();
});
    </script>
</body>
</html>





        
