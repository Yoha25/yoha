<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מעקב הוצאות והכנסות</title>
    
    <!-- ספריות Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #4285f4;
            --secondary-color: #34a853;
            --expense-color: #ea4335;
            --income-color: #34a853;
            --card-bg: #ffffff;
            --bg-color: #f5f5f5;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            direction: rtl;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            margin-bottom: 20px;
            text-align: center;
            border-radius: 8px;
        }
        
        h1, h2, h3 {
            margin: 0;
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .col {
            flex: 1;
            min-width: 250px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #3367d6;
        }
        
        .expense {
            color: var(--expense-color);
        }
        
        .income {
            color: var(--income-color);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f2f2f2;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            border-bottom: 2px solid var(--primary-color);
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .summary-box {
            text-align: center;
            padding: 20px;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        
        .summary-box.income {
            background-color: rgba(52, 168, 83, 0.1);
        }
        
        .summary-box.expense {
            background-color: rgba(234, 67, 53, 0.1);
        }
        
        .summary-box.balance {
            background-color: rgba(66, 133, 244, 0.1);
        }
        
        .summary-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .budget-progress {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            background-color: #f5f5f5;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
        }
        
        .progress-fill.warning {
            background-color: #FFC107;
        }
        
        .progress-fill.danger {
            background-color: var(--expense-color);
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            width: 100%;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .row {
                flex-direction: column;
            }
            
            .col {
                min-width: 100%;
            }
        }
    </style>
    
    <script>
        // תצורת Firebase - מההגדרות שקיבלת מהקונסול
        const firebaseConfig = {
            apiKey: "AIzaSyBo4--sl5AnDxlfNIThFyR3grEwf7nnI8M",
            authDomain: "yoha-c02a5.firebaseapp.com",
            projectId: "yoha-c02a5",
            storageBucket: "yoha-c02a5.firebasestorage.app",
            messagingSenderId: "993152300027",
            appId: "1:993152300027:web:dd926303f7616a2abb515e",
            measurementId: "G-FHWVEDSHSS"
        };

        // אתחול Firebase
        firebase.initializeApp(firebaseConfig);
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>מעקב הוצאות והכנסות</h1>
        </header>
        
        <!-- טופס התחברות/הרשמה לסנכרון -->
        <div class="card" id="auth-card">
            <h2>התחברות / הרשמה לסנכרון בין מכשירים</h2>
            <div class="form-group">
                <label for="email">כתובת אימייל</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="password">סיסמה</label>
                <input type="password" id="password" required>
            </div>
            <div class="row">
                <div class="col">
                    <button id="sign-in-btn" class="btn-secondary">התחבר</button>
                </div>
                <div class="col">
                    <button id="sign-up-btn" class="btn-secondary">הרשם</button>
                </div>
            </div>
            <div id="auth-status" style="margin-top: 10px; text-align: center;"></div>
        </div>
        
        <div class="card" id="user-info" style="display: none;">
            <div class="row">
                <div class="col">
                    <h3>משתמש מחובר: <span id="user-email"></span></h3>
                </div>
                <div class="col">
                    <button id="sign-out-btn" class="btn-secondary">התנתק</button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="row">
                <div class="col summary-box income">
                    <h3>הכנסות החודש</h3>
                    <div class="summary-value income" id="monthly-income">₪0</div>
                </div>
                <div class="col summary-box expense">
                    <h3>הוצאות החודש</h3>
                    <div class="summary-value expense" id="monthly-expenses">₪0</div>
                </div>
                <div class="col summary-box balance">
                    <h3>יתרה</h3>
                    <div class="summary-value" id="monthly-balance">₪0</div>
                </div>
            </div>
            <div class="row" style="margin-top: 10px;">
                <div class="col">
                    <button id="export-btn" class="btn-secondary">ייצוא נתונים</button>
                </div>
                <div class="col">
                    <button onclick="createSyncCode()" class="btn-secondary">יצירת קוד סנכרון</button>
                </div>
                <div class="col">
                    <button onclick="importSyncCode()" class="btn-secondary">ייבוא קוד סנכרון</button>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col">
                <div class="card">
                    <h2>הוסף הוצאה/הכנסה חדשה</h2>
                    <form id="transaction-form">
                        <div class="form-group">
                            <label for="transaction-type">סוג פעולה</label>
                            <select id="transaction-type" required>
                                <option value="expense">הוצאה</option>
                                <option value="income">הכנסה</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="transaction-amount">סכום</label>
                            <input type="number" id="transaction-amount" min="0" step="0.01" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="transaction-date">תאריך</label>
                            <input type="date" id="transaction-date" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="transaction-category">קטגוריה</label>
                            <select id="transaction-category" required>
                                <option value="">בחר קטגוריה</option>
                                <option value="food">מזון</option>
                                <option value="transportation">תחבורה</option>
                                <option value="housing">דיור</option>
                                <option value="utilities">חשבונות</option>
                                <option value="entertainment">בידור</option>
                                <option value="health">בריאות</option>
                                <option value="education">חינוך</option>
                                <option value="salary">משכורת</option>
                                <option value="gifts">מתנות</option>
                                <option value="other">אחר</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="transaction-description">תיאור</label>
                            <input type="text" id="transaction-description">
                        </div>
                        
                        <div class="form-group" id="recurring-options" style="display: none;">
                            <label for="is-recurring">תשלום קבוע?</label>
                            <input type="checkbox" id="is-recurring" style="width: auto;">
                            
                            <div id="recurring-details" style="display: none; margin-top: 10px; padding-right: 20px;">
                                <div class="form-group">
                                    <label for="recurring-end-date">תאריך סיום</label>
                                    <input type="date" id="recurring-end-date">
                                </div>
                                
                                <div class="form-group">
                                    <label for="recurring-count">מספר תשלומים</label>
                                    <input type="number" id="recurring-count" min="1">
                                </div>
                                
                                <div class="form-group">
                                    <label for="recurring-interval">תדירות</label>
                                    <select id="recurring-interval">
                                        <option value="monthly">חודשי</option>
                                        <option value="weekly">שבועי</option>
                                        <option value="yearly">שנתי</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit">הוסף</button>
                    </form>
                </div>
                
                <div class="card">
                    <h2>ניהול קטגוריות</h2>
                    <form id="category-form">
                        <div class="form-group">
                            <label for="new-category">הוסף קטגוריה חדשה</label>
                            <input type="text" id="new-category" required>
                        </div>
                        <button type="submit">הוסף קטגוריה</button>
                    </form>
                    
                    <div style="margin-top: 20px;">
                        <h3>קטגוריות קיימות</h3>
                        <ul id="categories-list"></ul>
                    </div>
                </div>
            </div>
            
            <div class="col">
                <div class="card">
                    <h2>ניהול תקציב</h2>
                    <form id="budget-form">
                        <div class="form-group">
                            <label for="budget-category">קטגוריה</label>
                            <select id="budget-category" required></select>
                        </div>
                        
                        <div class="form-group">
                            <label for="budget-amount">סכום חודשי</label>
                            <input type="number" id="budget-amount" min="0" step="0.01" required>
                        </div>
                        
                        <button type="submit">הגדר תקציב</button>
                    </form>
                    
                    <div style="margin-top: 20px;">
                        <h3>תקציבים וניצול תקציב</h3>
                        <div id="budgets-progress-list"></div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>גרף הוצאות לפי קטגוריה</h2>
                    <canvas id="expenses-chart" height="250"></canvas>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>תנועות אחרונות</h2>
            
            <div class="tabs">
                <div class="tab active" data-period="month">חודש נוכחי</div>
                <div class="tab" data-period="three-months">3 חודשים</div>
                <div class="tab" data-period="six-months">6 חודשים</div>
                <div class="tab" data-period="year">שנה</div>
                <div class="tab" data-period="all">הכל</div>
            </div>
            
            <div class="tab-content active" id="transactions-table-container">
                <table id="transactions-table">
                    <thead>
                        <tr>
                            <th>תאריך</th>
                            <th>סוג</th>
                            <th>סכום</th>
                            <th>קטגוריה</th>
                            <th>תיאור</th>
                            <th>פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-list"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script>
        // Data Storage
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let categories = JSON.parse(localStorage.getItem('categories')) || [
            'מזון', 'תחבורה', 'דיור', 'חשבונות', 'בידור', 'בריאות', 'חינוך', 'משכורת', 'מתנות', 'אחר'
        ];
        let budgets = JSON.parse(localStorage.getItem('budgets')) || {};
        
        // משתנים לניהול סנכרון
        let currentUser = null;
        let lastLocalUpdate = new Date();
        
        // פונקציות אימות משתמשים
        function signIn() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                updateAuthStatus('נא למלא את כל השדות', 'error');
                return;
            }
            
            updateAuthStatus('מתחבר...');
            
            firebase.auth().signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    updateAuthStatus('התחברת בהצלחה! טוען נתונים...', 'success');
                    loadUserData(currentUser.uid);
                })
                .catch((error) => {
                    console.error('שגיאת התחברות:', error);
                    updateAuthStatus('שגיאת התחברות: ' + error.message, 'error');
                });
        }
        
        function signUp() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                updateAuthStatus('נא למלא את כל השדות', 'error');
                return;
            }
            
            if (password.length < 6) {
                updateAuthStatus('הסיסמה חייבת להיות באורך 6 תווים לפחות', 'error');
                return;
            }
            
            updateAuthStatus('יוצר חשבון...');
            
            firebase.auth().createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    updateAuthStatus('החשבון נוצר בהצלחה!', 'success');
                    saveData(); // שמירת הנתונים הנוכחיים לחשבון החדש
                })
                .catch((error) => {
                    console.error('שגיאת הרשמה:', error);
                    updateAuthStatus('שגיאת הרשמה: ' + error.message, 'error');
                });
        }
        
        function signOut() {
            firebase.auth().signOut()
                .then(() => {
                    currentUser = null;
                    updateAuthStatus('התנתקת בהצלחה');
                    document.getElementById('auth-card').style.display = 'block';
                    document.getElementById('user-info').style.display = 'none';
                })
                .catch((error) => {
                    console.error('שגיאת התנתקות:', error);
                });
        }
        
        function updateAuthStatus(message, type = 'info') {
            const statusElement = document.getElementById('auth-status');
            statusElement.textContent = message;
            statusElement.className = type;
            
            if (type === 'success') {
                statusElement.style.color = 'green';
            } else if (type === 'error') {
                statusElement.style.color = 'red';
            } else {
                statusElement.style.color = 'blue';
            }
        }
        
        // פונקציות סנכרון נתונים
        function saveData() {
            if (!currentUser) {
                console.log('לא ניתן לשמור - אין משתמש מחובר');
                return;
            }
            
            lastLocalUpdate = new Date();
            
            const db = firebase.firestore();
            db.collection('users').doc(currentUser.uid).set({
                transactions: transactions,
                categories: categories,
                budgets: budgets,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                console.log('הנתונים נשמרו בהצלחה');
            })
            .catch((error) => {
                console.error('שגיאה בשמירת הנתונים:', error);
            });
        }
        
        function loadUserData(userId) {
            const db = firebase.firestore();
            
            db.collection('users').doc(userId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        transactions = data.transactions || [];
                        categories = data.categories || [];
                        budgets = data.budgets || {};
                        
                        // עדכון המידע המקומי
                        localStorage.setItem('transactions', JSON.stringify(transactions));
                        localStorage.setItem('categories', JSON.stringify(categories));
                        localStorage.setItem('budgets', JSON.stringify(budgets));
                        
                        // עדכון ממשק המשתמש
                        updateCategoriesUI();
                        updateBudgetsUI();
                        updateTransactionsTable('month');
                        updateSummary();
                        updateChart();
                        
                        // הצגת מידע המשתמש והסתרת טופס ההתחברות
                        document.getElementById('auth-card').style.display = 'none';
                        document.getElementById('user-info').style.display = 'block';
                        document.getElementById('user-email').textContent = currentUser.email;
                        
                        // הפעלת האזנה לשינויים
                        listenForChanges();
                        
                        console.log('הנתונים נטענו בהצלחה');
                        updateAuthStatus('הנתונים נטענו בהצלחה!', 'success');
                    } else {
                        console.log('אין נתונים קיימים למשתמש זה');
                        saveData(); // שמירת הנתונים הנוכחיים
                        
                        // הצגת מידע המשתמש והסתרת טופס ההתחברות
                        document.getElementById('auth-card').style.display = 'none';
                        document.getElementById('user-info').style.display = 'block';
                        document.getElementById('user-email').textContent = currentUser.email;
                    }
                })
                .catch((error) => {
                    console.error('שגיאה בטעינת הנתונים:', error);
                    updateAuthStatus('שגיאה בטעינת הנתונים: ' + error.message, 'error');
                });
        }
        
        function listenForChanges() {
            if (!currentUser) return;
            
            const db = firebase.firestore();
            
            db.collection('users').doc(currentUser.uid).onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    const serverTime = data.lastUpdated ? data.lastUpdated.toDate() : new Date(0);
                    
                    // שינויים מגיעים מהשרת רק אם הם חדשים יותר מהשינוי המקומי האחרון
                    if (serverTime > lastLocalUpdate) {
                        console.log('התקבלו נתונים חדשים מהשרת');
                        
                        transactions = data.transactions || [];
                        categories = data.categories || [];
                        budgets = data.budgets || {};
                        
                        // עדכון המידע המקומי
                        localStorage.setItem('transactions', JSON.stringify(transactions));
                        localStorage.setItem('categories', JSON.stringify(categories));
                        localStorage.setItem('budgets', JSON.stringify(budgets));
                        
                        // עדכון ממשק המשתמש
                        updateCategoriesUI();
                        updateBudgetsUI();
                        updateTransactionsTable('month');
                        updateSummary();
                        updateChart();
                    }
                }
            });
        }
        
        // Export data to CSV
        function exportData() {
            // Prepare data for export
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Add headers
            csvContent += "תאריך,סוג,סכום,קטגוריה,תיאור\n";
            
            // Add transactions
            transactions.forEach(t => {
                const row = [
                    t.date,
                    t.type === 'income' ? 'הכנסה' : 'הוצאה',
                    t.amount,
                    t.category,
                    t.description || ''
                ].join(',');
                
                csvContent += row + "\n";
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `הוצאות_והכנסות_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            
            // Trigger download
            link.click();
            document.body.removeChild(link);
        }
        
        // פונקציות ייצוא/ייבוא קוד סנכרון
        function createSyncCode() {
            // יצירת קוד סנכרון
            const syncData = {
                transactions: transactions,
                categories: categories,
                budgets: budgets,
                timestamp: new Date().toISOString()
            };
            
            const jsonData = JSON.stringify(syncData);
            const base64Data = btoa(jsonData);
            
            // הצגת חלון עם הקוד
            alert("העתק את הקוד הבא לשימוש במכשיר אחר:\n\n" + base64Data);
            
            // יצירת אלמנט input זמני להעתקה קלה
            const tempInput = document.createElement("textarea");
            tempInput.value = base64Data;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);
            
            alert("הקוד הועתק ללוח! כעת תוכל להדביק אותו במכשיר השני.");
        }
        
        function importSyncCode() {
            const syncCode = prompt("הדבק כאן את קוד הסנכרון מהמכשיר האחר:");
            
            if (!syncCode) return;
            
            try {
                // המרה מ-base64 ל-JSON
                const jsonData = atob(syncCode);
                const importedData = JSON.parse(jsonData);
                
                // בדיקת תקינות המבנה
                if (!importedData.transactions || !importedData.categories || !importedData.budgets) {
                    throw new Error("קוד סנכרון לא תקין");
                }
                
                // אישור הייבוא
                if (confirm("פעולה זו תחליף את כל הנתונים הקיימים. האם אתה בטוח?")) {
                    // החלפת הנתונים
                    transactions = importedData.transactions;
                    categories = importedData.categories;
                    budgets = importedData.budgets;
                    
                    // שמירה ב-localStorage
                    localStorage.setItem("transactions", JSON.stringify(transactions));
                    localStorage.setItem("categories", JSON.stringify(categories));
                    localStorage.setItem("budgets", JSON.stringify(budgets));
                    
                    // עדכון הממשק
                    updateCategoriesUI();
                    updateBudgetsUI();
                    updateTransactionsTable("month");
                    updateSummary();
                    updateChart();
                    
                    // שמירה ב-Firebase אם מחובר
                    if (currentUser) {
                        saveData();
                    }
                    
                    alert("הנתונים יובאו בהצלחה!");
                }
            } catch (error) {
                alert("שגיאה בייבוא הנתונים: " + error.message);
            }
        }
        
        // Function Declarations for Sync Code
        function createSyncCode() {
            // Prepare all data for sync
            const syncData = {
                transactions: transactions,
                categories: categories,
                budgets: budgets,
                timestamp: new Date().toISOString()
            };
            
            // Convert to JSON string and then to base64 for easier copying
            const jsonData = JSON.stringify(syncData);
            const base64Data = btoa(jsonData);
            
            // Create a modal dialog with the sync code
            const modalOverlay = document.createElement('div');
            modalOverlay.style.position = 'fixed';
            modalOverlay.style.top = '0';
            modalOverlay.style.left = '0';
            modalOverlay.style.width = '100%';
            modalOverlay.style.height = '100%';
            modalOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            modalOverlay.style.display = 'flex';
            modalOverlay.style.justifyContent = 'center';
            modalOverlay.style.alignItems = 'center';
            modalOverlay.style.zIndex = '1000';
            
            const modalContent = document.createElement('div');
            modalContent.style.backgroundColor = 'white';
            modalContent.style.padding = '20px';
            modalContent.style.borderRadius = '8px';
            modalContent.style.width = '90%';
            modalContent.style.maxWidth = '600px';
            modalContent.style.maxHeight = '80vh';
            modalContent.style.overflow = 'auto';
            modalContent.style.direction = 'rtl';
            
            const modalHeader = document.createElement('div');
            modalHeader.style.display = 'flex';
            modalHeader.style.justifyContent = 'space-between';
            modalHeader.style.alignItems = 'center';
            modalHeader.style.marginBottom = '15px';
            
            const modalTitle = document.createElement('h3');
            modalTitle.textContent = 'קוד סנכרון';
            modalTitle.style.margin = '0';
            
            const closeButton = document.createElement('button');
            closeButton.textContent = '×';
            closeButton.style.background = 'none';
            closeButton.style.border = 'none';
            closeButton.style.fontSize = '24px';
            closeButton.style.cursor = 'pointer';
            closeButton.onclick = function() {
                document.body.removeChild(modalOverlay);
            };
            
            modalHeader.appendChild(modalTitle);
            modalHeader.appendChild(closeButton);
            
            const instructions = document.createElement('p');
            instructions.textContent = 'העתק את הקוד הבא והעבר אותו למכשיר השני כדי לסנכרן את הנתונים. שים לב שייבוא הקוד יחליף את כל הנתונים הקיימים במכשיר השני.';
            
            const syncCodeArea = document.createElement('textarea');
            syncCodeArea.value = base64Data;
            syncCodeArea.style.width = '100%';
            syncCodeArea.style.height = '150px';
            syncCodeArea.style.padding = '10px';
            syncCodeArea.style.marginTop = '10px';
            syncCodeArea.style.marginBottom = '10px';
            syncCodeArea.style.resize = 'none';
            syncCodeArea.style.fontFamily = 'monospace';
            syncCodeArea.style.fontSize = '12px';
            
            const copyButton = document.createElement('button');
            copyButton.textContent = 'העתק קוד';
            copyButton.style.backgroundColor = 'var(--primary-color)';
            copyButton.style.color = 'white';
            copyButton.style.border = 'none';
            copyButton.style.padding = '10px 15px';
            copyButton.style.borderRadius = '4px';
            copyButton.style.cursor = 'pointer';
            copyButton.onclick = function() {
                syncCodeArea.select();
                document.execCommand('copy');
                copyButton.textContent = 'הועתק בהצלחה!';
                setTimeout(() => {
                    copyButton.textContent = 'העתק קוד';
                }, 2000);
            };
            
            // Assemble modal
            modalContent.appendChild(modalHeader);
            modalContent.appendChild(instructions);
            modalContent.appendChild(syncCodeArea);
            modalContent.appendChild(copyButton);
            modalOverlay.appendChild(modalContent);
            
            // Add to DOM
            document.body.appendChild(modalOverlay);
        }
        
        // Import data from sync code
        function importSyncCode() {
            // Create a modal dialog for code input
            const modalOverlay = document.createElement('div');
            modalOverlay.style.position = 'fixed';
            modalOverlay.style.top = '0';
            modalOverlay.style.left = '0';
            modalOverlay.style.width = '100%';
            modalOverlay.style.height = '100%';
            modalOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            modalOverlay.style.display = 'flex';
            modalOverlay.style.justifyContent = 'center';
            modalOverlay.style.alignItems = 'center';
            modalOverlay.style.zIndex = '1000';
            
            const modalContent = document.createElement('div');
            modalContent.style.backgroundColor = 'white';
            modalContent.style.padding = '20px';
            modalContent.style.borderRadius = '8px';
            modalContent.style.width = '90%';
            modalContent.style.maxWidth = '600px';
            modalContent.style.direction = 'rtl';
            
            const modalHeader = document.createElement('div');
            modalHeader.style.display = 'flex';
            modalHeader.style.justifyContent = 'space-between';
            modalHeader.style.alignItems = 'center';
            modalHeader.style.marginBottom = '15px';
            
            const modalTitle = document.createElement('h3');
            modalTitle.textContent = 'ייבוא קוד סנכרון';
            modalTitle.style.margin = '0';
            
            const closeButton = document.createElement('button');
            closeButton.textContent = '×';
            closeButton.style.background = 'none';
            closeButton.style.border = 'none';
            closeButton.style.fontSize = '24px';
            closeButton.style.cursor = 'pointer';
            closeButton.onclick = function() {
                document.body.removeChild(modalOverlay);
            };
            
            modalHeader.appendChild(modalTitle);
            modalHeader.appendChild(closeButton);
            
            const instructions = document.createElement('p');
            instructions.textContent = 'הדבק את קוד הסנכרון שקיבלת מהמכשיר השני. שים לב שפעולה זו תחליף את כל הנתונים הקיימים במכשיר הנוכחי.';
            
            const syncCodeArea = document.createElement('textarea');
            syncCodeArea.placeholder = 'הדבק כאן את קוד הסנכרון...';
            syncCodeArea.style.width = '100%';
            syncCodeArea.style.height = '150px';
            syncCodeArea.style.padding = '10px';
            syncCodeArea.style.marginTop = '10px';
            syncCodeArea.style.marginBottom = '10px';
            syncCodeArea.style.resize = 'none';
            
            const importButton = document.createElement('button');
            importButton.textContent = 'ייבא נתונים';
            importButton.style.backgroundColor = 'var(--primary-color)';
            importButton.style.color = 'white';
            importButton.style.border = 'none';
            importButton.style.padding = '10px 15px';
            importButton.style.borderRadius = '4px';
            importButton.style.cursor = 'pointer';
            importButton.onclick = function() {
                const syncCode = syncCodeArea.value.trim();
                if (!syncCode) {
                    alert('אנא הזן קוד סנכרון תקין.');
                    return;
                }
                
                try {
                    // Convert from base64 to JSON string and then parse
                    const jsonData = atob(syncCode);
                    const importedData = JSON.parse(jsonData);
                    
                    // Validate data structure
                    if (!importedData.transactions || !importedData.categories || !importedData.budgets) {
                        throw new Error('קוד סנכרון לא תקין.');
                    }
                    
                    // Confirm import
                    if (confirm('פעולה זו תחליף את כל הנתונים הקיימים. האם אתה בטוח שברצונך להמשיך?')) {
                        // Replace current data with imported data
                        transactions = importedData.transactions;
                        categories = importedData.categories;
                        budgets = importedData.budgets;
                        
                        // Save to localStorage
                        localStorage.setItem('transactions', JSON.stringify(transactions));
                        localStorage.setItem('categories', JSON.stringify(categories));
                        localStorage.setItem('budgets', JSON.stringify(budgets));
                        
                        // Update UI
                        updateCategoriesUI();
                        updateBudgetsUI();
                        updateTransactionsTable('month');
                        updateSummary();
                        updateChart();
                        
                        // Close modal and show success message
                        document.body.removeChild(modalOverlay);
                        alert('נתונים יובאו בהצלחה!');
                    }
                } catch (error) {
                    alert('שגיאה בייבוא הנתונים: ' + error.message);
                }
            };
            
            // Assemble modal
            modalContent.appendChild(modalHeader);
            modalContent.appendChild(instructions);
            modalContent.appendChild(syncCodeArea);
            modalContent.appendChild(importButton);
            modalOverlay.appendChild(modalContent);
            
            // Add to DOM
            document.body.appendChild(modalOverlay);
        }
        
        // Export data to CSV
        function exportData() {
            // Prepare data for export
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Add headers
            csvContent += "תאריך,סוג,סכום,קטגוריה,תיאור\n";
            
            // Add transactions
            transactions.forEach(t => {
                const row = [
                    t.date,
                    t.type === 'income' ? 'הכנסה' : 'הוצאה',
                    t.amount,
                    t.category,
                    t.description || ''
                ].join(',');
                
                csvContent += row + "\n";
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `הוצאות_והכנסות_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            
            // Trigger download
            link.click();
            document.body.removeChild(link);
        }
        
        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            // התחברות אוטומטית אם יש משתמש מחובר
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('auth-card').style.display = 'none';
                    document.getElementById('user-info').style.display = 'block';
                    document.getElementById('user-email').textContent = user.email;
                    loadUserData(user.uid);
                } else {
                    document.getElementById('auth-card').style.display = 'block';
                    document.getElementById('user-info').style.display = 'none';
                }
            });
            
            // הגדרת אירועים לכפתורי ההתחברות/הרשמה
            document.getElementById('sign-in-btn').addEventListener('click', function(e) {
                e.preventDefault();
                signIn();
            });
            
            document.getElementById('sign-up-btn').addEventListener('click', function(e) {
                e.preventDefault();
                signUp();
            });
            
            document.getElementById('sign-out-btn').addEventListener('click', function(e) {
                e.preventDefault();
                signOut();
            });

            // Set default date to today
            document.getElementById('transaction-date').valueAsDate = new Date();
            
            // Initialize categories
            updateCategoriesUI();
            
            // Initialize recurring checkbox event
            document.getElementById('is-recurring').addEventListener('change', function() {
                document.getElementById('recurring-details').style.display = this.checked ? 'block' : 'none';
            });
            
            // Show recurring options only for expenses
            document.getElementById('transaction-type').addEventListener('change', function() {
                document.getElementById('recurring-options').style.display = 
                    this.value === 'expense' ? 'block' : 'none';
            });
            
            // Initialize forms
            document.getElementById('transaction-form').addEventListener('submit', addTransaction);
            document.getElementById('category-form').addEventListener('submit', addCategory);
            document.getElementById('budget-form').addEventListener('submit', setBudget);
            
            // Initialize export button
            document.getElementById('export-btn').addEventListener('click', exportData);
            
            // Initialize tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update transactions table based on selected period
                    updateTransactionsTable(this.dataset.period);
                });
            });
            
            // Load data
            updateTransactionsTable('month');
            updateSummary();
            updateChart();
            updateBudgetsUI();
        });
        
        // Add Transaction
        function addTransaction(e) {
            e.preventDefault();
            
            const type = document.getElementById('transaction-type').value;
            const amount = parseFloat(document.getElementById('transaction-amount').value);
            const date = document.getElementById('transaction-date').value;
            const category = document.getElementById('transaction-category').value;
            const description = document.getElementById('transaction-description').value;
            
            const isRecurring = type === 'expense' && document.getElementById('is-recurring').checked;
            let recurring = null;
            
            if (isRecurring) {
                recurring = {
                    endDate: document.getElementById('recurring-end-date').value,
                    count: parseInt(document.getElementById('recurring-count').value || 0),
                    interval: document.getElementById('recurring-interval').value,
                    remainingPayments: parseInt(document.getElementById('recurring-count').value || 0)
                };
            }
            
            const transaction = {
                id: Date.now().toString(),
                type: type,
                amount: amount,
                date: date,
                category: category,
                description: description,
                recurring: recurring
            };
            
            transactions.push(transaction);
            saveTransactions();
            
            // Reset form
            document.getElementById('transaction-form').reset();
            document.getElementById('transaction-date').valueAsDate = new Date();
            document.getElementById('recurring-details').style.display = 'none';
            
            // Update UI
            updateTransactionsTable('month');
            updateSummary();
            updateChart();
            
            // שמירה ב-Firebase אם מחובר
            if (currentUser) {
                saveData();
            }
        }
        
        // Add Category
        function addCategory(e) {
            e.preventDefault();
            
            const categoryInput = document.getElementById('new-category');
            const category = categoryInput.value.trim();
            
            if (category && !categories.includes(category)) {
                categories.push(category);
                localStorage.setItem('categories', JSON.stringify(categories));
                
                updateCategoriesUI();
                categoryInput.value = '';
                
                // שמירה ב-Firebase אם מחובר
                if (currentUser) {
                    saveData();
                }
            }
        }
        
        // Set Budget
        function setBudget(e) {
            e.preventDefault();
            
            const category = document.getElementById('budget-category').value;
            const amount = parseFloat(document.getElementById('budget-amount').value);
            
            budgets[category] = amount;
            localStorage.setItem('budgets', JSON.stringify(budgets));
            
            updateBudgetsUI();
            document.getElementById('budget-form').reset();
            
            // שמירה ב-Firebase אם מחובר
            if (currentUser) {
                saveData();
            }
            
            // Show success message
            alert(`תקציב עבור ${category} הוגדר בהצלחה: ₪${amount.toFixed(2)}`);
        }
        
        // Update Categories UI
        function updateCategoriesUI() {
            // Update category selects
            const categorySelects = [
                document.getElementById('transaction-category'),
                document.getElementById('budget-category')
            ];
            
            categorySelects.forEach(select => {
                // Clear existing options
                const defaultOption = select.options[0];
                select.innerHTML = '';
                
                if (defaultOption) {
                    select.appendChild(defaultOption);
                }
                
                // Add categories
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    select.appendChild(option);
                });
            });
            
            // Update categories list
            const categoriesList = document.getElementById('categories-list');
            categoriesList.innerHTML = '';
            
            categories.forEach(category => {
                const li = document.createElement('li');
                li.textContent = category;
                categoriesList.appendChild(li);
            });
        }
        
        // Update Budgets UI with Progress Bars
        function updateBudgetsUI() {
            const budgetsList = document.getElementById('budgets-progress-list');
            budgetsList.innerHTML = '';
            
            // Get current month expenses by category
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            const monthlyExpenses = transactions.filter(transaction => {
                const transactionDate = new Date(transaction.date);
                return transaction.type === 'expense' &&
                       transactionDate.getMonth() === currentMonth && 
                       transactionDate.getFullYear() === currentYear;
            });
            
            // Group expenses by category
            const expensesByCategory = {};
            monthlyExpenses.forEach(transaction => {
                if (!expensesByCategory[transaction.category]) {
                    expensesByCategory[transaction.category] = 0;
                }
                expensesByCategory[transaction.category] += transaction.amount;
            });
            
            // Display budgets with progress bars
            Object.entries(budgets).forEach(([category, budgetAmount]) => {
                const spent = expensesByCategory[category] || 0;
                const remaining = budgetAmount - spent;
                const percentage = Math.min((spent / budgetAmount) * 100, 100);
                
                // Create budget item container
                const budgetItem = document.createElement('div');
                budgetItem.className = 'budget-progress';
                
                // Create header with category, spent and remaining
                const header = document.createElement('div');
                header.style.display = 'flex';
                header.style.justifyContent = 'space-between';
                
                const categorySpan = document.createElement('span');
                categorySpan.textContent = category;
                categorySpan.style.fontWeight = 'bold';
                
                const amountSpan = document.createElement('span');
                amountSpan.innerHTML = `<span class="expense">₪${spent.toFixed(2)}</span> / ₪${budgetAmount.toFixed(2)} <span style="color: ${remaining >= 0 ? 'green' : 'red'};">(נותר: ₪${remaining.toFixed(2)})</span>`;
                
                header.appendChild(categorySpan);
                header.appendChild(amountSpan);
                
                // Create progress bar
                const progressBar = document.createElement('div');
                progressBar.className = 'progress-bar';
                
                const progressFill = document.createElement('div');
                progressFill.className = 'progress-fill';
                if (percentage >= 90) {
                    progressFill.classList.add('danger');
                } else if (percentage >= 75) {
                    progressFill.classList.add('warning');
                }
                progressFill.style.width = `${percentage}%`;
                
                progressBar.appendChild(progressFill);
                
                // Add all elements to budget item
                budgetItem.appendChild(header);
                budgetItem.appendChild(progressBar);
                
                // Add to list
                budgetsList.appendChild(budgetItem);
            });
            
            // Show message if no budgets defined
            if (Object.keys(budgets).length === 0) {
                const noDataMsg = document.createElement('p');
                noDataMsg.textContent = 'לא הוגדרו תקציבים עדיין.';
                budgetsList.appendChild(noDataMsg);
            }
        }
        
        // Update Transactions Table
        function updateTransactionsTable(period) {
            const tbody = document.getElementById('transactions-list');
            tbody.innerHTML = '';
            
            // Filter transactions based on period
            const today = new Date();
            const filteredTransactions = transactions.filter(transaction => {
                const transactionDate = new Date(transaction.date);
                
                switch (period) {
                    case 'month':
                        return transactionDate.getMonth() === today.getMonth() && 
                               transactionDate.getFullYear() === today.getFullYear();
                    case 'three-months':
                        const threeMonthsAgo = new Date();
                        threeMonthsAgo.setMonth(today.getMonth() - 3);
                        return transactionDate >= threeMonthsAgo;
                    case 'six-months':
                        const sixMonthsAgo = new Date();
                        sixMonthsAgo.setMonth(today.getMonth() - 6);
                        return transactionDate >= sixMonthsAgo;
                    case 'year':
                        const oneYearAgo = new Date();
                        oneYearAgo.setFullYear(today.getFullYear() - 1);
                        return transactionDate >= oneYearAgo;
                    case 'all':
                        return true;
                    default:
                        return true;
                }
            });
            
            // Sort transactions by date (newest first)
            filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Add transactions to table
            filteredTransactions.forEach(transaction => {
                const tr = document.createElement('tr');
                
                // Format date
                const transactionDate = new Date(transaction.date);
                const formattedDate = `${transactionDate.getDate()}/${transactionDate.getMonth() + 1}/${transactionDate.getFullYear()}`;
                
                tr.innerHTML = `
                    <td>${formattedDate}</td>
                    <td class="${transaction.type}">${transaction.type === 'income' ? 'הכנסה' : 'הוצאה'}</td>
                    <td class="${transaction.type}">₪${transaction.amount.toFixed(2)}</td>
                    <td>${transaction.category}</td>
                    <td>${transaction.description || '-'}</td>
                    <td>
                        <button onclick="deleteTransaction('${transaction.id}')">מחק</button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }
        
        // Update Summary
        function updateSummary() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // Filter transactions for current month
            const monthlyTransactions = transactions.filter(transaction => {
                const transactionDate = new Date(transaction.date);
                return transactionDate.getMonth() === currentMonth && 
                       transactionDate.getFullYear() === currentYear;
            });
            
            // Calculate totals
            const income = monthlyTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const expenses = monthlyTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const balance = income - expenses;
            
            // Update UI
            document.getElementById('monthly-income').textContent = `₪${income.toFixed(2)}`;
            document.getElementById('monthly-expenses').textContent = `₪${expenses.toFixed(2)}`;
            
            const balanceElement = document.getElementById('monthly-balance');
            balanceElement.textContent = `₪${balance.toFixed(2)}`;
            balanceElement.className = balance >= 0 ? 'summary-value income' : 'summary-value expense';
            
            // Update budget progress bars
            updateBudgetsUI();
        }
        
        // Update Chart
        function updateChart() {
            const ctx = document.getElementById('expenses-chart').getContext('2d');
            
            // Get expenses by category for the current month
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            const monthlyExpenses = transactions.filter(transaction => {
                const transactionDate = new Date(transaction.date);
                return transaction.type === 'expense' &&
                       transactionDate.getMonth() === currentMonth && 
                       transactionDate.getFullYear() === currentYear;
            });
            
            // Group by category
            const expensesByCategory = {};
            
            monthlyExpenses.forEach(transaction => {
                if (!expensesByCategory[transaction.category]) {
                    expensesByCategory[transaction.category] = 0;
                }
                
                expensesByCategory[transaction.category] += transaction.amount;
            });
            
            // Prepare chart data
            const chartData = {
                labels: Object.keys(expensesByCategory),
                datasets: [{
                    label: 'הוצאות לפי קטגוריה',
                    data: Object.values(expensesByCategory),
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                        '#FF9F40', '#5AC8FA', '#FF8A80', '#AFB42B', '#7986CB'
                    ]
                }]
            };
            
            // Create chart
            if (window.expensesChart) {
                window.expensesChart.destroy();
            }
            
            window.expensesChart = new Chart(ctx, {
                type: 'pie',
                data: chartData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Delete Transaction
        function deleteTransaction(id) {
            transactions = transactions.filter(t => t.id !== id);
            saveTransactions();
            
            // Update UI
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                updateTransactionsTable(activeTab.dataset.period);
            } else {
                updateTransactionsTable('month');
            }
            
            updateSummary();
            updateChart();
            
            // שמירה ב-Firebase אם מחובר
            if (currentUser) {
                saveData();
            }
        }
        
        // Save Transactions
        function saveTransactions() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
        }
        

    </script>
</body>
</html>